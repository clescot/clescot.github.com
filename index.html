<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Le blog de Charles Lescot.</title>
  <meta name="author" content="Charles Lescot">
  
  <meta name="description" content="Blog sur Java, le web, et les méthodes agiles.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Le blog de Charles Lescot."/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Le blog de Charles Lescot." type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Le blog de Charles Lescot.</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-04-30T10:45:00.000Z"><a href="/2017/04/30/2017-04-30-deployer-un-cluster-swarm-mode-sur-scaleway-via-terraform/">30/04/17</a></time>
      
      
  
    <h1 class="title"><a href="/2017/04/30/2017-04-30-deployer-un-cluster-swarm-mode-sur-scaleway-via-terraform/">Déployer Un Cluster Docker Swarm Mode Sur Scaleway via Terraform</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="Contexte"><a href="#Contexte" class="headerlink" title="Contexte"></a>Contexte</h1><p>Je vous propose dans cette série d’articles, d’installer un cluster docker Swarm Mode via Terraform chez l’hébergeur Scaleway.</p>
<p>Celle-ci comprend 3 articles :</p>
<ul>
<li><a href="/2017/04/29/2017-04-28-interet-deploiement-cluster-swarm-mode-terraform/">l’intérêt de cette solution (ne contient pas d’éléments techniques)</a></li>
<li><a href="/2017/04/29/2017-04-29-generation-image-scaleway-terraform/">la génération de l’image des serveurs Scaleway à déployer</a></li>
<li><a href="/2017/04/29/2017-04-30-deployer-un-cluster-swarm-mode-sur-scaleway-via-terraform/">le déploiement via Terraform du cluster Docker Swarm Mode</a></li>
</ul>
<h1 id="Deploiement-via-Terraform-du-cluster-Docker-Swarm-Mode"><a href="#Deploiement-via-Terraform-du-cluster-Docker-Swarm-Mode" class="headerlink" title="Déploiement via Terraform du cluster Docker Swarm Mode"></a>Déploiement via Terraform du cluster Docker Swarm Mode</h1><h2 id="organisation-des-fichiers-terraform"><a href="#organisation-des-fichiers-terraform" class="headerlink" title="organisation des fichiers terraform"></a>organisation des fichiers terraform</h2><p>Les fichiers <a href="https://www.terraform.io" target="_blank" rel="external">terraform</a>, (qui regroupent les ressources de l’infrastructure voulue), sont les suivants :</p>
<h3 id="terraform-tf"><a href="#terraform-tf" class="headerlink" title="terraform.tf"></a>terraform.tf</h3><p>Il s’agit du fichier de configuration principal. Il décrit l’infrastructure voulue, sous forme de ressources.<br>Ces ressources sont fournies par des <a href="https://www.terraform.io/docs/providers/index.html" target="_blank" rel="external">providers</a>, et mis en place avec l’aide de <a href="https://www.terraform.io/docs/provisioners/index.html" target="_blank" rel="external">provisioners</a> afin de déployer des fichiers sur les serveurs, ou d’exécuter des commandes (locales au poste qui lance le déploiement ou distantes sur les serveurs cibles).</p>
<p>le fichier est organisé via les sections suivantes :</p>
<ul>
<li>définition des providers (ici scaleway et cloudflare)</li>
<li>définition de la ressource “<em>manager_init</em>“, qui correspond au premier serveur scaleway servant à initialiser le cluster swarm (un noeud <em>manager</em>) :<br>Ce premier serveur initiant le cluster est nécessaire ; il génère les tokens de sécurité pour les autres noeuds ayant le rôle de <em>manager</em> ou <em>worker</em>.</li>
</ul>
<p>La récupération des tokens de sécurité Docker Swarm mode se fait via des appels distants vers le premier Manager sur le port 2375.</p>
<p>Une solution plus sûre pourrait passer plutôt par l’écriture du token sur un fichier sur le premier serveur lors de sa génération, une récupération en locale, puis un upload en scp sur les serveurs nécessitant ces tokens lors de la connexion à ceux-ci juste après leur création via des <em>provisioners</em>  Terraform.</p>
<p>Veuillez noter aussi que le cluster Docker Swarm mode écoute sur le port 2375, qui n’est pas sécurisé. Une installation plus sûre utiliserait le port 2376 couplé à une authentification cliente par certificat SSL supportée nativement par le Docker Engine. Cette configuration dépasse largement le cadre de cet article.</p>
<ul>
<li>définition des autres <em>managers</em> du cluster :<br>il est recommandé, pour avoir un cluster robuste, d’avoir au moins 3 <em>managers</em> présents. Une plus grande robustesse aurait induit la répartition des noeuds sur plusieurs centres de données (Scaleway propose un centre de données français, et un centre de données néerlandais pour l’instant).</li>
<li>définition des <em>workers</em> du cluster</li>
<li>définition de l’IP statique de référence et association au serveur d’initialisation :</li>
</ul>
<p>Cela permet que le DNS pointe toujours vers une IP valide, même si le serveur associé change.<br>À noter qu’un problème persiste ici : lorsque le serveur tombe, il n’y a pas encore de mécanisme de rétro-contrôle qui associe l’IP avec un autre serveur en vie du cluster.</p>
<ul>
<li>ajout d’un sous-domaine wildcard (*) au DNS, pointant vers l’IP statique<br>Cela permet au cluster de gérer des sous-domaines de façon autonome, via <a href="http://traefik.io" target="_blank" rel="external">traefik</a> par exemple</li>
<li>définition des groupes de sécurité, avec leur règles associées :<br>Comm indiqué précédemment,  cela n’apporte qu’une sécurité limitée, au vu du fonctionnement des groupes de sécurité de Scaleway.</li>
</ul>
<p>Voici le contenu du fichier terraform.tf : </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div></pre></td><td class="code"><pre><div class="line">provider &quot;scaleway&quot; &#123;</div><div class="line">  organization = &quot;$&#123;var.scaleway_organization&#125;&quot;</div><div class="line">  token = &quot;$&#123;var.scaleway_token&#125;&quot;</div><div class="line">  region = &quot;$&#123;var.scaleway_region&#125;&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">provider &quot;cloudflare&quot; &#123;</div><div class="line">  email = &quot;$&#123;var.cloudflare_email&#125;&quot;</div><div class="line">  token = &quot;$&#123;var.cloudflare_token&#125;&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">resource &quot;scaleway_server&quot; &quot;manager_init&quot; &#123;</div><div class="line">  count = 1</div><div class="line">  name = &quot;swarm-manager-$&#123;count.index + 1&#125;&quot;</div><div class="line">  image = &quot;$&#123;var.ubuntu_x86_64_image&#125;&quot;</div><div class="line">  type = &quot;$&#123;var.scaleway_type&#125;&quot;</div><div class="line">  dynamic_ip_required = &quot;true&quot;</div><div class="line">  security_group=&quot;$&#123;scaleway_security_group.internal.id&#125;&quot;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  provisioner &quot;remote-exec&quot; &#123;</div><div class="line">      inline = [</div><div class="line">          &quot;mkdir -p /etc/systemd/system/docker.d&quot;,</div><div class="line">        &quot;mkdir -p /etc/docker&quot;]</div><div class="line">  &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  provisioner &quot;file&quot; &#123;</div><div class="line">    source = &quot;daemon_manager.tpl&quot;</div><div class="line">    destination = &quot;/etc/docker/daemon_manager.tpl&quot;</div><div class="line">  &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  provisioner &quot;remote-exec&quot; &#123;</div><div class="line">    inline = [</div><div class="line">      &quot;sed -e &apos;s/SWARM_MANAGER_PRIVATE_IP/$&#123;self.private_ip&#125;/g&apos; /etc/docker/daemon_manager.tpl &gt; /etc/docker/daemon.json&quot;,</div><div class="line">      &quot;systemctl daemon-reload&quot;,</div><div class="line">      &quot;systemctl restart docker&quot;,</div><div class="line">      &quot;docker swarm  init --advertise-addr $&#123;self.private_ip&#125; --listen-addr $&#123;self.private_ip&#125;:2377 &quot;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">resource &quot;scaleway_server&quot; &quot;manager_join&quot; &#123;</div><div class="line">  count = 2</div><div class="line">  name = &quot;swarm-manager-$&#123;count.index + 2&#125;&quot;</div><div class="line">  image = &quot;$&#123;var.ubuntu_x86_64_image&#125;&quot;</div><div class="line">  type = &quot;$&#123;var.scaleway_type&#125;&quot;</div><div class="line">  dynamic_ip_required = &quot;true&quot;</div><div class="line">  security_group=&quot;$&#123;scaleway_security_group.internal.id&#125;&quot;</div><div class="line"></div><div class="line">  provisioner &quot;remote-exec&quot; &#123;</div><div class="line">    inline = [</div><div class="line">      &quot;mkdir -p /etc/systemd/system/docker.d&quot;,</div><div class="line">      &quot;mkdir -p /etc/docker&quot;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line"></div><div class="line"></div><div class="line">  provisioner &quot;file&quot; &#123;</div><div class="line">    source = &quot;daemon_manager.tpl&quot;</div><div class="line">    destination = &quot;/etc/docker/daemon_manager.tpl&quot;</div><div class="line">  &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  provisioner &quot;remote-exec&quot; &#123;</div><div class="line">    inline = [</div><div class="line">      &quot;sed -e &apos;s/SWARM_MANAGER_PRIVATE_IP/$&#123;self.private_ip&#125;/g&apos; /etc/docker/daemon_manager.tpl &gt; /etc/docker/daemon.json&quot;,</div><div class="line">      &quot;systemctl daemon-reload&quot;,</div><div class="line">      &quot;systemctl restart docker&quot;,</div><div class="line">      &quot;docker swarm join  $&#123;scaleway_server.manager_init.0.private_ip&#125;:2377 --token $(docker -H $&#123;scaleway_server.manager_init.0.private_ip&#125;:2375 swarm join-token -q manager)&quot;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  depends_on = [</div><div class="line">    &quot;scaleway_server.manager_init&quot;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">resource &quot;scaleway_server&quot; &quot;worker&quot; &#123;</div><div class="line">  count = 2</div><div class="line">  name = &quot;swarm-worker-$&#123;count.index + 1&#125;&quot;</div><div class="line">  #Docker</div><div class="line">  image = &quot;$&#123;var.ubuntu_x86_64_image&#125;&quot;</div><div class="line">  type = &quot;$&#123;var.scaleway_type&#125;&quot;</div><div class="line">  dynamic_ip_required = &quot;true&quot;</div><div class="line">  security_group=&quot;$&#123;scaleway_security_group.internal.id&#125;&quot;</div><div class="line"></div><div class="line"></div><div class="line">  provisioner &quot;remote-exec&quot; &#123;</div><div class="line">    inline = [</div><div class="line">      &quot;mkdir -p /etc/systemd/system/docker.d&quot;,</div><div class="line">      &quot;mkdir -p /etc/docker&quot;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line"></div><div class="line"></div><div class="line">  provisioner &quot;file&quot; &#123;</div><div class="line">    source = &quot;daemon_worker.json&quot;</div><div class="line">    destination = &quot;/etc/docker/daemonjson&quot;</div><div class="line">  &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  #connection to the first manager to get the cluster token</div><div class="line">  provisioner &quot;remote-exec&quot; &#123;</div><div class="line">    inline = [</div><div class="line">      &quot;systemctl daemon-reload&quot;,</div><div class="line">      &quot;systemctl restart docker&quot;,</div><div class="line">      &quot;docker swarm join  $&#123;scaleway_server.manager_init.0.private_ip&#125;:2377 --token $(docker -H $&#123;scaleway_server.manager_init.0.private_ip&#125;:2375 swarm join-token -q worker)&quot;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  depends_on = [</div><div class="line">    &quot;scaleway_server.manager_init&quot;</div><div class="line">  ]</div><div class="line"></div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">resource &quot;scaleway_ip&quot; &quot;external_ip&quot; &#123;</div><div class="line">  server = &quot;$&#123;scaleway_server.manager_init.0.id&#125;&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"># Add a record to the domain</div><div class="line">resource &quot;cloudflare_record&quot; &quot;domain&quot; &#123;</div><div class="line">  domain = &quot;$&#123;var.cloudflare_domain&#125;&quot;</div><div class="line">  name = &quot;*&quot;</div><div class="line">  value = &quot;$&#123;scaleway_ip.external_ip.ip&#125;&quot;</div><div class="line">  type = &quot;A&quot;</div><div class="line">  ttl = 3600</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">resource &quot;scaleway_security_group&quot; &quot;internal&quot; &#123;</div><div class="line">  name = &quot;cluster_inside&quot;</div><div class="line">  description = &quot;security group to configure access from inside the cluster&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">#accept in</div><div class="line">variable &quot;input_ports_from_cluster&quot; &#123;</div><div class="line">  #TCP port 2377 for cluster management communications</div><div class="line">  #TCP and UDP port 7946 for communication among nodes</div><div class="line">  #TCP and UDP port 4789 for overlay network traffic</div><div class="line"></div><div class="line">  type = &quot;list&quot;</div><div class="line">  default = [2377,4789,7946]</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">resource &quot;scaleway_security_group_rule&quot; &quot;internal_in_accept_2375&quot; &#123;</div><div class="line">  security_group = &quot;$&#123;scaleway_security_group.internal.id&#125;&quot;</div><div class="line">  action = &quot;accept&quot;</div><div class="line">  direction = &quot;inbound&quot;</div><div class="line">  ip_range = &quot;10.0.0.0/8&quot;</div><div class="line">  protocol = &quot;TCP&quot;</div><div class="line">  port = &quot;2375&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">resource &quot;scaleway_security_group_rule&quot; &quot;internal_in_accept_2376&quot; &#123;</div><div class="line">  security_group = &quot;$&#123;scaleway_security_group.internal.id&#125;&quot;</div><div class="line">  action = &quot;accept&quot;</div><div class="line">  direction = &quot;inbound&quot;</div><div class="line">  ip_range = &quot;10.0.0.0/8&quot;</div><div class="line">  protocol = &quot;TCP&quot;</div><div class="line">  port = &quot;2376&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">#TCP port 2377 for cluster management communications</div><div class="line">resource &quot;scaleway_security_group_rule&quot; &quot;internal_in_accept_2377&quot; &#123;</div><div class="line">  security_group = &quot;$&#123;scaleway_security_group.internal.id&#125;&quot;</div><div class="line">  action = &quot;accept&quot;</div><div class="line">  direction = &quot;inbound&quot;</div><div class="line">  ip_range = &quot;10.0.0.0/8&quot;</div><div class="line">  protocol = &quot;TCP&quot;</div><div class="line">  port = &quot;2377&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line">#TCP and UDP port 4789 for overlay network traffic</div><div class="line">resource &quot;scaleway_security_group_rule&quot; &quot;internal_in_accept_overlay_tcp&quot; &#123;</div><div class="line">  security_group = &quot;$&#123;scaleway_security_group.internal.id&#125;&quot;</div><div class="line">  action = &quot;accept&quot;</div><div class="line">  direction = &quot;inbound&quot;</div><div class="line">  ip_range = &quot;10.0.0.0/8&quot;</div><div class="line">  protocol = &quot;TCP&quot;</div><div class="line">  port = &quot;4789&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">#TCP and UDP port 4789 for overlay network traffic</div><div class="line">resource &quot;scaleway_security_group_rule&quot; &quot;internal_in_accept_overlay_udp&quot; &#123;</div><div class="line">  security_group = &quot;$&#123;scaleway_security_group.internal.id&#125;&quot;</div><div class="line">  action = &quot;accept&quot;</div><div class="line">  direction = &quot;inbound&quot;</div><div class="line">  ip_range = &quot;10.0.0.0/8&quot;</div><div class="line">  protocol = &quot;UDP&quot;</div><div class="line">  port = &quot;4789&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">#TCP and UDP port 7946 for communication among nodes</div><div class="line">resource &quot;scaleway_security_group_rule&quot; &quot;internal_in_accept_inter_nodes_tcp&quot; &#123;</div><div class="line">  security_group = &quot;$&#123;scaleway_security_group.internal.id&#125;&quot;</div><div class="line">  action = &quot;accept&quot;</div><div class="line">  direction = &quot;inbound&quot;</div><div class="line">  ip_range = &quot;10.0.0.0/8&quot;</div><div class="line">  protocol = &quot;TCP&quot;</div><div class="line">  port = &quot;7946&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">resource &quot;scaleway_security_group_rule&quot; &quot;internal_in_accept_inter_nodes_udp&quot; &#123;</div><div class="line">  security_group = &quot;$&#123;scaleway_security_group.internal.id&#125;&quot;</div><div class="line">  action = &quot;accept&quot;</div><div class="line">  direction = &quot;inbound&quot;</div><div class="line">  ip_range = &quot;10.0.0.0/8&quot;</div><div class="line">  protocol = &quot;UDP&quot;</div><div class="line">  port = &quot;7946&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">#If you are planning on creating an overlay network with encryption (--opt encrypted),</div><div class="line">#you will also need to ensure protocol 50 (ESP) is open.</div><div class="line">resource &quot;scaleway_security_group_rule&quot; &quot;internal_in_accept_esp_encryption&quot; &#123;</div><div class="line">  security_group = &quot;$&#123;scaleway_security_group.internal.id&#125;&quot;</div><div class="line">  action = &quot;accept&quot;</div><div class="line">  direction = &quot;inbound&quot;</div><div class="line">  ip_range = &quot;10.0.0.0/8&quot;</div><div class="line">  protocol = &quot;TCP&quot;</div><div class="line">  port = &quot;50&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">resource &quot;scaleway_security_group&quot; &quot;external&quot; &#123;</div><div class="line">  name = &quot;cluster_outside&quot;</div><div class="line">  description = &quot;security group to configure access from outside the cluster&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line">variable &quot;input_ports_from_external&quot; &#123;</div><div class="line">  #If you are planning on creating an overlay network with encryption (--opt encrypted),</div><div class="line">  #you will also need to ensure protocol 50 (ESP) is open.</div><div class="line">  type = &quot;list&quot;</div><div class="line">  default = [80,443,22]</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">resource &quot;scaleway_security_group_rule&quot; &quot;external_in_accept&quot; &#123;</div><div class="line">  security_group = &quot;$&#123;scaleway_security_group.external.id&#125;&quot;</div><div class="line"></div><div class="line">  action = &quot;accept&quot;</div><div class="line">  direction = &quot;inbound&quot;</div><div class="line">  ip_range = &quot;0.0.0.0/0&quot;</div><div class="line">  protocol = &quot;TCP&quot;</div><div class="line">  port = &quot;$&#123;element(var.input_ports_from_external, count.index)&#125;&quot;</div><div class="line">  count = &quot;$&#123;length(var.input_ports_from_external)&#125;&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">#drop in</div><div class="line">resource &quot;scaleway_security_group_rule&quot; &quot;any_in_drop&quot; &#123;</div><div class="line">  security_group = &quot;$&#123;scaleway_security_group.external.id&#125;&quot;</div><div class="line"></div><div class="line">  action = &quot;drop&quot;</div><div class="line">  direction = &quot;inbound&quot;</div><div class="line">  ip_range = &quot;0.0.0.0/0&quot;</div><div class="line">  protocol = &quot;TCP&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="daemon-manager-tpl"><a href="#daemon-manager-tpl" class="headerlink" title="daemon_manager.tpl"></a>daemon_manager.tpl</h3><p>Ce fichier est un template pour configurer le démon docker des noeuds <em>manager</em> du cluster. la variable <code>SWARM_MANAGER_PRIVATE_IP</code> sera remplacée au démarrage pour l’adresse IP de l’interface réseau <strong>privée</strong> du serveur.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line"><span class="attr">"experimental"</span> : <span class="literal">true</span>,</div><div class="line"><span class="attr">"storage-driver"</span> : <span class="string">"overlay2"</span>,</div><div class="line"><span class="attr">"labels"</span> : [<span class="string">"provider=scaleway"</span>],</div><div class="line"><span class="attr">"mtu"</span>: <span class="number">1500</span>,</div><div class="line"><span class="attr">"hosts"</span>: [<span class="string">"unix:///var/run/docker.sock"</span>,<span class="string">"tcp://SWARM_MANAGER_PRIVATE_IP:2375"</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="daemon-worker-json"><a href="#daemon-worker-json" class="headerlink" title="daemon_worker.json"></a>daemon_worker.json</h3><p>Ce fichier permet de configurer le démon des noeuds <em>worker</em> du cluster Docker Swarm mode. Il ne contient pas l’adresse IP<br> de l’interface réseau privée du serveur, car les noeuds <em>worker</em> ne peuvent piloter le cluster (sauf si on les transforme en manager).</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line"><span class="attr">"experimental"</span> : <span class="literal">true</span>,</div><div class="line"><span class="attr">"storage-driver"</span> : <span class="string">"overlay2"</span>,</div><div class="line"><span class="attr">"labels"</span> : [<span class="string">"provider=scaleway"</span>],</div><div class="line"><span class="attr">"mtu"</span>: <span class="number">1500</span>,</div><div class="line"><span class="attr">"hosts"</span>: [<span class="string">"unix:///var/run/docker.sock"</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="variables-tf"><a href="#variables-tf" class="headerlink" title="variables.tf"></a>variables.tf</h3><p>Le fichier <code>terraform.tf</code>, fait référence à des variables. Celles-ci sont décrites dans le fichier <code>variables.tf</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">variable &quot;scaleway_organization&quot; &#123;</div><div class="line">  description = &quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;</div><div class="line">&#125;</div><div class="line">variable &quot;scaleway_token&quot; &#123;</div><div class="line">  description = &quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;</div><div class="line">&#125;</div><div class="line">variable &quot;scaleway_region&quot; &#123;</div><div class="line">  description = &quot;scaleway datacenter &apos;par1&apos; for paris(France) or &apos;ams1&apos; fr Amsterdam (Nederlands)&quot;</div><div class="line">  default=&quot;par1&quot;</div><div class="line">&#125;</div><div class="line">variable &quot;scaleway_type&quot; &#123;</div><div class="line">  description = &quot;type of server&quot;</div><div class="line">  default=&quot;C2S&quot;</div><div class="line">&#125;</div><div class="line">variable &quot;cloudflare_email&quot; &#123;</div><div class="line">  description = &quot;your email scaleway account identifier&quot;</div><div class="line">&#125;</div><div class="line">variable &quot;cloudflare_token&quot; &#123;</div><div class="line">  description = &quot;&quot;</div><div class="line">&#125;</div><div class="line">variable &quot;cloudflare_domain&quot; &#123;</div><div class="line">  description = &quot;your DNS domain managed by cloudflare&quot;</div><div class="line">&#125;</div><div class="line">variable &quot;ubuntu_x86_64_image&quot; &#123;</div><div class="line">  description = &quot;your custom image ID&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="terraform-tfvars"><a href="#terraform-tfvars" class="headerlink" title="terraform.tfvars"></a>terraform.tfvars</h3><p>Ce fichier contient les valeurs des variables référencées dans le fichier <code>terraform.tf</code>, et définies dans le fichier <code>variables.tf</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">scaleway_organization = &quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;</div><div class="line">scaleway_token = &quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;</div><div class="line">scaleway_region = &quot;par1&quot;</div><div class="line">scaleway_type = &quot;C2S&quot;</div><div class="line">cloudflare_email = &quot;myname@email.com&quot;</div><div class="line">cloudflare_token = &quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</div><div class="line">cloudflare_domain = &quot;mondomaine.com&quot;</div><div class="line">ubuntu_x86_64_image = &quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;</div></pre></td></tr></table></figure>
<h3 id="terraform-tfstate"><a href="#terraform-tfstate" class="headerlink" title="terraform.tfstate"></a>terraform.tfstate</h3><p>Ce fichier est généré par Terraform, et contient l’état de l’infrastructure après application des changements.</p>
<h3 id="declenchement-de-Terraform"><a href="#declenchement-de-Terraform" class="headerlink" title="déclenchement de Terraform"></a>déclenchement de Terraform</h3><ul>
<li>créer un plan d’exécution</li>
</ul>
<p>l’exécution de la commande <code>terraform plan</code>, permet d’inspecter l’infrastructure actuelle, et l’infrastructure cible,<br>afin de générer un plan d’exécution des changements nécessaires.</p>
<ul>
<li>créer l’infrastructure</li>
</ul>
<p>Cette création se fait via la commande :<br><code>terraform apply</code></p>
<ul>
<li>détruire l’infrastructure</li>
</ul>
<p>La destruction se fait via la commande <code>terraform destroy</code> (après confirmation via l’invite de commandes).</p>
<h1 id="resultat"><a href="#resultat" class="headerlink" title="résultat"></a>résultat</h1><p>Après avoir crée via <code>terraform apply</code>, votre infrastructure (et patienté quelques minutes), en se connectant sur un des noeuds ayant le rôle de manager, vous pouvez lancer la commande suivante :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">root@swarm-manager-1:~# docker node ls</div><div class="line">ID                           HOSTNAME         STATUS  AVAILABILITY  MANAGER STATUS</div><div class="line">b37dxtsbn573m4xhas0j7b4do *  swarm-manager-1  Ready   Active        Leader</div><div class="line">cvv0iyfy7tybsev0k55iyif4i    swarm-manager-2  Ready   Active        Reachable</div><div class="line">llrhva62q0byzhruu6lu29gyx    swarm-worker-2   Ready   Active        </div><div class="line">p4mcus11v15can4ut0lqajfqd    swarm-worker-1   Ready   Active        </div><div class="line">pi2wxsmibs64y9d4xwnuxvew8    swarm-manager-3  Ready   Active        Reachable</div></pre></td></tr></table></figure>
<p>Vous pouvez donc constater la bonne mise en place de votre cluster Docker Swarm Mode.</p>
<h1 id="conclusion"><a href="#conclusion" class="headerlink" title="conclusion"></a>conclusion</h1><p>Cet article vous permet de vous familiariser avec Terraform, un outil de plus en plus présent pour automatiser la création de vos infrastructures immutables via du code.<br>Il vous permet aussi de vous essayer à la création d’un cluster Docker Swarm Mode.<br>J’attire néanmoins votre attention sur la non-sécurisation de l’image et du réseau mis en place.</p>
<p>Une mise en production d’un environnement de ce type, demanderait au préalable, d’autres opérations de sécurisation qui sortent du cadre de cet article.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-04-29T10:45:00.000Z"><a href="/2017/04/29/2017-04-29-generation-image-scaleway-terraform/">29/04/17</a></time>
      
      
  
    <h1 class="title"><a href="/2017/04/29/2017-04-29-generation-image-scaleway-terraform/">Génération D&#39;une Image Scaleway en Vue D&#39;un Déploiement Terraform</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="Contexte"><a href="#Contexte" class="headerlink" title="Contexte"></a>Contexte</h1><p>Je vous propose dans cette série d’articles, d’installer un cluster docker Swarm Mode via Terraform chez l’hébergeur Scaleway.</p>
<p>Celle-ci comprend 3 articles :</p>
<ul>
<li><a href="/2017/04/29/2017-04-28-interet-deploiement-cluster-swarm-mode-terraform/">l’intérêt de cette solution (ne contient pas d’éléments techniques)</a></li>
<li><a href="/2017/04/29/2017-04-29-generation-image-scaleway-terraform/">la génération de l’image des serveurs Scaleway à déployer</a></li>
<li><a href="/2017/04/29/2017-04-30-deployer-un-cluster-swarm-mode-sur-scaleway-via-terraform/">le déploiement via Terraform du cluster Docker Swarm Mode</a></li>
</ul>
<h1 id="generation-de-l’image-docker"><a href="#generation-de-l’image-docker" class="headerlink" title="génération de l’image docker"></a>génération de l’image docker</h1><p>Il est nécessaire d’utiliser une image, pour que le serveur Scaleway créé via Terraform puisse exécuter un système d’exploitation.<br>Scaleway propose de réutiliser le format de docker (Dockerfile), avec quelques adaptations, pour définir sa propre image.</p>
<p>Pour cela, Scaleway fournit un repository github appelé <a href="https://github.com/scaleway/image-builder" target="_blank" rel="external">image builder</a>, permettant de construire une image iso suivant ses besoins, via un serveur Scaleway.<br>Des images sont fournies par la communauté et validées par l’hébergeur pour être disponibles pour tous, mais on ne peut pas dire que Scaleway soit d’une grande célérité pour les valider (ubuntu et la dernière version de docker ici), ou pour les fournir.</p>
<p>À ce jour (avril 2017), l’image fournie ne contient que docker 1.12.2, soit 3 versions de retard…<br>Il est donc nécessaire de construire sa propre image.</p>
<h2 id="creation-du-serveur-permettant-de-construire-son-image"><a href="#creation-du-serveur-permettant-de-construire-son-image" class="headerlink" title="création du serveur permettant de construire son image"></a>création du serveur permettant de construire son image</h2><p>Un préalable est bien sûr d’avoir un compte Scaleway.<br>La création d’un serveur de construction d’image peut être fait simplement via la ligne de commande de Scaleway appelée <a href="https://github.com/scaleway/scaleway-cli" target="_blank" rel="external">scw</a>.<br>Rappelons que la création de <strong>cette image est spécifique à cet hébergeur</strong>.</p>
<p><code>scw</code> a été pensé pour ressembler à la ligne de commande docker. Vous retrouverez de nombreuses sous-commandes docker qui ont été reprises dans celle-ci.</p>
<p>Identifiez-vous au préalable sur Scaleway via scw :<br><code>scw login</code> </p>
<p><code>scw images</code> vous permet de lister les images disponibles, tant celles de la communauté scaleway que les vôtres.</p>
<p>Vous retrouverez donc l’image dédiée à la construction d’images personnalisées appelée <em>image-builder</em>.</p>
<p><code>scw run</code> vous permet de créer un serveur et le démarrer. Vous lancerez donc un nouveau serveur de création d’image via :</p>
<p><code>scw run --name=&quot;mon-image-perso&quot; image-builder</code></p>
<p>À noter que la construction du serveur n’est pas instantané (quelques minutes), il faudra donc être patient.</p>
<p>Cette commande vous donnera de plus, une connexion ssh sur votre serveur nouvellement crée.</p>
<p>Sur ce serveur, exécutez :</p>
<p><code>image-builder-configure</code></p>
<p>puis identifiez-vous via votre identifiant (mail) et votre mot de passe.<br>Cette étape préalable permettra, une fois l’image construite, de pousser l’image dans l’infrastructure Scaleway pour qu’elle soit disponible (uniquement pour notre compte), lors de la création de nouveaux serveurs (le but de ce second article).</p>
<p>Le serveur nouvellement crée contient 2 fichiers d’exemple qui nous intéressent : <code>Makefile.sample</code> et <code>Dockerfile.sample</code>.</p>
<p>Créez un répertoire dédié :</p>
<p><code>mkdir myimage</code><br>copiez les fichiers d’exemple :</p>
<p><code>cp Makefile.sample myimage/Makefile</code></p>
<p>puis </p>
<p><code>cp Dockerfile.sample myimage/Dockerfile</code></p>
<p>et rentrez dans le répertoire:</p>
<p><code>cd myimage</code></p>
<h3 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h3><p>Ce fichier permet de définir :</p>
<ul>
<li>le nom de l’image à construire</li>
<li>la version</li>
<li>le titre</li>
<li>la description</li>
<li>l’architecture</li>
<li>la taille du volume (espace disque) associé</li>
<li>le nom du script à exécuter lors du démarrage du noyau linux</li>
</ul>
<p>Modifiez le fichier Makefile avec le descriptif, le nom et la version voulue.</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">NAME =                  my-image</div><div class="line">VERSION =               latest</div><div class="line">VERSION_ALIASES =       1.2.3 1.2 1</div><div class="line">TITLE =                 My image</div><div class="line">DESCRIPTION =           My image with Ubuntu and MySQL</div><div class="line">DOC_URL =</div><div class="line">SOURCE_URL =            https://github.com/scaleway-community/...</div><div class="line">VENDOR_URL =</div><div class="line">DEFAULT_IMAGE_ARCH =    x86_64</div><div class="line"></div><div class="line"></div><div class="line">IMAGE_VOLUME_SIZE =     50G</div><div class="line">IMAGE_BOOTSCRIPT =      stable</div><div class="line">IMAGE_NAME =            My image</div><div class="line"></div><div class="line"><span class="comment">## Image tools  (https://github.com/scaleway/image-tools)</span></div><div class="line"><span class="section">all:    docker-rules.mk</span></div><div class="line"><span class="section">docker-rules.mk:</span></div><div class="line">        wget -qO - https://j.mp/scw-builder | bash</div><div class="line"><span class="keyword">-include</span> docker-rules.mk</div></pre></td></tr></table></figure>
<h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><p>Ce fichier permet de décrire les étapes d’installation de votre serveur, comme un fichier Dockerfile classique.<br>Néanmoins, des commentaires sont présents dans ce fichier, qui sont indispensables pour créer l’image sur plusieurs architectures : <strong>n’y touchez pas</strong>.</p>
<h4 id="contenu"><a href="#contenu" class="headerlink" title="contenu"></a>contenu</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> scaleway/ubuntu:amd64-<span class="number">16.10</span></div><div class="line"><span class="comment"># following 'FROM' lines are used dynamically thanks do the image-builder</span></div><div class="line"><span class="comment"># which dynamically update the Dockerfile if needed.</span></div><div class="line"><span class="comment">#FROM scaleway/ubuntu:armhf-16.10       # arch=armv7l</span></div><div class="line"><span class="comment">#FROM scaleway/ubuntu:arm64-16.10       # arch=arm64</span></div><div class="line"><span class="comment">#FROM scaleway/ubuntu:i386-16.10        # arch=i386</span></div><div class="line"><span class="comment">#FROM scaleway/ubuntu:mips-16.10        # arch=mips</span></div><div class="line"></div><div class="line"><span class="comment"># Prepare rootfs</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> /usr/<span class="built_in">local</span>/sbin/scw-builder-enter</span></div><div class="line"></div><div class="line"><span class="comment"># Add your commands here (before scw-builder-leave and after scw-builder-enter)</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> sudo apt-get install -y \</span></div><div class="line">    apt-transport-https \</div><div class="line">    ca-certificates \</div><div class="line">    curl \</div><div class="line">    software-properties-common</div><div class="line"><span class="keyword">RUN</span><span class="bash"> curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> sudo add-apt-repository \</span></div><div class="line">   <span class="string">"deb [arch=amd64] https://download.docker.com/linux/ubuntu \</span></div><div class="line">   <span class="variable">$(lsb_release -cs)</span> \</div><div class="line">   stable"</div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash">  apt-get update &amp;&amp; sudo apt-get install -y docker-ce</span></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p /etc/systemd/system/docker.d</span></div><div class="line"><span class="keyword">COPY</span><span class="bash"> docker.conf /etc/systemd/system/docker.service.d/override.conf</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> systemctl <span class="built_in">enable</span> docker</span></div><div class="line"></div><div class="line"><span class="comment"># Clean rootfs</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> /usr/<span class="built_in">local</span>/sbin/scw-builder-leave</span></div></pre></td></tr></table></figure>
<h4 id="base-de-l’image"><a href="#base-de-l’image" class="headerlink" title="base de l’image"></a>base de l’image</h4><p>Cette image dérive d’une image Ubuntu relativement récente (ici 16.10).</p>
<p>Un choix plus conservateur serait Ubuntu 16.04 LTS (LTS pour Long Term Support).</p>
<p>Notez qu’il est important de choisir une distribution ayant un noyau assez récent, car Docker s’appuie sur des fonctionnalités du noyau Linux qui se sont stabilisées que depuis peu, et évolue à la vitesse d’un cheval au galop.</p>
<p>Une autre alternative, qui va au bout de la démarche de “conteneurisation”, serait de choisir un système d’exploitation reposant uniquement sur des conteneurs tels <a href="http://rancher.com/rancher-os" target="_blank" rel="external">rancherOS</a>, <a href="https://coreos.com" target="_blank" rel="external">CoreOS</a>, <a href="https://vmware.github.io/photon" target="_blank" rel="external">Photon</a> ou <a href="http://www.projectatomic.io" target="_blank" rel="external">Atomic</a>. Cela fera peut-être partie d’un prochain article. L’arrivée de <a href="https://blog.docker.com/2017/04/introducing-linuxkit-container-os-toolkit" target="_blank" rel="external">LinuxKit</a>, essayant d’être le dénominateur commun technique de ces initiatives, en est l’illustration.</p>
<h4 id="description"><a href="#description" class="headerlink" title="description"></a>description</h4><p>Ce fichier Dockerfile comprend l’ajout des utilitaires nécessaires à l’ajout de la clé gpg de Docker, ainsi que le repository, puis l’installation du package <code>docker-ce</code> lui-même.</p>
<p>Le fichier <code>docker.conf</code> est ajouté aussi pour surcharger la configuration par défaut de docker dans systemd (en ne définissant aucune option), afin de permettre de définir par la suite (<a href="/2017/04/29/2017-04-30-deployer-un-cluster-swarm-mode-sur-scaleway-via-terraform/">dans le troisième article</a>), via le fichier <code>/etc/docker/daemon.json</code> (fichier dont l’usage est maintenant recommandé par Docker), les différentes options du démon docker, dont les ports. </p>
<p>Cette étape n’aurait pu être incluse dans l’image générée et donc dans ce Dockerfile, car nous incluons dans le fichier <code>/etc/docker/daemon.json</code> l’adresse IP privée du serveur crée, qui est dynamique.</p>
<p><code>docker.conf</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[Service]</div><div class="line">ExecStart=</div><div class="line">ExecStart=/usr/bin/dockerd</div></pre></td></tr></table></figure>
<h3 id="lancer-la-creation-de-l’image"><a href="#lancer-la-creation-de-l’image" class="headerlink" title="lancer la création de l’image"></a>lancer la création de l’image</h3><p>exécuter la commande suivante pour créer l’image :<br><code>make image_on_local</code></p>
<p>Après l’exécution de la commande précédente, Vous devriez voir votre nouvelle image (à la première ligne) dans <a href="https://cloud.scaleway.com/#/zones/par1/images" target="_blank" rel="external">la liste de celles disponibles</a>.<br>via la commande : </p>
<p><code>scw images</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">REPOSITORY                  TAG                 IMAGE ID            CREATED             REGION              ARCH</div><div class="line">user/My_image               latest              667077c2            7 minutes           [     par1]         [x86_64]</div><div class="line">user/My_image_With_docker   latest              fd23ff8e            2 weeks             [     par1]         [x86_64]</div><div class="line">user/My_image_With_docker   latest              ecaf8b3b            2 weeks             [     par1]         [x86_64]</div><div class="line">Ubuntu_Yakkety              latest              d53fafe4            6 months            [ams1 par1]         [arm x86_64]</div><div class="line">Mattermost                  latest              0644b229            9 months            [ams1 par1]         [x86_64]</div><div class="line">Ubuntu_Xenial               latest              656de689            12 months           [ams1 par1]         [arm x86_64]</div></pre></td></tr></table></figure>
<p>Votre image apparait avec 8 caractères, c’est-à-dire un identifiant tronqué (ici <code>667077c2</code>).</p>
<p>Pour connaître l’identifiant complet, qui sera utilisé lors de la création des serveurs, exécutez la commande suivante :</p>
<p><code>scw inspect 667077c2</code></p>
<p>Celle-ci retourne :<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[&#123;</div><div class="line">  &quot;id&quot;: &quot;667077c2-1d1b-465b-aff4-f22e58a61149&quot;,</div><div class="line">  &quot;name&quot;: &quot;My image&quot;,</div><div class="line">  &quot;creation_date&quot;: &quot;2017-04-22T22:39:56.884833+00:00&quot;,</div><div class="line">  &quot;modification_date&quot;: &quot;2017-04-22T22:39:56.884833+00:00&quot;,</div><div class="line">  &quot;root_volume&quot;: &#123;</div><div class="line">    &quot;id&quot;: &quot;d586f059-3c79-470a-9511-fffaad2a8406&quot;,</div><div class="line">    &quot;size&quot;: 50000000000,</div><div class="line">    &quot;name&quot;: &quot;x86_64-my-image-latest-2017-04-22_22:34&quot;,</div><div class="line">    &quot;volume_type&quot;: &quot;l_ssd&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;default_bootscript&quot;: &#123;</div><div class="line">    &quot;bootcmdargs&quot;: &quot;LINUX_COMMON ip=:::::eth0: boot=local&quot;, </div><div class="line">    &quot;initrd&quot;: &quot;http://169.254.42.24/initrd/initrd-Linux-x86_64-v3.12.4.gz&quot;,</div><div class="line">    &quot;kernel&quot;: &quot;http://169.254.42.24/kernel/x86_64-4.10.8-std-1/vmlinuz-4.10.8-std-1&quot;,</div><div class="line">    &quot;architecture&quot;: &quot;x86_64&quot;,</div><div class="line">    &quot;id&quot;: &quot;8fd15f37-c176-49a4-9e1d-10eb912942ea&quot;,</div><div class="line">    &quot;organization&quot;: &quot;11111111-1111-4111-8111-111111111111&quot;,</div><div class="line">    &quot;title&quot;: &quot;x86_64 4.10.8 std #1 (stable)&quot;,</div><div class="line">    &quot;public&quot;: true</div><div class="line">  &#125;,</div><div class="line">  &quot;organization&quot;: &quot;00000000-0000-5000-9000-000000000000&quot;,</div><div class="line">  &quot;arch&quot;: &quot;x86_64&quot;</div><div class="line">&#125;]</div></pre></td></tr></table></figure></p>
<p>L’identifiant complet est donc <code>667077c2-1d1b-465b-aff4-f22e58a61149</code>.</p>
<p>L’image est prête à être utilisée pour créer nos serveurs.</p>
<h2 id="l’image-n’est-pas-securisee"><a href="#l’image-n’est-pas-securisee" class="headerlink" title="l’image n’est pas sécurisée"></a>l’image n’est pas sécurisée</h2><p>Veuillez noter que <strong>cette image n’est pas du tout sécurisée</strong>. En effet, la configuration SSH n’est pas durcie :</p>
<p>Voici une liste non exhaustive des manquements quant à sa sécurisaition :</p>
<ul>
<li>la désactivation de l’authentification par mot de passe</li>
<li>le changement de port SSH</li>
<li>l’activation de la séparation des privilèges</li>
<li>la désactivation des algorithmes faibles</li>
<li>le ssh port knocking </li>
<li>etc …</li>
</ul>
<p><a href="https://www.ssi.gouv.fr/guide/recommandations-pour-un-usage-securise-dopenssh/" target="_blank" rel="external">Une liste complète pourra être consultée sur le site de l’anssi</a>.</p>
<p>De plus, des mécanismes de sécurité ne sont pas installés (<code>fail2ban</code> par exemple).</p>
<p>Enfin, le fonctionnement des règles des groupes de sécurité réseau de Scaleway sont pour le moins particulières (ou j’ai loupé quelque chose) : </p>
<p>Même si ces règles contiennent les plages IP depuis lesquels accepter le traffic (ici des IP internes 10.0.0.0/8 bien que cela ne nous prémunisse pas des autres clients Scaleway), les ports sont quand mêmes accessibles via l’extérieur….</p>
<p>En bref, la mise en place dans l’image (ce qui n’est pas le cas ici), d’un pare-feu (<a href="https://doc.ubuntu-fr.org/ufw" target="_blank" rel="external">ufw</a>, ou directement netfilter par exemple), n’acceptant que des connexions des serveurs du cluster est nécessaire au delà des quelques  minutes de test de cet article.</p>
<p>Je regrette de plus, que scaleway ne bénéficie pas du réseau privé disponible sur l’infrastructure de la maison mère online.net (appelé RPN).</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>La définition et la construction d’une image de serveur sont facilitées par les outils fournis par Scaleway, inspirés de ceux de Docker. Malheureusement, cette image ne sera pas utilisable directement chez d’autres hébergeurs. <a href="/2017/04/29/2017-04-30-deployer-un-cluster-swarm-mode-sur-scaleway-via-terraform/">Le  troisième et dernier article</a> réutilisera l’image créée ici, pour créer des serveurs et y déployer le cluster Docker Swarm Mode.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-04-29T09:45:00.000Z"><a href="/2017/04/29/2017-04-28-interet-deploiement-cluster-swarm-mode-terraform/">29/04/17</a></time>
      
      
  
    <h1 class="title"><a href="/2017/04/29/2017-04-28-interet-deploiement-cluster-swarm-mode-terraform/">Intérêts Du Déploiement D&#39;un Cluster Docker Swarm Mode via Terraform</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="Contexte"><a href="#Contexte" class="headerlink" title="Contexte"></a>Contexte</h1><p>Je vous propose dans cette série d’articles, d’installer un cluster docker Swarm Mode via Terraform chez l’hébergeur Scaleway.</p>
<p>Celle-ci comprend 3 articles :</p>
<ul>
<li><a href="/2017/04/29/2017-04-28-interet-deploiement-cluster-swarm-mode-terraform/">l’intérêt de cette solution (ne contient pas d’éléments techniques)</a></li>
<li><a href="/2017/04/29/2017-04-29-generation-image-scaleway-terraform/">la génération de l’image des serveurs Scaleway à déployer</a></li>
<li><a href="/2017/04/29/2017-04-30-deployer-un-cluster-swarm-mode-sur-scaleway-via-terraform/">le déploiement via Terraform du cluster Docker Swarm Mode</a> </li>
</ul>
<h1 id="Caracteristiques-generales-de-la-solution"><a href="#Caracteristiques-generales-de-la-solution" class="headerlink" title="Caractéristiques générales de la solution"></a>Caractéristiques générales de la solution</h1><p>Dans ce premier article, voyons les caractéristiques de cette solution (n’hésitez pas à passer directement <a href="/2017/04/29/2017-04-29-generation-image-scaleway-terraform/">au deuxième article si vous êtes allergiques au bla-bla</a>) :<br>il s’agit d’une infrastructure auto-descriptive, flexible, immutable, à forte densité, résistante aux pannes.</p>
<h2 id="une-infrastructure-auto-descriptive"><a href="#une-infrastructure-auto-descriptive" class="headerlink" title="une infrastructure auto-descriptive"></a>une infrastructure auto-descriptive</h2><p>Au lieu d’opérer des opérations d’installation et de configuration, de façon manuelle, et non documentée, il est indispensable de nos jours, d’utiliser des outils automatisés, reposant sur des informations textuelles, que l’on peut gérer via des systèmes de gestion de version (<a href="https://git-scm.com" target="_blank" rel="external">git</a> par exemple).<br>La seule lecture de fichiers doit pouvoir décrire dans son intégralité la solution mise en place.</p>
<p>L’infrastructure déployée doit être automatisée via du code (bye-bye les clickodromes non reproductibles).<br>Cette tendance est appelée <code>infrastructure as code</code> en Anglais.</p>
<h2 id="une-infrastructure-immutable"><a href="#une-infrastructure-immutable" class="headerlink" title="une infrastructure immutable"></a>une infrastructure immutable</h2><p>L’”immutabilité” (en vrai français l’immuabilité), est particulièrement à la mode en ce moment, tant au niveau de la programmation (Erlang, Scala …), que des infrastructures.</p>
<p>Concernant la fourniture de serveurs, dès qu’un changement doit être opéré, au lieu de modifier celui-ci, nous allons le détruire pour en recréer un autre, de façon automatisée. Cela évitera dans le temps, de ne plus maîtriser l’état du serveur ; en effet, l’installation, la mise à jour, la suppression, puis la réinstallation d’une nouvelle version d’un logiciel sur un serveur n’est souvent pas équivalent à l’installation directe de cette nouvelle version. L’état du serveur devient de moins en moins maîtrisable au cours du temps, il se dégrade.</p>
<p>Ainsi, des outils forts pratiques tels <a href="https://www.ansible.com" target="_blank" rel="external">Ansible</a>, <a href="https://puppet.com" target="_blank" rel="external">Puppet</a> ou <a href="https://www.chef.io/chef/" target="_blank" rel="external">Chef</a>,  pour ne citer que les plus connus, qui automatisent beaucoup de tâches, sont de moins en moins utilisés pour déployer des infrastructures (serveurs, DNS, réseaux etc..), car leur utilisation répétée sur ces mêmes ressources ne permet plus de maîtriser précisément leurs états au bout d’un certain temps. Néanmoins, ils restent présents concernant la finalisation quelquefois complexe des serveurs.</p>
<p>Cette évolution est traduite en anglais par l’expression “pets vs cattle”, c’est-a-dire la comparaison de serveurs à des animaux de compagnie (“pets”), auquel on porte une grande attention (pour faire le parallèle à la grande complexité actuelle pour maîtriser l’état de nos serveurs), à opposer au bétail (“cattle”), auquel on n’attache pas une grande importance (on n’hésite pas à recréer un serveur au lieu de le faire évoluer). </p>
<h2 id="une-infrastructure-flexible"><a href="#une-infrastructure-flexible" class="headerlink" title="une infrastructure flexible"></a>une infrastructure flexible</h2><p>Concernant la flexibilité, l’appel d’APIs de fournisseurs d’infrastucture à la demande (IAAS ou infrastructure as a service) s’impose de plus en plus.<br>Les hébergeurs peuvent être internes aux grandes entreprises avec des déploiements de centre de données VMWare par exemple, ou externes avec des fournisseurs tels <a href="http://aws.amazon.com" target="_blank" rel="external">Amazon Web Services (AWS)</a>, Digital Océan, ou Scaleway dans cette série d’articles.<br>Cette flexibilité permet d’ajuster son infrastructure en temps réel au gré de ses besoins.</p>
<h2 id="une-infrastructure-a-haute-densite"><a href="#une-infrastructure-a-haute-densite" class="headerlink" title="une infrastructure à haute densité"></a>une infrastructure à haute densité</h2><p>L’usage tendant à se généraliser des conteneurs, principalement <a href="https://www.docker.com" target="_blank" rel="external">Docker</a>, permet de faciliter et standardiser l’installation de logiciels, et de densifier les serveurs.<br>En effet, l’installation de multiples conteneurs sur un même serveur, permet de rentabiliser au mieux l’usage des serveurs : de nombreux logiciels se côtoient sans effets de bords notables (mise à part une concurrence accrue sur l’usage des ressources serveurs). </p>
<h2 id="infrastructure-resistante-aux-pannes"><a href="#infrastructure-resistante-aux-pannes" class="headerlink" title="infrastructure résistante aux pannes"></a>infrastructure résistante aux pannes</h2><p>Une infrastructure résistante au pannes sera distribuée et redondée sur plusieurs serveurs (voire plusieurs centre de données), afin de pallier à une défaillance de l’un d’entre eux.</p>
<h1 id="et-concretement-du-cote-de-la-technique"><a href="#et-concretement-du-cote-de-la-technique" class="headerlink" title="et concrètement du côté de la technique ?"></a>et concrètement du côté de la technique ?</h1><h2 id="Docker-Swarm-Mode"><a href="#Docker-Swarm-Mode" class="headerlink" title="Docker Swarm Mode"></a>Docker Swarm Mode</h2><p>L’usage de conteneurs Docker tend à se généraliser pour standardiser le déploiement d’applications.<br>Les différents conteneurs devant intéragir pour former des applications (serveur web, base de données etc…), différentes solutions d’orchestration existent.<br>J’ai choisi pour cet article une solution récente et simple :<br><a href="https://docs.docker.com/engine/swarm" target="_blank" rel="external">docker swarm mode</a>.</p>
<p>Elle n’est pas aussi mûre que <a href="http://mesos.apache.org/" target="_blank" rel="external">Mesos</a>, ni la plus complète (<a href="https://kubernetes.io" target="_blank" rel="external">Kubernetes</a>), mais est une des plus simples (avec <a href="https://github.com/rancher/cattle" target="_blank" rel="external">Cattle</a> un des orchestrateurs supportés par <a href="http://rancher.com" target="_blank" rel="external">Rancher</a>).</p>
<h2 id="Terraform"><a href="#Terraform" class="headerlink" title="Terraform"></a>Terraform</h2><p>Nous utiliserons <a href="https://www.terraform.io" target="_blank" rel="external">Terraform</a>, une solution de description et de construction d’infrastructure immutable. Celle-ci comprend de nombreux fournisseurs (providers), dont scaleway pour les serveurs, et cloudflare pour le DNS.</p>
<h2 id="Scaleway"><a href="#Scaleway" class="headerlink" title="Scaleway"></a>Scaleway</h2><p>J’ai choisi l’hébergeur français <a href="http://www.scaleway.com" target="_blank" rel="external">Scaleway</a>, filiale de <a href="www.online.net">Online</a>, pour son coût modique, et la présence d’un “provider” Terraform.<br>Cette solution est encore assez jeune, et fournit un niveau très basique d’équipement à la demande, contrairement à sa maison mère (pas de réseau privé virtuel RPN ici par exemple).</p>
<h2 id="Cloudflare"><a href="#Cloudflare" class="headerlink" title="Cloudflare"></a>Cloudflare</h2><p>J’ai choisi d’utiliser cloudflare pour gérer le nom de domaine, car celui-ci fournit ce service gratuitement, et permet d’inclure une étoile (wildcard), comme sous-domaine, permettant que tous les sous-domaines soient redirigés vers le cluster Docker Swarm Mode.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Les différentes propriétés décrites dans ce premier article, permettent je l’espère de vous faire comprendre l’intérêt des outils mis en oeuvre.</p>
<p>Passons maintenant à la lecture du <a href="/2017/04/29/2017-04-29-generation-image-scaleway-terraform/">deuxième article </a> pour passer à la mis en oeuvre.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-11-05T22:46:00.000Z"><a href="/2016/11/05/2016-11-05-lire-et-ecrire-dans-kafka-en-ligne-de-commande-sans-jvm/">05/11/16</a></time>
      
      
  
    <h1 class="title"><a href="/2016/11/05/2016-11-05-lire-et-ecrire-dans-kafka-en-ligne-de-commande-sans-jvm/">Kafkacat : Lire Et Écrire Dans Kafka en Ligne De Commande Sans JVM</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Cette série d’articles essaie de vous faire découvrir des outils bien utiles autour de <a href="https://kafka.apache.org/" target="_blank" rel="external">Apache Kafka</a>.</p>
<p>Le premier outil est <a href="https://github.com/edenhill/kafkacat" target="_blank" rel="external">kafkacat</a>, un outil en ligne de commande qui permet facilement et rapidement de lire et d’écrire dans des topics kafka.</p>
<h1 id="outils-fournis-par-apache-kafka"><a href="#outils-fournis-par-apache-kafka" class="headerlink" title="outils fournis par apache kafka"></a>outils fournis par apache kafka</h1><p>Le projet open source <a href="https://kafka.apache.org" target="_blank" rel="external">Apache Kafka</a> propose une série d’outils pour intéragir avec cette plateforme de streaming distribuée ultra-performante :<br> ceux-ci font partie intégrante du projet. </p>
<p>Pour les utiliser, il est nécessaire de récupérer le projet sur github, et de lancer ces scripts qui lancent des machines virtuelles Java. Ces outils sont les plus aboutis et complets. Néanmoins, pour des besoins simples, il est pratique  d’utiliser des interfaces en ligne de commande (CLI).</p>
<h1 id="interet-de-kafkacat"><a href="#interet-de-kafkacat" class="headerlink" title="intérêt de kafkacat"></a>intérêt de kafkacat</h1><p>Kafkacat est une interface en ligne de commande. Elle permet donc d’être chaînée, afin de filtrer les messages lus, rediriger le flux vers un fichier, ou vers d’autres outils Linux.</p>
<p>#installation</p>
<p>Des packages sont disponibles dans la plupart des distributions Linux.<br>Sous Ubuntu, il faut lancer : </p>
<p><code>sudo apt-get install kafkacat</code></p>
<h1 id="un-horizon-des-commandes-kafkacat"><a href="#un-horizon-des-commandes-kafkacat" class="headerlink" title="un horizon des commandes kafkacat"></a>un horizon des commandes kafkacat</h1><h2 id="afficher-l’aide"><a href="#afficher-l’aide" class="headerlink" title="afficher l’aide"></a>afficher l’aide</h2><p>Pour afficher l’aide, il suffit de lancer :</p>
<p><code>kafkacat -h</code></p>
<h2 id="afficher-la-version"><a href="#afficher-la-version" class="headerlink" title="afficher la version"></a>afficher la version</h2><p>Pour afficher la version, il suffit de lancer :</p>
<p><code>kafkacat -V</code></p>
<h2 id="structure-d’une-commande-kafkacat"><a href="#structure-d’une-commande-kafkacat" class="headerlink" title="structure d’une commande kafkacat"></a>structure d’une commande kafkacat</h2><p>une commande kafkacat s’exécute toujours de la façon suivante :</p>
<p><code>kafacat -b host:port -mode -modeoptions</code></p>
<p>Il est indispensable de spécifier évidemment un ou des brokers kafka auxquels se connecter, via l’attribut <code>-b</code>.</p>
<p>Celui-ci doit être complété par le mode avec les valeurs suivantes :</p>
<ul>
<li><code>-L</code> pour lire les méta-données du cluster kafka (topics, nombre de partitions etc..)</li>
<li><code>-C</code> pour lire les messages </li>
<li><code>-P</code> pour produire les messages</li>
</ul>
<h2 id="options-generales"><a href="#options-generales" class="headerlink" title="options générales"></a>options générales</h2><p>les options suivantes sont présentes dans tous les modes :</p>
<ul>
<li><code>-b</code> pour spécifier l’hôte et le port des brokers kafka de la forme <code>host1:port1;host2:port2,host3:port3</code></li>
<li><code>-t</code> pour spécifier le topic</li>
<li><code>-c</code> pour limiter le nombre de message produits ou lus</li>
<li><code>-p</code> pour spécifier la partition</li>
<li><code>-G</code> pour spécifier le groupe de consommateurs</li>
<li><code>-X</code> pour spécifier des options à la librairie libdrdkafka C sous-jacente à kafkacat</li>
<li><code>-K</code> pour spécifier le délimiteur de la clé (optionnelle) d’un message</li>
<li><code>-D</code> pour spécifier le délimiteur de la valeur d’un message</li>
<li><code>-q</code> pour que kafkacat soit silencieux</li>
<li><code>-d</code> pour permettre le débugging via la librairie libdrdkafka</li>
</ul>
<h2 id="lire-les-metadonnees-du-cluster"><a href="#lire-les-metadonnees-du-cluster" class="headerlink" title="lire les métadonnées du cluster"></a>lire les métadonnées du cluster</h2><p>Lister les topics présent dans un broker se fera via la commande suivante :</p>
<p><code>kafkacat -b 127.0.0.1:9092 -L</code></p>
<p>et donnera ce type de résultat :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">Metadata <span class="keyword">for</span> all topics (from broker 1: 127.0.0.1:9092/1):</div><div class="line"></div><div class="line">1 brokers:</div><div class="line"></div><div class="line">broker 1 at 127.0.0.1:9092</div><div class="line"></div><div class="line">3 topics:</div><div class="line"></div><div class="line">topic <span class="string">"Topic2"</span> with 1 partitions:</div><div class="line"></div><div class="line">partition 0, leader 1, replicas: 1, isrs: 1</div><div class="line"></div><div class="line">topic <span class="string">"test-compact"</span> with 1 partitions:</div><div class="line"></div><div class="line">partition 0, leader 1, replicas: 1, isrs: 1</div><div class="line"></div><div class="line">topic <span class="string">"Topic1"</span> with 1 partitions:</div><div class="line"></div><div class="line">partition 0, leader 1, replicas: 1, isrs: 1</div></pre></td></tr></table></figure>
<p>Indiquant :</p>
<ul>
<li>la liste des brokers avec leur identifiant</li>
<li>la liste des topics</li>
<li>pour chaque topic, les partitions</li>
<li>pour chaque partition le broker hébergeant la partition leader, les brokers hébergeant les réplicas, et le nombre de réplicas synchronisés (<code>isrs</code>)</li>
</ul>
<h2 id="lire-des-messages"><a href="#lire-des-messages" class="headerlink" title="lire des messages"></a>lire des messages</h2><p>Kafka stocke ses messages dans des topics, qui contiennent une ou plusieurs partitions.<br>Les message sont toujours lus du plus ancien au plus récent, et ont un ordre garanti au sein d’une même partition.</p>
<p><code>kafkacat -b mybroker:9092 -C -t mytopic</code></p>
<p>Cette commande permet de lister les messages présents dans le topic <code>mytopic</code>, mais ne se terminera pas : kafkacat restera en écoute de nouveaux messages.</p>
<h3 id="lire-des-messages-et-quitter"><a href="#lire-des-messages-et-quitter" class="headerlink" title="lire des messages et quitter"></a>lire des messages et quitter</h3><p>Afin de terminer la commande après avoir lu les messages, il faut ajouter l’option <code>-e</code> -pour <em>exit</em>) :<br><code>kafkacat -b mybroker:9092 -C -t mytopic -e</code></p>
<h3 id="lire-des-messages-depuis-un-offset-donne"><a href="#lire-des-messages-depuis-un-offset-donne" class="headerlink" title="lire des messages depuis un offset donné"></a>lire des messages depuis un offset donné</h3><p>Par défaut, kafkacat lit les messages du topic depuis les offsets les plus récents de chaque partition. Néanmoins, on peut spécifier à partir de quel offset on souhaite lire le topic via l’argument <code>-o</code>.<br>Les valeurs possibles sont : </p>
<ul>
<li><code>beginning</code> </li>
<li><code>end</code></li>
<li><code>stored</code></li>
<li><code>une valeur positive</code></li>
<li><code>une valeur négative</code></li>
</ul>
<h4 id="beginning"><a href="#beginning" class="headerlink" title="beginning"></a>beginning</h4><p><code>kafkacat -b host:port -C -t mytopic -o beginning -e</code></p>
<p>lira les messages du topic depuis le plus ancien message encore stocké pour chaque partition (le message peut disparaître plus ou moins rapidement en fonction des règles de suppression configurées dans kafka).</p>
<h4 id="end"><a href="#end" class="headerlink" title="end"></a>end</h4><p><code>kafkacat -b host:port -C -t mytopic -o end</code></p>
<p>lira les futurs messages à partir du dernier message stocké pour chaque partition au moment de l’interrogation de kafka.</p>
<p>Y coupler <code>-e</code> n’aura pas trop de sens, car la commande sortira avant d’avoir pu récupérer un nouveau message.</p>
<h4 id="stored"><a href="#stored" class="headerlink" title="stored"></a>stored</h4><p>A la place de spécifier en option l’offset à partir duquel lire les messages, kafkacat peut lire l’offset de début de lecture pour chaque partition via une autre source de données : </p>
<ul>
<li>de façon locale, via un répertoire :</li>
</ul>
<p><code>kafkacat -b mybroker.example.org  -C -t mytopic -e -o stored -c 1000 -X offset.store.method=file -X topic.auto.commit.interval.ms=250 -X topic.offset.store.path=/tmp/kafka-offsets</code></p>
<p>Permettra de lire les messages de ce topic depuis les offsets désignés pour chaque partition. Si le répertoire est vide, kafkacat créera les fichiers nécessaires pour stocker ces offsets (de la forme <code>topicname-partition*.offset</code>). Le dernier offset lu sera sauvegardé toutes les 250 millisecondes.</p>
<ul>
<li>de façon distribuée dans kafka lui-même :<br><code>kafkacat -b mybroker.example.org  -C -t mytopic -e -o stored -c 1000 -X offset.store.method=broker -X topic.auto.commit.interval.ms=250 -X group.id=mygroup</code></li>
</ul>
<p>L’offset est stocké dans un topic spécial, utilisé par kafka pour connaître les derniers offsets de chaque partition de chaque topic, pour chaque groupe de consommateurs.<br>Il est donc nécessaire de passer à kafka l’identifiant du groupe de consommateurs pour qu’il puisse identifier quel dernier message vous avez lu.</p>
<h4 id="valeur-positive"><a href="#valeur-positive" class="headerlink" title="valeur positive"></a>valeur positive</h4><p><code>kafkacat -b host:port -C -t mytopic -o 31559 -e</code></p>
<p>lira les messages depuis l’offset 31559 de toutes les partitions jusqu’à la fin du topic au moment de l’interrogation de kafka.</p>
<h4 id="valeur-negative"><a href="#valeur-negative" class="headerlink" title="valeur négative"></a>valeur négative</h4><p>Il est possible de lire (approximativement), par exemple les 1500 derniers messages d’un topic (sur l’ensemble des partitions), en lançant la commande suivante :</p>
<p><code>kafkacat -b host:port -C -t mytopic -o -1500 -e</code></p>
<h3 id="lire-des-messages-sur-une-partition-donnee"><a href="#lire-des-messages-sur-une-partition-donnee" class="headerlink" title="lire des messages sur une partition donnée"></a>lire des messages sur une partition donnée</h3><p>Il est possible de lire sur une partition donnée via <code>-p</code>, avec la commande suivante :</p>
<p><code>kafkacat -b host:port -C -t mytopic -o -1500 -p 4 -e</code></p>
<p>Ne seront retournés que les messages du topic stockés dans la partition numéro 4.</p>
<h3 id="lire-des-messages-avec-un-groupe-de-consommateurs-donne"><a href="#lire-des-messages-avec-un-groupe-de-consommateurs-donne" class="headerlink" title="lire des messages avec un groupe de consommateurs donné"></a>lire des messages avec un groupe de consommateurs donné</h3><p>Il est possible de lire des messages en tant que membre d’un groupe de consommateurs avec la commande suivante :</p>
<p><code>kafkacat -b host:port -C -t mytopic -G mygroup -e</code></p>
<p>Kafka nous assignera des partitions du topic à lire (toutes les partitions si nous sommes le seul membre actif du groupe), et nous délivrera les messages à partir des derniers offsets lus pour chaque partition.</p>
<h3 id="lire-des-messages-avec-un-format-de-sortie-personnalise"><a href="#lire-des-messages-avec-un-format-de-sortie-personnalise" class="headerlink" title="lire des messages avec un format de sortie personnalisé"></a>lire des messages avec un format de sortie personnalisé</h3><p>Les options de formattage sont :</p>
<ul>
<li><code>%t</code> pour le topic</li>
<li><code>%p</code> pour la partition</li>
<li><code>%o</code> pour l’offset</li>
<li><code>%k</code> pour la clé</li>
<li><code>%S</code> pour la taille du message</li>
<li><code>%s</code> pour le cotnenu du message</li>
</ul>
<p><code>kafkacat -b broker:port -t mytopic -e -f &#39;Topic %t[%p], offset: %o, key: %k, payload: %S bytes: %s\n&#39;</code></p>
<h3 id="lire-des-messages-avec-une-enveloppe-JSON-en-sortie"><a href="#lire-des-messages-avec-une-enveloppe-JSON-en-sortie" class="headerlink" title="lire des messages avec une enveloppe JSON  en sortie"></a>lire des messages avec une enveloppe JSON  en sortie</h3><p>L’option <code>-J</code> permet d’avoir une enveloppe JSON encadrant la clé, et le message.</p>
<p><code>kafkacat -b host:port -C -t mytopic -e -J</code></p>
<h2 id="ecrire-des-messages"><a href="#ecrire-des-messages" class="headerlink" title="écrire des messages"></a>écrire des messages</h2><h3 id="ecrire-des-messages-depuis-la-sortie-standard"><a href="#ecrire-des-messages-depuis-la-sortie-standard" class="headerlink" title="écrire des messages depuis la sortie standard"></a>écrire des messages depuis la sortie standard</h3><p>Pour écrire un message depuis la sortie standard :</p>
<p><code>kafkacat -b 127.0.0.1:9092 -t Topic2 -P -c 1 -e</code></p>
<p>écrire son message et appuyez sur la touche entrée pour terminer le message.</p>
<h3 id="ecrire-des-messages-depuis-un-fichier-contenant-plusieurs-messages"><a href="#ecrire-des-messages-depuis-un-fichier-contenant-plusieurs-messages" class="headerlink" title="écrire des messages depuis un fichier contenant plusieurs messages"></a>écrire des messages depuis un fichier contenant plusieurs messages</h3><p>Il est possible de produire des messages depuis un fichier les contenant délimités par des caractères séparateurs, via l’argument <code>-l</code>.</p>
<p><code>kafkacat -b 127.0.0.1:9092 -t Topic2 -P -e -l file1</code></p>
<p>Cette option n’est possible que pour un fichier.</p>
<h3 id="ecrire-des-messages-depuis-des-fichiers"><a href="#ecrire-des-messages-depuis-des-fichiers" class="headerlink" title="écrire des messages depuis des fichiers"></a>écrire des messages depuis des fichiers</h3><p>Il est possible de produire des messages depuis plusieurs fichiers, chacun contenant un seul message.<br>Même si ces fichiers contiennent des séparateurs, le contenu de chaque fichier sera considéré comme un seul message.</p>
<p><code>kafkacat -b 127.0.0.1:9092 -t Topic2 -P -e file1 file2 file3</code></p>
<h3 id="ecrire-des-messages-depuis-des-fichiers-via-des-separateurs-personnalises"><a href="#ecrire-des-messages-depuis-des-fichiers-via-des-separateurs-personnalises" class="headerlink" title="écrire des messages depuis des fichiers via des séparateurs personnalisés"></a>écrire des messages depuis des fichiers via des séparateurs personnalisés</h3><p>Il est possible de définir les séparateurs de messages via l’option <code>-D</code>, et les séparateurs des clés des messages via l’option <code>-K</code> :</p>
<p><code>kafkacat -b 127.0.0.1:9092 -t Topic2 -P -e -D% -K/ file1 file2 file3</code></p>
<p>Un fichier pourra avoir la structure suivante :</p>
<p><code>7892/monmessage%7893/deuxiememessage%7894/troisiememessage</code></p>
<h1 id="compatibilite-des-versions-de-kafka-avec-kafkacat"><a href="#compatibilite-des-versions-de-kafka-avec-kafkacat" class="headerlink" title="compatibilité des versions de kafka avec kafkacat"></a>compatibilité des versions de kafka avec kafkacat</h1><p>Comme évoqué auparavant, kafkacat repose sur la librairie C <a href="https://github.com/edenhill/librdkafka" target="_blank" rel="external">libdrdkafka</a>.</p>
<p>Certaines versions de cette librairie ont pour comportement par défaut d’intéragir avec le protocole de kafka dans une certaine version;<br>ce comportement par défaut ne correspond pas toujours à la version de kafka que vous utilisez. Il faut donc spécifier via des paramètres libdrdkafka (option <code>-X</code>)le protocole à utiliser. Ainsi, quand on lit un kafka 0.10.1.0 avec kafkacat 1.3.0-1 on peut obtenir l’erreursuivante :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">%4|1480463638.946|PROTOERR|rdkafka<span class="comment">#consumer-1| 127.0.0.1:9092/9092: Protocol parse failure at rd_kafka_fetch_reply_handle:3864 (incorrect broker.version.fallback?)</span></div><div class="line">%4|1480463638.946|PROTOERR|rdkafka<span class="comment">#consumer-1| 127.0.0.1:9092/9092: expected 10370775 bytes &gt; 44 remaining bytes</span></div><div class="line">%4|1480463639.551|PROTOERR|rdkafka<span class="comment">#consumer-1| 127.0.0.1:9092/9092: Protocol parse failure at rd_kafka_fetch_reply_handle:3864 (incorrect broker.version.fallback?)</span></div><div class="line">%4|1480463639.551|PROTOERR|rdkafka<span class="comment">#consumer-1| 127.0.0.1:9092/9092: expected 10370775 bytes &gt; 44 remaining bytes</span></div><div class="line">%4|1480463640.156|PROTOERR|rdkafka<span class="comment">#consumer-1| 127.0.0.1:9092/9092: Protocol parse failure at rd_kafka_fetch_reply_handle:3864 (incorrect broker.version.fallback?)</span></div></pre></td></tr></table></figure>
<p>Le paramétrage suivant permettra de résoudre ce problème : </p>
<p><code>kafkacat -b mybroker:9092 -C -t mytopic -e -X api.version.request=true</code></p>
<p>Les compatibilités des versions et les options à activer en fonction sont listées dans la page suivante :</p>
<p><a href="https://github.com/edenhill/librdkafka/wiki/Broker-version-compatibility" target="_blank" rel="external">page de compatibilité</a></p>
<h1 id="limites-de-kafkacat"><a href="#limites-de-kafkacat" class="headerlink" title="limites de kafkacat"></a>limites de kafkacat</h1><p>Kafkacat ne permet pas toutes les intéractions permises par les outils intégrés dans le projet Kafka.</p>
<p>La principale cause est l’absence de toutes les fonctionnalités de ces outils dans le protocole d’interaction avec Kafka.<br>De nombreuses avancées arrivent de version en version, mais des manques persistent.</p>
<h2 id="creation-et-suppression-de-topics"><a href="#creation-et-suppression-de-topics" class="headerlink" title="création et suppression de topics"></a>création et suppression de topics</h2><p>Kafka <strong>0.10.1.0</strong> intègre dans son protocole <strong>la création et la suppression de topics</strong>.<br>Kafkacat <strong>1.3.0</strong> n’intègre pas cette fonctionnalité qui est prévue pour la version <strong>1.4.0</strong>.</p>
<h2 id="recherche-par-timestamp"><a href="#recherche-par-timestamp" class="headerlink" title="recherche par timestamp"></a>recherche par timestamp</h2><p>Cette fonctionnalité est aussi apparue dans la version <strong>0.10.1.0</strong> de kafka. Elle n’est pas encore supportée par kafkacat.</p>
<h2 id="support-de-la-compression-lz4"><a href="#support-de-la-compression-lz4" class="headerlink" title="support de la compression lz4"></a>support de la compression lz4</h2><p>La compression <strong>lz4</strong>, ajoutée en complément des compressions <strong>gzip</strong> et <strong>snappy</strong>, a été implémentée dans kafkacat mais n’est pas encore présent dans le paquet distribué par ubuntu.</p>
<p>Il conviendra donc de compiler depuis les sources kafkacat, avec une version plus récente de la librairie <strong>libdrdkafka</strong> pour supporter ce nouvel algorithme.</p>
<h1 id="conclusion"><a href="#conclusion" class="headerlink" title="conclusion"></a>conclusion</h1><p>Kafkacat me semble être un bon outil en ligne de commande, permettant d’interagir de façon performante avec kafka, et de s’intégrer aux autres lignes de commandes Linux via le chaînage des commandes.</p>
<p>Néanmoins, il s’avère dans certains cas indispensable d’avoir une version récente de kafkacat, ou de passer par les outils fournis avec kafka.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-07-20T09:54:00.000Z"><a href="/2014/07/20/2014-07-20-webappender-personnaliser-les-logs-affichees-dans-son-navigateur/">20/07/14</a></time>
      
      
  
    <h1 class="title"><a href="/2014/07/20/2014-07-20-webappender-personnaliser-les-logs-affichees-dans-son-navigateur/">Webappender : Personnaliser Les Logs Affichées Dans Son Navigateur</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Cette série de deux articles décrit le fonctionnement de la librairie de visualisation de logs <a href="https://github.com/clescot/webappender" target="_blank" rel="external">webappender</a>. </p>
<p>Le premier article expose sa mise en place, et les différentes façons de visualiser les logs suivant son navigateur.</p>
<p>Le deuxième article décrit la façon de choisir le contenu et la taille des logs à afficher.</p>
<h1 id="Personnaliser-le-contenu-des-logs"><a href="#Personnaliser-le-contenu-des-logs" class="headerlink" title="Personnaliser le contenu des logs"></a>Personnaliser le contenu des logs</h1><p>La librairie <a href="https://github.com/clescot/webappender" target="_blank" rel="external">webappender</a>, permet de personnaliser le contenu de chaque log. par défaut, toutes les informations disponibles via logback sont incluses.</p>
<p>Néanmoins, certaines informations peuvent être longues à récupérer. Webappender permet donc de ne pas aller chercher et inclure ces informations, si le header HTTP <code>X-wa-verbose-logs=false</code> est transmis.</p>
<p>Ainsi, seront <strong>exclues</strong> de chaque log, les informations suivantes :</p>
<ul>
<li>le numéro de ligne</li>
<li>le chemin du fichier hébergeant la classe java</li>
<li>le temps</li>
<li>le temps relatif</li>
<li>le nom du thread</li>
<li>la classe appelante</li>
<li>la méthode appelante</li>
<li>le <a href="http://logback.qos.ch/manual/mdc.html" target="_blank" rel="external">Mapped Diagnostic context</a> (MDC)</li>
<li>le ThrowableProxy (permettant de récupérer les informations d’une exception)</li>
<li><a href="http://logback.qos.ch/manual/configuration.html#contextName" target="_blank" rel="external">le nom du contexte</a></li>
<li>les données du code appelant (CallerData), c’est-à-dire la stackTrace</li>
<li><a href="http://www.slf4j.org/api/org/slf4j/Marker.html" target="_blank" rel="external">le marqueur</a> </li>
</ul>
<p>Avec cette configuration, le temps d’exécution des requêtes est donc moins impactés lorsque le webappender est activé.</p>
<h1 id="Filtrer-les-logs"><a href="#Filtrer-les-logs" class="headerlink" title="Filtrer les logs"></a>Filtrer les logs</h1><p>Webappender, supporte <a href="http://logback.qos.ch/manual/filters.html" target="_blank" rel="external">les filtres logback</a>, pour réduire les traces applicatives (logs) transmises à votre navigateur.</p>
<p>Veuillez noter que ces filtres ne sont appliqués que dans le contexte de webappender, c’est-à-dire dans les informations transmises dans la réponse HTTP. </p>
<p>Ce filtrage ne s’applique, comme toujours, qu’aux traces liées aux requêtes faites par votre navigateur.<br>Les traces ne sont pas filtrées dès leur création, comme pourrait le faire les <a href="http://logback.qos.ch/apidocs/ch/qos/logback/classic/turbo/class-use/TurboFilter.html" target="_blank" rel="external">filtres turbo</a>.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-05-27T21:46:00.000Z"><a href="/2014/05/27/2014-05-27-webappender-visualisez-les-logs-logback-dans-son-navigateur/">27/05/14</a></time>
      
      
  
    <h1 class="title"><a href="/2014/05/27/2014-05-27-webappender-visualisez-les-logs-logback-dans-son-navigateur/">Webappender : Pour Visualiser Les Logs Logback Dans Son Navigateur</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Cette série de deux articles décrit le fonctionnement de la librairie de visualisation de logs <a href="https://github.com/clescot/webappender" target="_blank" rel="external">webappender</a>. </p>
<p>Le premier article expose sa mise en place, et les différentes façons de visualiser les logs suivant son navigateur.</p>
<p>Le deuxième article décrit la façon de choisir le contenu et la taille des logs à afficher.</p>
<h1 id="Le-probleme"><a href="#Le-probleme" class="headerlink" title="Le problème"></a>Le problème</h1><p>Pour des applications web, il est courant de d’effectuer la recette des fonctionnalités sur des serveurs <strong>distants</strong>.</p>
<p> Quand un comportement non attendu survient, il est nécessaire de retracer le fonctionnement précis de l’application, notamment via l’inspection des traces applicatives aussi appelées logs.</p>
<p>Le serveur étant distant, il est souvent nécessaire :</p>
<ul>
<li>de se connecter en ssh sur le bon serveur</li>
<li>d’identifier le répertoire hébergeant les logs</li>
<li>d’identifier le bon fichier de logs</li>
<li>de démêler les logs correspondants à son test, des autres logs</li>
</ul>
<p>Ces opérations ne sont pas instantanées et rébarbatives. </p>
<h1 id="Webappender"><a href="#Webappender" class="headerlink" title="Webappender"></a>Webappender</h1><p>Afin d’éviter toutes ses étapes, j’ai créer le webappender, afin que les traces serveur issues de vos requêtes HTTP arrivent directement dans votre navigateur.</p>
<p>Ainsi, les autres logs des requêtes exécutées de façon concurrente sur le serveur, ne sont pas envoyées vers votre navigateur. Le développeur regarde donc <strong>uniquement</strong> les informations qui sont liées à son test.</p>
<h1 id="Mise-en-place-dans-votre-application-web-JEE"><a href="#Mise-en-place-dans-votre-application-web-JEE" class="headerlink" title="Mise en place dans votre application web JEE"></a>Mise en place dans votre application web JEE</h1><h2 id="Pre-requis"><a href="#Pre-requis" class="headerlink" title="Pré-requis"></a>Pré-requis</h2><p>Webappender est compatible avec les applications <a href="http://en.wikipedia.org/wiki/Java_Platform,_Enterprise_Edition" target="_blank" rel="external">JEE</a> utilisant la librairie de logs <a href="http://logback.qos.ch" target="_blank" rel="external">logback</a>.<br>L’adhérence entre webappender et JEE est minime. Une compatibilité plus large est donc possible.</p>
<h2 id="Installation-en-2-etapes"><a href="#Installation-en-2-etapes" class="headerlink" title="Installation en 2 étapes"></a>Installation en 2 étapes</h2><h3 id="Maven"><a href="#Maven" class="headerlink" title="Maven"></a>Maven</h3><p>Ajouter à votre fichier Maven <code>pom.xml</code> cette dépendance :</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.clescot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>webappender<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>Notez qu’un filtre de servlet, installé par annotation, est fourni avec la librairie. Son <em>urlPatterns</em> correspond à toutes les requêtes (<code>/*</code>).</p>
<h3 id="Activer-le-webappender"><a href="#Activer-le-webappender" class="headerlink" title="Activer le webappender"></a>Activer le webappender</h3><p>Par défaut, webappender est <strong>désactivé</strong> .</p>
<p><strong>Permettre de visualiser les logs de chacun (par une interception du réseau), peut être très risqué et dangereux dans des environnements de production</strong>.</p>
<p>Donc, pour prévenir toute erreur de configuration, nous désactivons par défaut le webappender.</p>
<p>Pour l’activer, vous devez mettre ce paramètre sur la ligne de commande qui lance votre serveur d’applications :<br>    <code>-Dwebappender=true</code>.</p>
<h1 id="Visualisation-des-logs"><a href="#Visualisation-des-logs" class="headerlink" title="Visualisation des logs"></a>Visualisation des logs</h1><p>La librairie webappender permet de visualiser les logs de sa requête dans tous les navigateurs.<br>Les visualisations de logs dans les configurations suivantes, impliquent une installation de webappender dans votre application JEE utilisant logback, avec un serveur d’applications java actif.</p>
<h2 id="Vos-logs-dans-Chrome-via-ChromeLogger"><a href="#Vos-logs-dans-Chrome-via-ChromeLogger" class="headerlink" title="Vos logs dans Chrome via ChromeLogger"></a>Vos logs dans Chrome via ChromeLogger</h2><p>Vous devez installer le plugin chrome intitulé <a href="https://chrome.google.com/webstore/detail/chrome-logger/noaneddfkdjfnfdakjjmocngnfkfehhd" target="_blank" rel="external">ChromeLogger</a>.</p>
<p>Malheureusement, <em>Chrome logger</em> ne transmet par défaut aucun header l’identifiant, contrairement à d’autres plugins.</p>
<p>Or, Webappender transmet les logs à votre navigateur, quand les requêtes contiennent un header spécial : <code>X-ChromeLogger</code>.</p>
<p>Pour réparer cela, vous devez installer une extension comme <a href="https://chrome.google.com/webstore/detail/modify-headers-for-google/innpjfdalfhpcoinfnehdnbkglpmogdi" target="_blank" rel="external">Modify Headers for Google Chrome</a>.</p>
<p>Veuillez noter que cette extension envoie à chaque requête, <strong>que vous soyiez sur votre site web avec webappender ou non</strong>, les entêtes spécifiques que vous avez rajouté. La publication des entêtes spécifiques vers les serveurs est donc très large.</p>
<p>Une alternative à <em>Modify Headers for Google Chrome</em>, est l’extension <a href="https://chrome.google.com/webstore/detail/modheader/idgpnmonknjnojddfkpgkljpfnnfcklj" target="_blank" rel="external">ModHeader</a>, qui permet <strong>par site</strong> de définir les headers à modifier ou rajouter.</p>
<p><img src="/images/modify_headers_chrome.png" alt="header à ajouter pour activer chrome logger"></p>
<p>Quand l’installation et la configuration de cette nouvelle extension est effective, appuyez sur la touche <code>F12</code> de votre clavier, pour visualiser le panel <em>console</em> de Chrome. Cela vous montrera les logs engendrées par votre navigation sur la webapp. </p>
<p><img src="/images/chrome_logger2.png" alt="logs affichées dans la console chrome logger"></p>
<p>Voici le détail de ce qu’une log contient : </p>
<p><img src="/images/capture_trace.png" alt="détail d&#39;une logs affichée dans la console chrome logger"></p>
<h2 id="Vos-logs-dans-Firefox-via-FireLogger"><a href="#Vos-logs-dans-Firefox-via-FireLogger" class="headerlink" title="Vos logs dans Firefox via FireLogger"></a>Vos logs dans Firefox via FireLogger</h2><p>Vous devez installer le plugin firefox intitulé <a href="https://addons.mozilla.org/fr/firefox/addon/firelogger/" target="_blank" rel="external">FireLogger</a>.</p>
<p>Quand cela est fait, appuyez sur la touche <code>F12</code>, pour visualiser le panneau firebug ; vous devriez voir un nouvel onglet intitulé <em>logger</em>.<br><img src="/images/capture_firelogger.png" alt="logs affichées dans la console firelogger"></p>
<p> Il vous montrera vos logs, suivant leur niveau. Les logs sont transmis à votre navigateur, quand les requêtes contiennnent une entête spéciale construite par le plugin ‘FireLogger’ : <code>X-FireLogger</code>.</p>
<p><img src="/images/capture_fire_logger_2.png" alt="détail de log dans la console firelogger"></p>
<h2 id="Vos-logs-dans-n’importe-quel-navigateur"><a href="#Vos-logs-dans-n’importe-quel-navigateur" class="headerlink" title="Vos logs dans n’importe quel navigateur"></a>Vos logs dans n’importe quel navigateur</h2><p>Si vous ne pouvez ou ne voulez pas installer un plugin firefox ou chrome, ou si vous n’avez aucun de ces navigateurs, vous pouvez tout de même visualiser vos logs dans n’importe quel navigateur. Dans ce cas, vous devez configurer un <code>body formatter</code>.</p>
<p>Pour cela, il faut :</p>
<ul>
<li>transmettre au serveur une entête spéciale : <code>X-BodyLogger</code>, via une extension comme <code>modify headers</code> (disponible sur chrome ou firefox), ou tout autre plugin compatible avec votre navigateur ayant la possibilité d’ajouter à façon une entête spéciale.</li>
</ul>
<p>Pour Internet Explorer, une solution gratuite comme <a href="http://www.telerik.com/fiddler" target="_blank" rel="external">Fiddler</a> permet de modifier les entêtes HTTP.</p>
<p><img src="/images/body_logger.png" alt="header HTTP activant un bodyformatter"></p>
<ul>
<li>installer au début de vos  JSP, la declaration de la taglib, et à la fin de vos JSP, le tag webappender. Si vous utilisez une librairie de templating (comme <code>sitemesh</code> par  example), une unique insertion dans un decorateur global aura un effet sur toutes vos JSP.</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">page</span> <span class="attr">contentType</span>=<span class="string">"text/html;charset=UTF-8"</span> <span class="attr">language</span>=<span class="string">"java"</span> %&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">taglib</span> <span class="attr">prefix</span>=<span class="string">"debug"</span> <span class="attr">uri</span>=<span class="string">"https://github.com/clescot/webappender-tag"</span>%&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">title</span>&gt;</span>hello from test.jsp page<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">test.jsp</div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">debug:webappender</span>/&gt;</span></div></pre></td></tr></table></figure>
<p>Avantages de cette méthode :</p>
<ul>
<li>Les logs sont présentes dans le corps de la requête et non l’entête, (2Gb semble être la limite pour le corps d’une requête HTTP) ; il n’y a donc pas de réel problème de taille de logs</li>
<li>cela fonctionne sur tous les navigateurs</li>
</ul>
<p>Inconvénients de cette méthode :</p>
<ul>
<li>cela modifie le corps de votre requête</li>
<li>il n’y a pas de visualisation soignée de ces logs contrairement aux plugins présentés précédemment</li>
<li>vous ne pouvez pas filtrer vos logs du côté navigateur</li>
</ul>
<h1 id="Test-avec-une-webapp-exemple"><a href="#Test-avec-une-webapp-exemple" class="headerlink" title="Test avec une webapp exemple"></a>Test avec une webapp exemple</h1><p>Vous pouvez tester l’application de démo, qui illustre les fonctionnalités de la librairie webappender.</p>
<h3 id="Pre-requis-du-test"><a href="#Pre-requis-du-test" class="headerlink" title="Pré-requis du test"></a>Pré-requis du test</h3><ul>
<li>client <a href="http://git-scm.com/" target="_blank" rel="external">git</a>.</li>
<li><a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" target="_blank" rel="external">java 7</a></li>
<li><a href="http://maven.apache.org" target="_blank" rel="external">maven 3</a> ou supérieur</li>
<li>un navigateur web</li>
</ul>
<h3 id="Installer-la-demo"><a href="#Installer-la-demo" class="headerlink" title="Installer la démo"></a>Installer la démo</h3><p>Tapez ces commandes dans votre terminal :<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git <span class="built_in">clone</span> git@github.com:clescot/webappender.git</div><div class="line"><span class="built_in">cd</span> webappender/webappender-war-example</div><div class="line">mvn org.apache.tomcat.maven:tomcat7-maven-plugin:2.2:run-war -Dwebappender=<span class="literal">true</span></div></pre></td></tr></table></figure></p>
<p>Aller à l’adresse suivante <code>http://127.0.0.1:8080/webappender</code> , et visualiser les logs en fonctions du navigateur choisi, et des entêtes transmises.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>La librairie webappender, permet relativement simplement, de visualiser dans son navigateur, les logs générées par sa requête côté serveur.<br>Webappender peut être installée, sur des applications JEE utilisant logback. </p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-01-18T15:05:00.000Z"><a href="/2014/01/18/2014-01-18-git-pre-push-un-hook-pour-empecher-la-propagation-des-bugs/">18/01/14</a></time>
      
      
  
    <h1 class="title"><a href="/2014/01/18/2014-01-18-git-pre-push-un-hook-pour-empecher-la-propagation-des-bugs/">Git Pre-Push : Un Hook Pour Empêcher La Propagation Des Bugs</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="Etat-des-lieux"><a href="#Etat-des-lieux" class="headerlink" title="Etat des lieux"></a>Etat des lieux</h1><p>Les applications développées comportent inévitablement des bugs.<br>L’erreur étant humaine, cet état de fait ne surprend plus grand monde.</p>
<p>Pour parer à cette situation, sont développés en parallèle toutes sortes de tests, dont les <em>tests unitaires</em>. Nécessaires mais non suffisants, ceux-ci sont généralement les plus rapides à s’exécuter, permettant d’avoir un <strong>feeback rapide</strong>.<br>Leur intérêt n’est plus à démontrer.</p>
<p>Il est navrant en 2014, que des bugs détectés en amont par des tests se propagent.</p>
<h1 id="Une-verification-par-une-chaine-d’integration-continue-centralisee"><a href="#Une-verification-par-une-chaine-d’integration-continue-centralisee" class="headerlink" title="Une vérification par une chaîne d’intégration continue centralisée ?"></a>Une vérification par une chaîne d’intégration continue centralisée ?</h1><p>Le premier réflexe pour régler ce problème, est d’utiliser les outils déjà en place. Un des outils qui s’est généralisé, est une chaîne d’intégration continue centralisée, type <a href="http://jenkins-ci.org" target="_blank" rel="external">jenkins</a>. Cela permet de détecter un bug quand l’exécution des tests unitaires du build échoue.</p>
<p>Cette solution permet d’éviter de propager des bugs en production, l’équipe ne livrant que si le traitement sur la chaîne d’intégration continue s’exécute avec succès.</p>
<p>Néanmoins, <strong>la vérification par la chaîne d’intégration centralisée ne prévient pas la propagation du bug aux autres membres de l’équipe qui travaillent sur la même branche”</strong>, car le code a été poussé sur le repository distant. Les autres développeurs et jenkins se synchronisent ensuite sur ce même repository déjà buggé.</p>
<p>Le <em>feedack</em> vers l’équipe est donc <strong>trop tardif</strong> !<br>Essayons de trouver une autre approche, permettant d’avoir un feedback beaucoup plus court.</p>
<h1 id="Une-verification-par-une-chaine-d’integration-continue-decentralisee"><a href="#Une-verification-par-une-chaine-d’integration-continue-decentralisee" class="headerlink" title="Une vérification par une chaîne d’intégration continue décentralisée !"></a>Une vérification par une chaîne d’intégration continue décentralisée !</h1><p>Le but de cette approche, est de contrôler <strong>au plus tôt</strong> le code, avant de le propager au sein de l’équipe. Ce contrôle doit s’effectuer avant tout partage.</p>
<h2 id="Un-hook-sur-push"><a href="#Un-hook-sur-push" class="headerlink" title="Un hook sur push"></a>Un hook sur push</h2><p>J’utilise depuis quelques semaines, une solution chez un client permettant d’exécuter les tests unitaires via Maven (<code>mvn clean test</code>) lors de la commande <code>git push</code>.</p>
<p>Depuis la version <em>1.8.2</em> de git  apparue en mars 2013, le déclenchement d’un hook est maintenant possible sur un push.<br>Un Hook (crochet en français ?), est un moyen d’exécuter un script personnalisé à certains moments (commit, push, merge, etc..). Il s’exécute avant l’action en question, et conditionne l’exécution de celle-ci.</p>
<p>Au passage, vous pouvez connaître votre version de git en exécutant la commande <code>git --version</code>.</p>
<p>Les hooks sont situés dans le sous-répertoire <code>hooks</code> du répertoire caché <code>.git</code> de votre repository. Des exemples de hook, finissant par <code>sample</code> sont déjà présents.</p>
<p>J’utilise le hook défini par <a href="http://blog.ittybittyapps.com/blog/2013/09/03/git-pre-push/" target="_blank" rel="external">itty bitty labs</a>, en exécutant les tests unitaires via maven  : </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash </span></div><div class="line"></div><div class="line">CMD=<span class="string">"mvn clean test"</span> <span class="comment"># Command that runs your tests</span></div><div class="line"></div><div class="line"><span class="comment"># Check if we actually have commits to push</span></div><div class="line">commits=`git <span class="built_in">log</span> @&#123;u&#125;..`</div><div class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$commits</span>"</span> ]; <span class="keyword">then</span></div><div class="line">    <span class="built_in">exit</span> 0</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line">current_branch=$(git symbolic-ref HEAD | sed <span class="_">-e</span> <span class="string">'s,.*/\(.*\),\1,'</span>)</div><div class="line"></div><div class="line"><span class="variable">$CMD</span></div><div class="line">RESULT=$?</div><div class="line"><span class="keyword">if</span> [ <span class="variable">$RESULT</span> <span class="_">-ne</span> 0 ]; <span class="keyword">then</span> </div><div class="line">       <span class="built_in">echo</span> <span class="string">"failed <span class="variable">$CMD</span>"</span></div><div class="line">       <span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="built_in">exit</span> 0</div></pre></td></tr></table></figure>
<p>Placez ce script intitulé <code>pre-push</code> dans le répertoire <code>hooks</code>.</p>
<p>Ayant des tests d’intégration qui peuvent être longs, seuls les tests unitaires sont exécutés à chaque push.<br>Ainsi, {“le Hook sur push permet d’éviter la propagation des bugs vers les autres membres de l’équipe, mais bloque le développement lors de son exécution”}.</p>
<p>Pour résumer, cette solution : </p>
<ul>
<li>ne s’enclenche que sur un git push</li>
<li>est bloquante</li>
</ul>
<p>Elle s’adapte bien à mon usage, car il peut m’arriver d’effectuer des commit sur une branche, en cassant des tests unitaires de façon transitoire lors de refactorings. Néanmoins, il existe des situations où il est préférable de désactiver un hook.</p>
<p>Git permet cela sur <a href="http://git-scm.com/book/fr/Personnalisation-de-Git-Crochets-Git" target="_blank" rel="external">tous les hooks git</a> via l’option <code>no-verify</code> : </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git push origin mabranche --no-verify</div></pre></td></tr></table></figure>
<h2 id="Un-hook-sur-commit-avec-un-repository-local-cache"><a href="#Un-hook-sur-commit-avec-un-repository-local-cache" class="headerlink" title="Un hook sur commit avec un repository local caché"></a>Un hook sur commit avec un repository local caché</h2><p><a href="http://www.leszindeps.fr/p/David/Gageot/8aa5af7b3ad8ac1d013ad9ae27a60000" target="_blank" rel="external">David Gageot</a>, proposait déjà cette approche de <a href="http://blog.javabien.net/2009/12/01/serverless-ci-with-git/" target="_blank" rel="external">chaîne d’intégration continue décentralisée</a> sur son blog en 2009, mais via une autre solution. </p>
<p>Sa solution est à base de hook git sur un commit. Ce hook clone le repository local dans un répertoire caché , et exécute les tests avant de valider le commit. En cas de succès, il propage le code sur le repository local initial. </p>
<p><strong>Le hook sur commit permet une détection des bugs très tôt, et ne perturbe pas la fluidité du développement</strong>.</p>
<p>Pour résumer, cette solution : </p>
<ul>
<li>est basée sur un hook déclenché sur un commit</li>
<li>est non-bloquante</li>
</ul>
<p>Ainsi, elle permet de ne pas attendre le résultat des tests pour continuer à développer.</p>
<p>La solution de David Gageot, permet un contrôle <strong>plus tôt</strong> par rapport au hook sur git push, avec pour contrepartie la nécessité d’effectuer des commits plus rigoureux.</p>
<p>Il ne faut donc pas sortir des clous lors de chaque commit, quitte à exceptionellement désactiver le hook via l’option <code>no-verify</code> citée plus haut (option valide sur tous les hooks).</p>
<p>Effectivement, les commits sous git étant fréquents, il pourrait être désagréable d’être bloqué en attendant le résultat de tests unitaires de nombreuses fois par jour. La solution du clone du repository local dans un répertoire caché est une solution élégante, car elle permet de ne pas être bloqué dans ses développements.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Si vous êtes très rigoureux, utilisez donc la solution proposée par David Gageot. Si vous n’êtes pas en situation de le faire sur votre projet, peut-être que l’approche <em>hook sur git push</em> répondra à votre besoin.<br>J’espère qu’un de ces hooks vous permettra d’éviter la propagation de bugs vers vos collègues.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-10-11T05:16:00.000Z"><a href="/2013/10/11/2013-10-11-metrics-pour-mesurer-efficacement-les-performances-integration-avec-JDBC-logback-et-jersey/">11/10/13</a></time>
      
      
  
    <h1 class="title"><a href="/2013/10/11/2013-10-11-metrics-pour-mesurer-efficacement-les-performances-integration-avec-JDBC-logback-et-jersey/">Metrics, Pour Mesurer Efficacement Les Performances : Intégration Avec JDBC, Logback Et Jersey</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="Presentation-de-Metrics"><a href="#Presentation-de-Metrics" class="headerlink" title="Présentation de Metrics"></a>Présentation de Metrics</h1><p>Je vous propose dans cette série de 4 articles, de vous présenter la librairie <a href="https://github.com/codahale/metrics" target="_blank" rel="external">Metrics</a>,<br>initié par la société <a href="https://www.yammer.com/" target="_blank" rel="external">Yammer</a>.<br>Celle-ci permet de fournir des métriques au niveau applicatif et JVM.</p>
<p>Ce quatrième article, présente l’intégration de Metrics avec les drivers JDBC, logback et jersey.</p>
<h1 id="avec-les-drivers-JDBC"><a href="#avec-les-drivers-JDBC" class="headerlink" title="avec les drivers JDBC"></a>avec les drivers JDBC</h1><p>La librairie <code>JDBCMetrics</code> intégre JDBC avec Metrics. Cela permet : </p>
<ul>
<li>d’avoir une vision globale de la charge de la base de données issue de votre application</li>
<li>d’avoir une vision précise du nombre et des performances des requêtes SQL pour chaque requête HTTP</li>
</ul>
<p>Pour rajouter ce module à votre application, il faut rajouter la dépendance suivante à votre fichier maven <code>pom.xml</code>:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.soulgalore<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdbcmetrics<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>La vision globale de la charge de la base de données induite par l’application est possible via la configuration du driver JDBC, soit via un <code>Datasource</code> (la librairie jouant le rôle de proxy), soit via le <code>DriverManager</code>.</p>
<p>Au passage DriverManager est une classe dépréciée, ayant un comportement incohérent au niveau du chargement du driver. Préférez donc le Datasource.</p>
<p>La vision précise de la charge au niveau base de données par requête HTTP, est permise de façon optionnelle via l’installation d’un servlet filter :<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">filter&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>JDBCMetricsFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span></div><div class="line">        com.soulgalore.jdbcmetrics.filter.JDBCMetricsFilter</div><div class="line">    <span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>use-headers<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>request-header-name<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>jdbcmetrics<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>JDBCMetricsFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>Pour avoir la mesure de la charge occasionnée par requête HTTP, il faut dans celle-ci mettre le header suivant :</p>
<p><code>jdbcmetrics=yes</code></p>
<p>La requête HTTP devra donc comporter cette entête supplémentaire, afin d’avoir une réponse incluant des entêtes spécifiques<br>à JDBC.</p>
<p>voici un exemple de requête HTTP ayant cette entête (via l’extension Firefox RESTClient), ainsi que les entêtes de la réponse : </p>
<img src="/images/jdbc-metrics-custom-header.png" class="[center]" title="requête HTTP pour jdbcmetrics">
<p>Les Métriques JDBC sont bien sûr visualisables via les reporters (ici via JMX) :</p>
<img src="/images/metrics-jdbc.png" class="[center]" title="métriques du driver JDBC">
<p><a href="https://github.com/clescot/metrics-example" target="_blank" rel="external">L’application exemple de cette série d’articles</a>, intègre Metrics et Guice, ainsi que JDBCMetrics.</p>
<p>Voici un exemple de module Guice, permettant d’installer le proxy JDBCMetrics entre le pool de connexions de la base et l’application : </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.clescot.rest;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.google.inject.Binder;</div><div class="line"><span class="keyword">import</span> com.google.inject.Module;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.sql.DataSource;</div><div class="line"><span class="keyword">import</span> java.sql.Connection;</div><div class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</div><div class="line"><span class="keyword">import</span> java.sql.SQLException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JDBCMetricsModule</span> <span class="keyword">implements</span> <span class="title">Module</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String JDBC_H2_URL = <span class="string">"jdbc:h2:mem:test"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String USERNAME = <span class="string">"sa"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PASSWORD = <span class="string">""</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CREATE_TABLE_FOR_AUDIT = <span class="string">"create table ACTIVITY (ID INTEGER auto_increment,STARTTIME datetime, ENDTIME datetime,  ACTIVITY_NAME VARCHAR(200),PRIMARY KEY (ID) )"</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Binder binder)</span> </span>&#123;</div><div class="line">        org.apache.tomcat.jdbc.pool.DataSource h2DataSource = <span class="keyword">new</span> org.apache.tomcat.jdbc.pool.DataSource();</div><div class="line">        h2DataSource.setUrl(JDBC_H2_URL);</div><div class="line">        h2DataSource.setUsername(USERNAME);</div><div class="line">        h2DataSource.setPassword(PASSWORD);</div><div class="line">        h2DataSource.setDriverClassName(org.h2.Driver.class.getName());</div><div class="line">        <span class="keyword">try</span>(Connection connection = h2DataSource.getConnection())&#123;</div><div class="line">            PreparedStatement preparedStatement = connection.prepareStatement(CREATE_TABLE_FOR_AUDIT);</div><div class="line">            preparedStatement.execute();</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">        &#125;</div><div class="line">        com.soulgalore.jdbcmetrics.DataSource metricsDataSourceProxy = <span class="keyword">new</span> com.soulgalore.jdbcmetrics.DataSource(h2DataSource);</div><div class="line">        binder.bind(DataSource.class).toInstance(metricsDataSourceProxy);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="avec-Logback"><a href="#avec-Logback" class="headerlink" title="avec Logback"></a>avec Logback</h1><p>Metrics fournit une librairie d’intégration avec logback, pour remonter des informations concernant la fréquence des évenements logués <strong>suivant le niveau de log</strong>.</p>
<p>Pour intégrer Metrics et logback, il faut rajouter la dépendance suivante dans votre fichier <code>pom.xml</code> :<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.codahale.metrics<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>metrics-logback<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>Voici le code à utiliser pour lier Metrics à logback.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> LoggerContext factory = (LoggerContext) LoggerFactory.getILoggerFactory();</div><div class="line"><span class="keyword">final</span> Logger root = factory.getLogger(Logger.ROOT_LOGGER_NAME);</div><div class="line"></div><div class="line"><span class="keyword">final</span> InstrumentedAppender metrics = <span class="keyword">new</span> InstrumentedAppender(registry);</div><div class="line">metrics.setContext(root.getLoggerContext());</div><div class="line">metrics.start();</div><div class="line">root.addAppender(metrics);</div></pre></td></tr></table></figure>
<p>Une application concrète de cette intégration pourrait être une surveillance d’évenements logués en erreur ou warning, afin de réagir rapidement quand ceux-ci surviennent avec une fréquence importante.</p>
<p>Voici comment installer une mesure concernant les logs ayant le niveau <code>error</code> dans logback :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">registry.meter(<span class="string">"ch.qos.logback.core.Appender.error"</span>);</div></pre></td></tr></table></figure>
<p>A noter qu’une intégation avec log4J existe aussi.</p>
<h1 id="avec-Jersey"><a href="#avec-Jersey" class="headerlink" title="avec Jersey"></a>avec Jersey</h1><p>Pour intégrer les mesures de Metrics avec les services REST exposés via Jersey et Spring, il est nécessaire d’intégrer le module suivant à votre fichier <code>pom.xml</code> :<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yammer.metrics<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>metrics-jersey<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="Serialisation-du-registre-Metrics-en-JSON-via-jackson"><a href="#Serialisation-du-registre-Metrics-en-JSON-via-jackson" class="headerlink" title="Sérialisation du registre Metrics en JSON via jackson"></a>Sérialisation du registre Metrics en JSON via jackson</h2><p>Le module maven <code>metrics-json</code>, permet de sérialiser facilement les mesures au format JSON, via des modules Jackson dédiés.</p>
<p>l’ajout de la dépendance suivante dans votre <code>pom.xml</code> permet de les utiliser : </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;com.codahale.metrics&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;metrics-json&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;3.0.1&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<p>De plus, vous devez créer une ressource REST, qui va exposer la représentation JSON de votre registre Metrics comme dans l’exemple suivant : </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Path</span>(<span class="string">"/"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FooResource</span> </span>&#123;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper().registerModules(</div><div class="line">            <span class="keyword">new</span> com.codahale.metrics.json.MetricsModule(TimeUnit.SECONDS, TimeUnit.MILLISECONDS, <span class="keyword">false</span>),<span class="keyword">new</span> HealthCheckModule());</div><div class="line"><span class="keyword">private</span> MetricRegistry registry;</div><div class="line"></div><div class="line">    <span class="meta">@Inject</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FooResource</span><span class="params">(MetricRegistry registry)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.registry = registry;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Path</span>(<span class="string">"/metrics"</span>)</div><div class="line">    <span class="meta">@GET</span></div><div class="line">    <span class="meta">@Produces</span>(MediaType.APPLICATION_JSON)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">serializeMetricsRegistryInJSON</span><span class="params">()</span> <span class="keyword">throws</span> JsonProcessingException </span>&#123;</div><div class="line">        <span class="keyword">return</span> mapper.writeValueAsString(registry);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Ainsi, cette ressource JAX-RS exposera sur l’url <a href="http://monhost:8080/metrics" target="_blank" rel="external">http://monhost:8080/metrics</a> en GET une représentation JSON du registre Metrics.</p>
<p>Une exposition de ces métriques peut être utile, pour par exemple, une page de supervision habillant ces métriques avec du javascript.</p>
<h2 id="conclusion"><a href="#conclusion" class="headerlink" title="conclusion"></a>conclusion</h2><p>La librairie Metrics est très pratique. Son usage s’est largement répandu, ce qui se traduit par la présence de librairies tierces afin d’enrichir son usage. Les 4 articles de cette série vous ont permis j’espère, de vous familiariser avec cette librairie.<br>J’ai mis en place cette solution chez un de mes clients, en envoyant les informations de Metrics vers un serveur Graphite, pour une historisation pérenne, et un travail à postériori sur les métriques techniques ou fonctionnelles remontées.</p>
<p>Afin de distinguer les métriques des différents environnements (poste de développement, recette, pre-production, production…), remontées vers le même serveur, j’ai mis en place un <code>ServletContextListener</code> qui configure au démarrage de l’application le reporter Graphite en fonction de variables positionnées au lancement du serveur. Les métriques seront donc présentes dans graphite dans des arborescences séparées, via un préfixe différent.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.clescot.listener;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.servlet.ServletContextEvent;</div><div class="line"><span class="keyword">import</span> javax.servlet.ServletContextListener;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.yammer.metrics.reporting.GraphiteReporter;</div><div class="line"><span class="keyword">import</span> org.slf4j.Logger;</div><div class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MetricsGraphiteContextListener</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_GRAPHITE_HOST = <span class="string">"graphite"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_GRAPHITE_PORT = <span class="string">"2003"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_GRAPHITE_PREFIX = <span class="string">"default.graphite.prefix'"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_GRAPHITE_PERIOD = <span class="string">"1"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(MetricsGraphiteContextListener.class);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> TimeUnit DEFAULT_GRAPHITE_TIME_UNIT = TimeUnit.MINUTES;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String GRAPHITE_HOST_SYSTEM_PROPERTY_KEY = <span class="string">"graphite.host"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String GRAPHITE_PERIOD_SYSTEM_PROPERTY_KEY = <span class="string">"graphite.period"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String GRAPHITE_TIME_UNIT_SYSTEM_PROPERTY_KEY = <span class="string">"graphite.time.unit"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String GRAPHITE_PORT_SYSTEM_PROPERTY_KEY = <span class="string">"graphite.port"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String GRAPHITE_PREFIX_SYSTEM_PROPERTY_KEY = <span class="string">"graphite.prefix"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String JAVA_SYSTEM_PARAMETER_PREFIX = <span class="string">" '-D"</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Overridemetrics</span>-<span class="function">example</span></div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(<span class="keyword">final</span> ServletContextEvent sce)</span> &#123;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> String servletContextName = sce.getServletContext().getServletContextName();</div><div class="line">        </div><div class="line">        String graphiteHost = System.getProperty(GRAPHITE_HOST_SYSTEM_PROPERTY_KEY, DEFAULT_GRAPHITE_HOST);</div><div class="line"></div><div class="line">        Long period = Long.parseLong(System.getProperty(GRAPHITE_PERIOD_SYSTEM_PROPERTY_KEY, DEFAULT_GRAPHITE_PERIOD));</div><div class="line"></div><div class="line">        TimeUnit timeUnit = TimeUnit</div><div class="line">                .valueOf(System.getProperty(GRAPHITE_TIME_UNIT_SYSTEM_PROPERTY_KEY, DEFAULT_GRAPHITE_TIME_UNIT.name()));</div><div class="line"></div><div class="line">        <span class="keyword">int</span> graphitePort = Integer</div><div class="line">                .parseInt(System.getProperty(GRAPHITE_PORT_SYSTEM_PROPERTY_KEY, DEFAULT_GRAPHITE_PORT));</div><div class="line"></div><div class="line">        String graphitePrefix = System.getProperty(GRAPHITE_PREFIX_SYSTEM_PROPERTY_KEY, DEFAULT_GRAPHITE_PREFIX);</div><div class="line"></div><div class="line">        GraphiteReporter.enable(period, timeUnit, graphiteHost, graphitePort, graphitePrefix +<span class="string">"."</span>+servletContextName);</div><div class="line">        LOGGER.info(</div><div class="line">                <span class="string">"graphite reporter enabled : period='&#123;&#125;', timeUnit='&#123;&#125;', graphite host='&#123;&#125;', graphite port='&#123;&#125;', metricsprefix='&#123;&#125;'"</span>,</div><div class="line">                period, timeUnit, graphiteHost, graphitePort, graphitePrefix +<span class="string">"."</span>+servletContextName);</div><div class="line">        LOGGER.info(<span class="string">"to customize graphite options listed above, put in the java command line some of these ones (without simple quotes):"</span>);</div><div class="line">        LOGGER.info(JAVA_SYSTEM_PARAMETER_PREFIX + GRAPHITE_PERIOD_SYSTEM_PROPERTY_KEY + <span class="string">"=yourCustomGraphitePeriod'"</span>);</div><div class="line">        LOGGER.info(</div><div class="line">                JAVA_SYSTEM_PARAMETER_PREFIX + GRAPHITE_TIME_UNIT_SYSTEM_PROPERTY_KEY + <span class="string">"=yourCustomGraphiteTimeUnit'"</span>);</div><div class="line">        LOGGER.info(JAVA_SYSTEM_PARAMETER_PREFIX + GRAPHITE_HOST_SYSTEM_PROPERTY_KEY + <span class="string">"=yourCustomGraphiteHost'"</span>);</div><div class="line">        LOGGER.info(JAVA_SYSTEM_PARAMETER_PREFIX +GRAPHITE_PORT_SYSTEM_PROPERTY_KEY+<span class="string">"=yourCustomGraphitePort'"</span>);</div><div class="line">        LOGGER.info(JAVA_SYSTEM_PARAMETER_PREFIX +GRAPHITE_PREFIX_SYSTEM_PROPERTY_KEY+<span class="string">"=yourCustomGraphitePrefix'"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextDestroyed</span><span class="params">(<span class="keyword">final</span> ServletContextEvent sce)</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="References"><a href="#References" class="headerlink" title="Références"></a>Références</h2><ul>
<li><a href="http://metrics.codahale.com/manual/core/" target="_blank" rel="external">Metrics</a></li>
<li><a href="http://metrics.codahale.com/manual/logback/" target="_blank" rel="external">Logback</a></li>
<li><a href="https://jersey.java.net" target="_blank" rel="external">Jersey</a></li>
<li><a href="https://github.com/soulgalore/jdbcmetrics" target="_blank" rel="external">JDBCMetrics</a></li>
<li><a href="https://github.com/clescot/metrics-example" target="_blank" rel="external">application example liée à cette série d’articles</a></li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-10-11T05:08:00.000Z"><a href="/2013/10/11/2013-10-11-metrics-pour-mesurer-efficacement-les-performances-integration-avec-spring-et-guice/">11/10/13</a></time>
      
      
  
    <h1 class="title"><a href="/2013/10/11/2013-10-11-metrics-pour-mesurer-efficacement-les-performances-integration-avec-spring-et-guice/">Metrics, Pour Mesurer Efficacement Les Performances : Intégration Avec Spring Et Guice</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="Presentation-de-Metrics"><a href="#Presentation-de-Metrics" class="headerlink" title="Présentation de Metrics"></a>Présentation de Metrics</h1><p>Je vous propose dans cette série de 4 articles, de vous présenter la librairie <a href="https://github.com/codahale/metrics" target="_blank" rel="external">Metrics</a>,<br>initié par la société <a href="https://www.yammer.com/" target="_blank" rel="external">Yammer</a>.<br>Celle-ci permet de fournir des métriques au niveau applicatif et JVM.</p>
<p>Ce troisième article, présente l’intégration de Metrics avec les librairies d’injection de dépendances Spring et Guice.</p>
<h1 id="Metrics-avec-Spring-et-Guice"><a href="#Metrics-avec-Spring-et-Guice" class="headerlink" title="Metrics avec Spring et Guice"></a>Metrics avec Spring et Guice</h1><p><a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-integration-avec-jee/">Le deuxième article</a> de cette série consacrée à Metrics, présentait une intégration “legacy” de Metrics dans une application JEE.</p>
<p>Néanmoins, Il existe des librairies qui intègrent facilement Metrics à Spring ou Guice.<br>L’avantage de ces librairies, est qu’elles permettent de simplifier l’usage de Metrics, via des annotations.<br>Les applications utilisant maintenant principalement les containers d’injection de dépendances, votre configuration ressemblera plutôt à un des exemples présentés ci-après.</p>
<h2 id="Avec-Spring"><a href="#Avec-Spring" class="headerlink" title="Avec Spring"></a>Avec Spring</h2><p>Une librairie tierce permet l’intégration facile de Metrics avec les applications utilisant Spring (cette librairie supporte, au moment où j’écris l’article, la version 3.x de Metrics, contrairement à la librairie intégrant Metrics et Guice).</p>
<p>Au choix, soit la configuration via un fichier XML, soit par des annotations permet d’intégrer les deux librairies. Cette configuration nous permettra d’annoter nos classes hébergeant les métriques.</p>
<p>Il faut rajouter la dépendance suivante à votre fichier maven <code>pom.xml</code> :<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ryantenney.metrics<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>metrics-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h3 id="la-configuration-Spring-via-xml"><a href="#la-configuration-Spring-via-xml" class="headerlink" title="la configuration Spring via xml"></a>la configuration Spring via xml</h3><p>La configuration en xml, de l’intégration des deux librairies se fait comme suit :<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">       <span class="attr">xmlns:metrics</span>=<span class="string">"http://www.ryantenney.com/schema/metrics"</span></div><div class="line">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></div><div class="line">            http://www.springframework.org/schema/beans</div><div class="line">            http://www.springframework.org/schema/beans/spring-beans-3.2.xsd</div><div class="line">            http://www.ryantenney.com/schema/metrics</div><div class="line">            http://www.ryantenney.com/schema/metrics/metrics-3.0.xsd"&gt;</div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- registry and reporters should be defined in only one context xml file --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">metrics:metric-registry</span> <span class="attr">id</span>=<span class="string">"registry"</span> <span class="attr">name</span>=<span class="string">"springMetrics"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">metrics:reporter</span> <span class="attr">type</span>=<span class="string">"console"</span> <span class="attr">metric-registry</span>=<span class="string">"registry"</span> <span class="attr">period</span>=<span class="string">"1m"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- annotation-driven must be included in all context files --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">metrics:annotation-driven</span> <span class="attr">metric-registry</span>=<span class="string">"registry"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- beans --&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>Comme indiqué dans les commentaires du xml précédent (<a href="https://github.com/ryantenney/metrics-spring" target="_blank" rel="external">issu de la documentation du module d’intégration</a>), la déclaration du registre et des reporters doit être réalisée dans un seul fichier xml, tandis que la balise liée aux annotations doit être présente dans chaque fichier xml spring.</p>
<h3 id="la-configuration-Spring-via-des-annotations"><a href="#la-configuration-Spring-via-des-annotations" class="headerlink" title="la configuration Spring via des annotations"></a>la configuration Spring via des annotations</h3><p>De façon alternative, l’intégration se réalise en javaConfig comme suit : </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@EnableMetrics</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringConfiguringClass</span> <span class="keyword">extends</span> <span class="title">MetricsConfigurerAdapter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> MetricRegistry <span class="title">getMetricRegistry</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> SharedMetricRegistries.getOrCreate(<span class="string">"springMetrics"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureReporters</span><span class="params">(MetricRegistry metricRegistry)</span> </span>&#123;</div><div class="line">        ConsoleReporter.forRegistry(registry)</div><div class="line">            .outputTo(output)</div><div class="line">            .build()</div><div class="line">            .start(<span class="number">1</span>, TimeUnit.MINUTES);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Cette intégration permet de : </p>
<ul>
<li>créer les métriques sur les méthodes des beans via les annotations <code>@Timed</code>, <code>@Metered</code>, <code>@ExceptionMetered</code>, and <code>@Counted</code>.</li>
<li>créer des jauges sur les membres des beans spring annotés avec <code>@Gauge</code></li>
<li>injecter via spring les variables représentant les métriques via l’annotation <code>@InjectMetric</code></li>
<li>insérer, dans le registre spécifique des healthchecks, toute classe étendant la classe <code>HealthCheck</code></li>
<li>créer des reporters Metrics et les lier au cycle de vie de Spring</li>
</ul>
<p>Une fois l’intégration de Metrics via Spring réalisée, il devient très aisé via des annotations de rajouter des métriques à notre application. </p>
<p>Exemple de classe annotée : </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</div><div class="line">                <span class="meta">@Timed</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">timedMethod</span><span class="params">()</span></span>&#123;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Metered</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">meteredMethod</span><span class="params">()</span> </span>&#123;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">                <span class="meta">@Counted</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">countedMethod</span><span class="params">()</span> </span>&#123;</div><div class="line">                &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Avec-Guice"><a href="#Avec-Guice" class="headerlink" title="Avec Guice"></a>Avec Guice</h2><p><a href="https://github.com/clescot/metrics-example" target="_blank" rel="external">l’application web exemple liée à cet article</a>, montre l’intégration de Metrics avec une application utilisant le framework d’injection de dépendances Guice.</p>
<p>L’application utilise Metrics 3.0.1, via une librairie <code>metrics-guice</code> qui n’a pas encore de version stable (à l’heure où j’écris cette article) supportant Metrics 3.x. J’ai donc forké le repository de metrics-guice pour juste upgrader la dépendence de Metrics vers la version 3.0.1. <a href="https://github.com/clescot/metrics-guice" target="_blank" rel="external">Un repository metrics-guice dépendant de Metrics 3.0.1 a été crée pour cette occasion</a>.</p>
<p>Classiquement, l’intégration de Guice dans une webapp se réalise via l’installation d’un servletListener étendant <code>GuiceServletContextListener</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.clescot.rest;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.codahale.metrics.ConsoleReporter;</div><div class="line"><span class="keyword">import</span> com.codahale.metrics.JmxReporter;</div><div class="line"><span class="keyword">import</span> com.codahale.metrics.MetricRegistry;</div><div class="line"><span class="keyword">import</span> com.codahale.metrics.health.HealthCheckRegistry;</div><div class="line"><span class="keyword">import</span> com.codahale.metrics.servlets.HealthCheckServlet;</div><div class="line"><span class="keyword">import</span> com.codahale.metrics.servlets.MetricsServlet;</div><div class="line"><span class="keyword">import</span> com.google.inject.Guice;</div><div class="line"><span class="keyword">import</span> com.google.inject.Injector;</div><div class="line"><span class="keyword">import</span> com.google.inject.servlet.GuiceServletContextListener;</div><div class="line"><span class="keyword">import</span> com.palominolabs.metrics.guice.InstrumentationModule;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.servlet.ServletContext;</div><div class="line"><span class="keyword">import</span> javax.servlet.ServletContextEvent;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GuiceContextListener</span> <span class="keyword">extends</span> <span class="title">GuiceServletContextListener</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> ServletContext servletContext;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(ServletContextEvent servletContextEvent)</span> </span>&#123;</div><div class="line">        servletContext = servletContextEvent.getServletContext();</div><div class="line">        <span class="keyword">super</span>.contextInitialized(servletContextEvent);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Injector <span class="title">getInjector</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        Injector injector = Guice.createInjector(<span class="keyword">new</span> HealthCheckModule(), <span class="keyword">new</span> RESTModule(), <span class="keyword">new</span> InstrumentationModule(),</div><div class="line">                <span class="keyword">new</span> JDBCMetricsModule()</div><div class="line">        );</div><div class="line"></div><div class="line">        <span class="comment">//register registries in ServletContext</span></div><div class="line">        MetricRegistry metricRegistry = injector.getInstance(MetricRegistry.class);</div><div class="line">        HealthCheckRegistry healthCheckRegistry = injector.getInstance(HealthCheckRegistry.class);</div><div class="line">        servletContext.setAttribute(MetricsServlet.METRICS_REGISTRY, metricRegistry);</div><div class="line">        servletContext.setAttribute(HealthCheckServlet.HEALTH_CHECK_REGISTRY, healthCheckRegistry);</div><div class="line"></div><div class="line">        <span class="comment">//configure reporters</span></div><div class="line">        JmxReporter.forRegistry(metricRegistry).build().start();</div><div class="line">        ConsoleReporter.forRegistry(metricRegistry).build().start(<span class="number">10</span>, TimeUnit.SECONDS);</div><div class="line">        <span class="keyword">return</span> injector;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Un HealthCheckModule a été crée :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.clescot.rest;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.codahale.metrics.health.HealthCheck;</div><div class="line"><span class="keyword">import</span> com.google.inject.multibindings.Multibinder;</div><div class="line"><span class="keyword">import</span> com.google.inject.servlet.ServletModule;</div><div class="line"><span class="keyword">import</span> com.palominolabs.metrics.guice.servlet.AdminServletModule;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HealthCheckModule</span> <span class="keyword">extends</span> <span class="title">ServletModule</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configureServlets</span><span class="params">()</span> </span>&#123;</div><div class="line">        install(<span class="keyword">new</span> AdminServletModule());</div><div class="line">        Multibinder&lt;HealthCheck&gt; healthChecksBinder = Multibinder.newSetBinder(binder(), HealthCheck.class);</div><div class="line">        healthChecksBinder.addBinding().to(DatabaseHealthCheck.class);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Les deux autres modules (cf l<a href="https://github.com/clescot/metrics-example" target="_blank" rel="external">es sources de l’application exemple</a>) correspondent à : </p>
<ul>
<li>l’enregistrement des ressources REST dans Guice (<code>RESTModule</code>)</li>
<li>la configuration de la base de données et son monitoring (<code>JDBCMetricsModule</code>)</li>
<li>un module pour lier Metrics et Guice (<code>InstrumentationModule</code>). </li>
</ul>
<p>Vous noterez l’intégration d’un <code>JMXReporter</code>, et d’un <code>ConsoleReporter</code> dans cette configuration, qui envoie dans la sortie standard toutes les 10 secondes (à des fins de test), un descriptif des métriques.</p>
<p>Les ressources REST créées et les servlets Metrics disponibles seront référencées dans le fichier <code>web.xml</code> (ou de façon alternative via des annotations pour des containers plus récents).</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>Archetype Created Web Application<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>com.clescot.rest.GuiceContextListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>guiceFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.google.inject.servlet.GuiceFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>guiceFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/rest/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>AdminServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.codahale.metrics.servlets.AdminServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>healthcheck<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.codahale.metrics.servlets.HealthCheckServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ping<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.codahale.metrics.servlets.PingServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>metrics<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.codahale.metrics.servlets.MetricsServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>threads<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.codahale.metrics.servlets.ThreadDumpServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>AdminServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/admin<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>healthcheck<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/admin/healthcheck<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ping<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/admin/ping<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>metrics<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/admin/metrics<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>threads<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/admin/threads<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></div></pre></td></tr></table></figure>
<p>Les exemples de code d’une application Guice ayant ces annotations sont présents dans <a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-integration-avec-JDBC-logback-et-jersey/">le dernier article</a> (les annotations sont portées par des ressources Jersey).</p>
<h2 id="conclusion"><a href="#conclusion" class="headerlink" title="conclusion"></a>conclusion</h2><p>L’intégration de la librairie Metrics avec Spring ou Guice se réalise sans réelles difficultés majeures. <a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-integration-avec-JDBC-logback-et-jersey/">Le dernier article de cette série, porte sur l’intégration de librairies tierces, comme Jersey, les drivers JDBC ou logback</a>.</p>
<h2 id="References"><a href="#References" class="headerlink" title="Références"></a>Références</h2><ul>
<li><a href="http://metrics.codahale.com/manual/core/" target="_blank" rel="external">Metrics</a></li>
<li><a href="http://ryantenney.github.io/metrics-spring/" target="_blank" rel="external">Metrics-Spring</a></li>
<li><a href="http://spring.io/" target="_blank" rel="external">Spring</a></li>
<li><a href="http://code.google.com/p/google-guice/" target="_blank" rel="external">Guice</a></li>
<li><a href="https://github.com/clescot/metrics-guice" target="_blank" rel="external">un repository Metrics-guice dépendant de Metrics 3.0.1</a></li>
</ul>
<ul>
<li><a href="https://github.com/clescot/metrics-example" target="_blank" rel="external">application example liée à cette série d’articles</a></li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-10-11T03:01:00.000Z"><a href="/2013/10/11/2013-10-11-metrics-pour-mesurer-efficacement-les-performances-integration-avec-jee/">11/10/13</a></time>
      
      
  
    <h1 class="title"><a href="/2013/10/11/2013-10-11-metrics-pour-mesurer-efficacement-les-performances-integration-avec-jee/">Metrics Pour Mesurer Efficacement Les Performances : Intégration Avec JEE</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="Presentation-de-Metrics"><a href="#Presentation-de-Metrics" class="headerlink" title="Présentation de Metrics"></a>Présentation de Metrics</h2><p>Je vous propose dans cette série de 4 articles, de vous présenter la librairie <a href="https://github.com/codahale/metrics" target="_blank" rel="external">Metrics</a>,<br>initié par la société <a href="https://www.yammer.com/" target="_blank" rel="external">Yammer</a>.<br>Celle-ci permet de fournir des métriques au niveau applicatif et JVM.</p>
<p>Ce deuxième article, présente l’intégration de Metrics dans une application web JEE.<br>A noter que l’intégration proposée n’inclut pas, à des fins pédagogiques, une intégration facilitée via Spring ou Guice, comme c’est le cas dans <a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-integration-avec-spring-guice-logback-et-jersey/">le troisième article de la série</a>.</p>
<h2 id="Integration-dans-une-webapp"><a href="#Integration-dans-une-webapp" class="headerlink" title="Intégration dans une webapp"></a>Intégration dans une webapp</h2><p><a href="https://github.com/clescot/metrics-example" target="_blank" rel="external">Un exemple d’application web monitoré avec Metrics</a> est fourni en complément de cet article.</p>
<h3 id="Enregistrement-du-registre-Metrics-dans-le-scope-application"><a href="#Enregistrement-du-registre-Metrics-dans-le-scope-application" class="headerlink" title="Enregistrement du registre Metrics dans le scope application"></a>Enregistrement du registre Metrics dans le scope application</h3><p>Lors du démarrage de l’application JEE, il est nécessaire d’enregistrer dans le scope <strong>application</strong> (<em>i.e</em> le <em>servletContext</em>), le registre Metrics, pour qu’il soit disponible pour toutes les classes.<br>Nous utiliserons pour cette tâche, un <em>ContextListener</em>, qui est justement exécuté au démarrage de l’application.</p>
<p>Pour faciliter le partage du registre, Metrics fournit un module de classes utilitaires pour les applications JEE, intitulé <code>metrics-servlet</code>.</p>
<p>Installez-donc celui-ci dans votre fichier maven <code>pom.xml</code>.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.codahale.metrics<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>metrics-servlet<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>Une fois cette dépendance installée, vous pouvez étendre le <code>InstrumentedFilterContextListener</code> pour vous faciliter la tâche comme suit : </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.clescot.rest;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.codahale.metrics.MetricRegistry;</div><div class="line"><span class="keyword">import</span> com.codahale.metrics.servlet.InstrumentedFilterContextListener;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MetricsListener</span> <span class="keyword">extends</span> <span class="title">InstrumentedFilterContextListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> MetricRegistry METRIC_REGISTRY = <span class="keyword">new</span> MetricRegistry();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> MetricRegistry <span class="title">getMetricRegistry</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> METRIC_REGISTRY;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>L’installation de la classe MetricsListener effectuée dans votre fichier <code>web.xml</code> comme suit, vous pouvez utiliser les différentes métriques listées dans <a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-les-bases/">le premier article de cette série</a> (jauge, compteur, mesure, histogramme, timer etc…).</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">...</div><div class="line"> <span class="tag">&lt;<span class="name">listener</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>com.clescot.rest.MetricsListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></div><div class="line">...</div><div class="line">...</div></pre></td></tr></table></figure>
<p>Veuillez noter que le module <code>metrics-servlet</code>, n’est pas à confondre avec <code>metrics-servlets</code> évoqué plus loin dans cet article.</p>
<p>Une alternative, présentée dans <a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-integration-avec-spring-et-guice/">le troisième article de cette série</a>, est l’initialisation et l’injection du registre via un container d’injection de dépendances comme <a href="http://projects.spring.io/spring-framework/" target="_blank" rel="external">Spring</a> ou <a href="http://code.google.com/p/google-guice/" target="_blank" rel="external">Guice</a> (<a href="">l’application web exemple</a> utilise Guice). </p>
<h3 id="Health-check"><a href="#Health-check" class="headerlink" title="Health check"></a>Health check</h3><p>Metrics permet aussi d’intégrer un système de “Health check”, afin de surveiller, via des appels du répartiteur de charge (<em>load-balancer</em>), les composants externes sur lesquels repose l’application, tels la base de données, ou le moteur de recherche par exemple.<br>Cela permet d’avoir une idée précise, de la fiabilité de ces composants, et donc de travailler sur la tolérance de l’application aux pannes de ceux-ci.</p>
<p>Cette intégration est réalisée par le module maven intitulé <strong>metrics-healthchecks</strong>.<br>Rajoutez donc dans votre fichier maven <code>pom.xml</code>, la dépendance suivante : </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.codahale.metrics<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>metrics-healthchecks<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<p>Puis il faut étendre la class HealthCheck pour en créer un :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.clescot.rest;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.codahale.metrics.core.HealthCheck;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.inject.Inject;</div><div class="line"><span class="keyword">import</span> javax.sql.DataSource;</div><div class="line"><span class="keyword">import</span> java.sql.Connection;</div><div class="line"><span class="keyword">import</span> java.sql.ResultSet;</div><div class="line"><span class="keyword">import</span> java.sql.SQLException;</div><div class="line"><span class="keyword">import</span> java.sql.Statement;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DatabaseHealthCheck</span> <span class="keyword">extends</span> <span class="title">HealthCheck</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DATABASE_HEALTH_CHECK_NAME = <span class="string">"database"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> DataSource datasource;</div><div class="line"></div><div class="line">    <span class="meta">@Inject</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DatabaseHealthCheck</span><span class="params">(DataSource datasource)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(<span class="string">"com.clescot.rest.DatabaseHealthCheck"</span>);</div><div class="line">        <span class="keyword">this</span>.datasource = datasource;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Result <span class="title">check</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line"></div><div class="line">        HealthCheck.Result result;</div><div class="line">        <span class="keyword">try</span> (Connection connection = datasource.getConnection()) &#123;</div><div class="line">            Statement statement;</div><div class="line">            ResultSet resultSet;</div><div class="line">            statement = connection.createStatement();</div><div class="line">            resultSet = statement.executeQuery(<span class="string">"select 1 from dual"</span>);</div><div class="line">            <span class="keyword">if</span> (resultSet.next()) &#123;</div><div class="line">                result = Result.healthy(<span class="string">"'select 1 from dual' : OK"</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                result = Result.unhealthy(<span class="string">"la requête 'select 1 from dual' retourne un résultat vide : KO"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            result = HealthCheck.Result.unhealthy(<span class="string">"'select 1 from dual' : KO "</span>, t);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>La création et l’enregistrement dans le registre de Metrics du healthcheck peut se faire dans la classe MetricsListener présentée précédemment. Le datasource pourra être récupérée si besoin, via JNDI. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">registry.register(<span class="string">"database"</span>, <span class="keyword">new</span> DatabaseHealthCheck(datasource));</div></pre></td></tr></table></figure>
<p>Enfin, il faut enregistrer dans le fichier <code>web.xml</code>, la servlet appelant les différents healthChecks enregistrés dans le registre, c’est-à-dire la healthCheckServlet :</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">	&lt;servlet&gt;</div><div class="line">&lt;servlet-name&gt;healthcheck&lt;/servlet-name&gt;</div><div class="line">&lt;servlet-class&gt;com.codahale.metrics.servlets.HealthCheckServlet&lt;&lt;/servlet-class&gt;</div><div class="line">&lt;load-on-startup&gt;1&lt;/load-on-startup&gt;</div><div class="line">&lt;/servlet&gt;</div><div class="line">...</div><div class="line"></div><div class="line">&lt;servlet-mapping&gt;</div><div class="line">&lt;servlet-name&gt;healthcheck&lt;/servlet-name&gt;</div><div class="line">&lt;url-pattern&gt;/healthcheck&lt;/url-pattern&gt;</div><div class="line">&lt;/servlet-mapping&gt;</div><div class="line">...</div></pre></td></tr></table></figure>
<p>Le load balancer appelera donc l’url <a href="http://monapplication:8080/healthcheck" target="_blank" rel="external">http://monapplication:8080/healthcheck</a> à intervalles réguliers sur chaque instance de webapp pour s’assurer du bon fonctionnement de tous les noeuds du cluster. </p>
<p>En cas de défaillance, l’instance en question sortira du pool d’instances utilisé pour répondre aux requêtes.</p>
<h3 id="Exposition-des-mesures"><a href="#Exposition-des-mesures" class="headerlink" title="Exposition des mesures"></a>Exposition des mesures</h3><p>Une fois les mesures posées, il faut les exposer, pour pouvoir les visualiser, et donc les analyser. Ce sont les reporters  dans Metrics qui ont cette fonction d’exposition des métriques.</p>
<h4 id="Via-JMX"><a href="#Via-JMX" class="headerlink" title="Via JMX"></a>Via JMX</h4><p>L’exposition des mesures Metrics, peut être réalisée via JMX (<strong>non conseillé par Metrics en production</strong>) par l’installation et l’initialisation d’un reporter spécifique de la façon suivante : </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> JmxReporter reporter = JmxReporter.forRegistry(registry).build();</div><div class="line">reporter.start();</div></pre></td></tr></table></figure>
<p>Cette initialisation pourra aussi être effectuée dans le MetricsListener évoqué précédemment.</p>
<p>L’utilisation d’outils tels <a href="http://docs.oracle.com/javase/7/docs/technotes/guides/management/jconsole.html" target="_blank" rel="external">jconsole</a>, ou <a href="http://visualvm.java.net/" target="_blank" rel="external">visualVM</a>, vous permettra de visualiser les mesures exposées sous forme de MBeans.</p>
<p>Voici un exemple de visualisation des métriques JMX via visualVM :<br>{% img [center] /images/visualvm.png [métriques JMX via visualVM[métriques JMX via visualVM]] %}</p>
<h4 id="Via-HTTP"><a href="#Via-HTTP" class="headerlink" title="Via HTTP"></a>Via HTTP</h4><p>Metrics fournit par défaut, pour les applications JEE, des servlets permettant de sérialiser en HTTP le contenu du registre Metrics.</p>
<p>Pour obtenir ces servlets prêtes à l’emploi, il faut importer le module maven dans votre <code>pom.xml</code> :</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;com.codahale.metrics&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;metrics-servlets&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;3.0.1&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<p>Le module dédie expose les servlets suivantes : </p>
<ul>
<li><code>MetricsServlet</code>: expose les mesures via un objet JSON</li>
</ul>
<p>Voici un exemple du rendu de cette servlet :<br>{% img [center] /images/metrics-http.png [métriques JSON[métriques JSON via MetricsServlet]] %}</p>
<ul>
<li><code>HealthCheckServlet</code> : répond aux requêtes GET en exécutant tous les healthChecks enregistrés dans le registre. Cette classe est utile pour les loadBalancers, pour ne rediriger les requêtes des clients que vers les serveurs en bonne santé. Un code HTTP 200 est retourné en cas de succès, un code HTTP 500 est retourné dans le cas inverse.</li>
<li><code>ThreadDumpServlet</code> : renvoie une représentation textuelle de tous les threads en cours sur la JVM, c’est-à-dire leur état, leur stack trace, les verrous présents etc… Cette servlet est utile à des fins de diagnostic.</li>
<li><code>AdminServlet</code> agrège les services des servlets précédemment listées.</li>
</ul>
<p>Les servlets listés sont certes très utiles pour exploiter une application ou aider au diagnostic d’un problème, mais elles ne sauraient être accessibles à tous. </p>
<p>Il est donc nécessaire, soit via votre serveur web (apache, nginx etc..), soit via votre reverse proxy, ou votre firewall, d’empêcher un accès direct depuis l’extérieur. </p>
<h4 id="via-d’autres-canaux"><a href="#via-d’autres-canaux" class="headerlink" title="via d’autres canaux"></a>via d’autres canaux</h4><p>d’autres reporters sont fournis par la librairie Metrics, pour exporter les métriques suivant différents canaux donc ceux-ci : </p>
<ul>
<li><code>ConsoleReporter</code> pour un export sur la sortie standard</li>
<li><code>Slf4jReporter</code>pour un export via la façade de log <code>SLF4J</code></li>
<li><code>GraphiteReporter</code> pour stocker de façon scalable et pseudo temps-réel les métriques</li>
</ul>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>L’intégration de Metrics dans une application JEE est aisée. Nous verrons dans <a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-integration-avec-spring-et-guice/">le prochain article de la série, une intégration facilitée via Spring ou Guice</a>.</p>
<h2 id="References"><a href="#References" class="headerlink" title="Références"></a>Références</h2><ul>
<li><a href="http://metrics.codahale.com/manual/core/" target="_blank" rel="external">Metrics</a></li>
<li><a href="http://ryantenney.github.io/metrics-spring/" target="_blank" rel="external">Metrics-Spring</a></li>
<li><a href="http://spring.io/" target="_blank" rel="external">Spring</a></li>
<li><a href="http://code.google.com/p/google-guice/" target="_blank" rel="external">Guice</a></li>
<li><a href="https://github.com/clescot/metrics-guice" target="_blank" rel="external">un repository Metrics-guice dépendant de Metrics 3.0.1</a></li>
</ul>
<ul>
<li><a href="https://github.com/clescot/metrics-example" target="_blank" rel="external">application example liée à cette série d’articles</a></li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





<nav id="pagination">
  
  
    <a href="///2/" class="alignright next">Suivant</a>
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Recherche">
    <input type="hidden" name="q" value="site:clescot.com">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">Catégories</h3>
  <ul class="entry">
  
    <li><a href="/categories/performance/mesure/metrique/JDBC/">JDBC</a><small>1</small></li>
  
    <li><a href="/categories/performance/mesure/metrique/JEE/">JEE</a><small>1</small></li>
  
    <li><a href="/categories/debug/jsp/variables/communication/JSON/">JSON</a><small>1</small></li>
  
    <li><a href="/categories/git/productivite/hook/push/integration-continue/TDD/">TDD</a><small>1</small></li>
  
    <li><a href="/categories/kafkacat/kafka/big-data/">big data</a><small>1</small></li>
  
    <li><a href="/categories/kafkacat/kafka/big-data/cli/">cli</a><small>1</small></li>
  
    <li><a href="/categories/logback/web/logs/debug/communication/">communication</a><small>2</small></li>
  
    <li><a href="/categories/debug/jsp/variables/communication/">communication</a><small>1</small></li>
  
    <li><a href="/categories/tempus-fugit/junit/java/tdd/test/parallele/multithread/testng/concurrence/">concurrence</a><small>1</small></li>
  
    <li><a href="/categories/debug/">debug</a><small>1</small></li>
  
    <li><a href="/categories/logback/web/logs/debug/">debug</a><small>2</small></li>
  
    <li><a href="/categories/docker/docker/swarm-mode/scaleway/terraform/devops/">devops</a><small>3</small></li>
  
    <li><a href="/categories/docker/">docker</a><small>3</small></li>
  
    <li><a href="/categories/docker/docker/">docker</a><small>3</small></li>
  
    <li><a href="/categories/git/">git</a><small>1</small></li>
  
    <li><a href="/categories/performance/mesure/metrique/spring/guice/">guice</a><small>1</small></li>
  
    <li><a href="/categories/git/productivite/hook/">hook</a><small>1</small></li>
  
    <li><a href="/categories/git/productivite/hook/push/integration-continue/">intégration continue</a><small>1</small></li>
  
    <li><a href="/categories/junit/java/">java</a><small>1</small></li>
  
    <li><a href="/categories/debug/jsp/variables/communication/JSON/web/java/">java</a><small>1</small></li>
  
    <li><a href="/categories/tempus-fugit/junit/java/">java</a><small>1</small></li>
  
    <li><a href="/categories/performance/mesure/metrique/JDBC/logback/jersey/">jersey</a><small>1</small></li>
  
    <li><a href="/categories/debug/jsp/">jsp</a><small>1</small></li>
  
    <li><a href="/categories/tempus-fugit/junit/">junit</a><small>1</small></li>
  
    <li><a href="/categories/junit/">junit</a><small>1</small></li>
  
    <li><a href="/categories/kafkacat/kafka/">kafka</a><small>1</small></li>
  
    <li><a href="/categories/kafkacat/">kafkacat</a><small>1</small></li>
  
    <li><a href="/categories/logback/">logback</a><small>2</small></li>
  
    <li><a href="/categories/performance/mesure/metrique/JDBC/logback/">logback</a><small>1</small></li>
  
    <li><a href="/categories/logback/web/logs/">logs</a><small>2</small></li>
  
    <li><a href="/categories/performance/mesure/">mesure</a><small>4</small></li>
  
    <li><a href="/categories/tempus-fugit/junit/java/tdd/test/parallele/multithread/">multithread</a><small>1</small></li>
  
    <li><a href="/categories/performance/mesure/metrique/">métrique</a><small>4</small></li>
  
    <li><a href="/categories/junit/java/tdd/organisation/">organisation</a><small>1</small></li>
  
    <li><a href="/categories/kafkacat/kafka/big-data/cli/outil/">outil</a><small>1</small></li>
  
    <li><a href="/categories/tempus-fugit/junit/java/tdd/test/parallele/">parallèle</a><small>1</small></li>
  
    <li><a href="/categories/performance/">performance</a><small>4</small></li>
  
    <li><a href="/categories/git/productivite/">productivité</a><small>1</small></li>
  
    <li><a href="/categories/git/productivite/hook/push/">push</a><small>1</small></li>
  
    <li><a href="/categories/docker/docker/swarm-mode/scaleway/">scaleway</a><small>3</small></li>
  
    <li><a href="/categories/performance/mesure/metrique/spring/">spring</a><small>1</small></li>
  
    <li><a href="/categories/docker/docker/swarm-mode/">swarm mode</a><small>3</small></li>
  
    <li><a href="/categories/debug/jsp/variables/communication/JSON/web/java/tag/">tag</a><small>1</small></li>
  
    <li><a href="/categories/tempus-fugit/junit/java/tdd/">tdd</a><small>1</small></li>
  
    <li><a href="/categories/junit/java/tdd/">tdd</a><small>1</small></li>
  
    <li><a href="/categories/tempus-fugit/">tempus-fugit</a><small>1</small></li>
  
    <li><a href="/categories/docker/docker/swarm-mode/scaleway/terraform/">terraform</a><small>3</small></li>
  
    <li><a href="/categories/junit/java/tdd/organisation/test/">test</a><small>1</small></li>
  
    <li><a href="/categories/tempus-fugit/junit/java/tdd/test/">test</a><small>1</small></li>
  
    <li><a href="/categories/tempus-fugit/junit/java/tdd/test/parallele/multithread/testng/">testng</a><small>1</small></li>
  
    <li><a href="/categories/tempus-fugit/junit/java/tdd/test/parallele/multithread/testng/concurrence/thread-safe/testrule/">testrule</a><small>1</small></li>
  
    <li><a href="/categories/git/productivite/hook/push/integration-continue/TDD/tests/">tests</a><small>1</small></li>
  
    <li><a href="/categories/tempus-fugit/junit/java/tdd/test/parallele/multithread/testng/concurrence/thread-safe/">thread-safe</a><small>1</small></li>
  
    <li><a href="/categories/docker/docker/swarm-mode/scaleway/terraform/devops/ubuntu/">ubuntu</a><small>3</small></li>
  
    <li><a href="/categories/debug/jsp/variables/">variables</a><small>1</small></li>
  
    <li><a href="/categories/debug/jsp/variables/communication/JSON/web/">web</a><small>1</small></li>
  
    <li><a href="/categories/logback/web/">web</a><small>2</small></li>
  
  </ul>
</div>


  
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2017 Charles Lescot
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>

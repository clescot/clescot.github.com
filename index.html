
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Le blog de Charles Lescot.</title>
  <meta name="author" content="Charles Lescot">

  
  <meta name="description" content="Cette série de deux articles décrit le fonctionnement de la librairie de visualisation de logs webappender. Le premier article expose sa mise en &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://clescot.com/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Le blog de Charles Lescot." type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37920903-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Le blog de Charles Lescot.</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:clescot.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/27/webappender-visualisez-les-logs-logback-dans-son-navigateur/">Webappender : Pour Visualiser Les Logs Logback Dans Son Navigateur</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-27T23:46:00+02:00" pubdate data-updated="true">May 27<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Cette série de deux articles décrit le fonctionnement de la librairie de visualisation de logs <a href="https://github.com/clescot/webappender">webappender</a>.</p>

<p>Le premier article expose sa mise en place, et les différentes façons de visualiser les logs suivant son navigateur.</p>

<p>Le deuxième article décrit la façon de choisir le contenu et la taille des logs à afficher.</p>

<h1>Le problème</h1>

<p>Pour des applications web, il est courant de d&#8217;effectuer la recette des fonctionnalités sur des serveurs <strong>distants</strong>.</p>

<p> Quand un comportement non attendu survient, il est nécessaire de retracer le fonctionnement précis de l&#8217;application, notamment via l&#8217;inspection des traces applicatives aussi appelées logs.</p>

<p>Le serveur étant distant, il est souvent nécessaire :</p>

<ul>
<li>de se connecter en ssh sur le bon serveur</li>
<li>d&#8217;identifier le répertoire hébergeant les logs</li>
<li>d&#8217;identifier le bon fichier de logs</li>
<li>de démêler les logs correspondants à son test, des autres logs</li>
</ul>


<p>Ces opérations ne sont pas instantanées et rébarbatives.</p>

<h1>Webappender</h1>

<p>Afin d&#8217;éviter toutes ses étapes, j&#8217;ai créer le webappender, afin que les traces serveur issues de vos requêtes HTTP arrivent directement dans votre navigateur.</p>

<p>Ainsi, les autres logs des requêtes exécutées de façon concurrente sur le serveur, ne sont pas envoyées vers votre navigateur. Le développeur regarde donc <strong>uniquement</strong> les informations qui sont liées à son test.</p>

<h1>Mise en place dans votre application web JEE</h1>

<h2>Pré-requis</h2>

<p>Webappender est compatible avec les applications <a href="http://en.wikipedia.org/wiki/Java_Platform,_Enterprise_Edition">JEE</a> utilisant la librairie de logs <a href="http://logback.qos.ch">logback</a>.
L&#8217;adhérence entre webappender et JEE est minime. Une compatibilité plus large est donc possible.</p>

<h2>Installation en 2 étapes</h2>

<h3>Maven</h3>

<p>Ajouter à votre fichier Maven <code>pom.xml</code> cette dépendance :</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>  <span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>com.clescot<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>      <span class="nt">&lt;artifactId&gt;</span>webappender<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>      <span class="nt">&lt;version&gt;</span>1.4<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p>Notez qu&#8217;un filtre de servlet, installé par annotation, est fourni avec la librairie. Son <em>urlPatterns</em> correspond à toutes les requêtes (<code>/*</code>).</p>

<h3>Activer le webappender</h3>

<p>Par défaut, webappender est <strong>désactivé</strong> .</p>

<p><strong>Permettre de visualiser les logs de chacun (par une interception du réseau), peut être très risqué et dangereux dans des environnements de production</strong>.</p>

<p>Donc, pour prévenir toute erreur de configuration, nous désactivons par défaut le webappender.</p>

<p>Pour l&#8217;activer, vous devez mettre ce paramètre sur la ligne de commande qui lance votre serveur d&#8217;applications :</p>

<pre><code>`-Dwebappender=true`.
</code></pre>

<h1>Visualisation des logs</h1>

<p>La librairie webappender permet de visualiser les logs de sa requête dans tous les navigateurs.
Les visualisations de logs dans les configurations suivantes, impliquent une installation de webappender dans votre application JEE utilisant logback, avec un serveur d&#8217;applications java actif.</p>

<h2>Vos logs dans Chrome via ChromeLogger</h2>

<p>Vous devez installer le plugin chrome intitulé <a href="https://chrome.google.com/webstore/detail/chrome-logger/noaneddfkdjfnfdakjjmocngnfkfehhd">ChromeLogger</a>.</p>

<p>Malheureusement, <em>Chrome logger</em> ne transmet par défaut aucun header l&#8217;identifiant, contrairement à d&#8217;autres plugins.</p>

<p>Or, Webappender transmet les logs à votre navigateur, quand les requêtes contiennent un header spécial : <code>X-ChromeLogger</code>.</p>

<p>Pour réparer cela, vous devez installer une extension comme <a href="https://chrome.google.com/webstore/detail/modify-headers-for-google/innpjfdalfhpcoinfnehdnbkglpmogdi">Modify Headers for Google Chrome</a>.</p>

<p>Veuillez noter que cette extension envoie à chaque requête, <strong>que vous soyiez sur votre site web avec webappender ou non</strong>, les entêtes spécifiques que vous avez rajouté. La publication des entêtes spécifiques vers les serveurs est donc très large.</p>

<p>Une alternative à <em>Modify Headers for Google Chrome</em>, est l&#8217;extension <a href="https://chrome.google.com/webstore/detail/modheader/idgpnmonknjnojddfkpgkljpfnnfcklj">ModHeader</a>, qui permet <strong>par site</strong> de définir les headers à modifier ou rajouter.</p>

<p><img src="/images/modify_headers_chrome.png" alt="header à ajouter pour activer chrome logger" /></p>

<p>Quand l&#8217;installation et la configuration de cette nouvelle extension est effective, appuyez sur la touche <code>F12</code> de votre clavier, pour visualiser le panel <em>console</em> de Chrome. Cela vous montrera les logs engendrées par votre navigation sur la webapp.</p>

<p><img src="/images/chrome_logger2.png" alt="logs affichées dans la console chrome logger" /></p>

<p>Voici le détail de ce qu&#8217;une log contient :</p>

<p><img src="/images/capture_trace.png" alt="détail d'une logs affichée dans la console chrome logger" /></p>

<h2>Vos logs dans Firefox via FireLogger</h2>

<p>Vous devez installer le plugin firefox intitulé <a href="https://addons.mozilla.org/fr/firefox/addon/firelogger/">FireLogger</a>.</p>

<p>Quand cela est fait, appuyez sur la touche <code>F12</code>, pour visualiser le panneau firebug ; vous devriez voir un nouvel onglet intitulé <em>logger</em>.
<img src="/images/capture_firelogger.png" alt="logs affichées dans la console firelogger" /></p>

<p> Il vous montrera vos logs, suivant leur niveau. Les logs sont transmis à votre navigateur, quand les requêtes contiennnent une entête spéciale construite par le plugin &#8216;FireLogger&#8217; : <code>X-FireLogger</code>.</p>

<p><img src="/images/capture_fire_logger_2.png" alt="détail de log dans la console firelogger" /></p>

<h2>Vos logs dans n&#8217;importe quel navigateur</h2>

<p>Si vous ne pouvez ou ne voulez pas installer un plugin firefox ou chrome, ou si vous n&#8217;avez aucun de ces navigateurs, vous pouvez tout de même visualiser vos logs dans n&#8217;importe quel navigateur. Dans ce cas, vous devez configurer un <code>body formatter</code>.</p>

<p>Pour cela, il faut :</p>

<ul>
<li>transmettre au serveur une entête spéciale : <code>X-BodyLogger</code>, via une extension comme <code>modify headers</code> (disponible sur chrome ou firefox), ou tout autre plugin compatible avec votre navigateur ayant la possibilité d&#8217;ajouter à façon une entête spéciale.</li>
</ul>


<p>Pour Internet Explorer, une solution gratuite comme <a href="http://www.telerik.com/fiddler">Fiddler</a> permet de modifier les entêtes HTTP.</p>

<p><img src="/images/body_logger.png" alt="header HTTP activant un bodyformatter" /></p>

<ul>
<li>installer au début de vos  JSP, la declaration de la taglib, et à la fin de vos JSP, le tag webappender. Si vous utilisez une librairie de templating (comme <code>sitemesh</code> par  example), une unique insertion dans un decorateur global aura un effet sur toutes vos JSP.</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>    <span class="err">&lt;</span>%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;
</span><span class='line'>    <span class="err">&lt;</span>%@ taglib prefix=&quot;debug&quot; uri=&quot;https://github.com/clescot/webappender-tag&quot;%&gt;
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;html&gt;</span>
</span><span class='line'>    <span class="nt">&lt;head&gt;</span>
</span><span class='line'>       <span class="nt">&lt;title&gt;</span>hello from test.jsp page<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>    <span class="nt">&lt;body&gt;</span>
</span><span class='line'>    test.jsp
</span><span class='line'>    <span class="nt">&lt;/body&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/html&gt;</span>
</span><span class='line'>    <span class="nt">&lt;debug:webappender/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Avantages de cette méthode :</p>

<ul>
<li>Les logs sont présentes dans le corps de la requête et non l&#8217;entête, (2Gb semble être la limite pour le corps d&#8217;une requête HTTP) ; il n&#8217;y a donc pas de réel problème de taille de logs</li>
<li>cela fonctionne sur tous les navigateurs</li>
</ul>


<p>Inconvénients de cette méthode :</p>

<ul>
<li>cela modifie le corps de votre requête</li>
<li>il n&#8217;y a pas de visualisation soignée de ces logs contrairement aux plugins présentés précédemment</li>
<li>vous ne pouvez pas filtrer vos logs du côté navigateur</li>
</ul>


<h1>Test avec une webapp exemple</h1>

<p>Vous pouvez tester l&#8217;application de démo, qui illustre les fonctionnalités de la librairie webappender.</p>

<h3>Pré-requis du test</h3>

<ul>
<li>client <a href="http://git-scm.com/">git</a>.</li>
<li><a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">java 7</a></li>
<li><a href="http://maven.apache.org">maven 3</a> ou supérieur</li>
<li>un navigateur web</li>
</ul>


<h3>Installer la démo</h3>

<p>Tapez ces commandes dans votre terminal :</p>

<pre><code>git clone git@github.com:clescot/webappender.git
cd webappender/webappender-war-example
mvn org.apache.tomcat.maven:tomcat7-maven-plugin:2.2:run-war -Dwebappender=true
</code></pre>

<p>Aller à l&#8217;adresse suivante <code>http://127.0.0.1:8080/webappender</code> , et visualiser les logs en fonctions du navigateur choisi, et des entêtes transmises.</p>

<h1>Conclusion</h1>

<p>La librairie webappender, permet relativement simplement, de visualiser dans son navigateur, les logs générées par sa requête côté serveur.
Webappender peut être installée, sur des applications JEE utilisant logback.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/01/18/git-pre-push-un-hook-pour-empecher-la-propagation-des-bugs/">Git Pre-push : Un Hook Pour Empêcher La Propagation Des Bugs</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-18T16:05:00+01:00" pubdate data-updated="true">Jan 18<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Etat des lieux</h1>

<p>Les applications développées comportent inévitablement des bugs.
L&#8217;erreur étant humaine, cet état de fait ne surprend plus grand monde.</p>

<p>Pour parer à cette situation, sont développés en parallèle toutes sortes de tests, dont les <em>tests unitaires</em>. Nécessaires mais non suffisants, ceux-ci sont généralement les plus rapides à s&#8217;exécuter, permettant d&#8217;avoir un <strong>feeback rapide</strong>.
Leur intérêt n&#8217;est plus à démontrer.</p>

<p>Il est navrant en 2014, que des bugs détectés en amont par des tests se propagent.</p>

<h1>Une vérification par une chaîne d&#8217;intégration continue centralisée ?</h1>

<p><span class='pullquote-right' data-pullquote='la vérification par la chaîne d&#8217;intégration centralisée ne prévient pas la propagation du bug aux autres membres de l&#8217;équipe qui travaillent sur la même branche'>
Le premier réflexe pour régler ce problème, est d&#8217;utiliser les outils déjà en place. Un des outils qui s&#8217;est généralisé, est une chaîne d&#8217;intégration continue centralisée, type <a href="http://jenkins-ci.org">jenkins</a>. Cela permet de détecter un bug quand l&#8217;exécution des tests unitaires du build échoue.</p>

<p>Cette solution permet d&#8217;éviter de propager des bugs en production, l&#8217;équipe ne livrant que si le traitement sur la chaîne d&#8217;intégration continue s&#8217;exécute avec succès.</p>

<p>Néanmoins, la vérification par la chaîne d&#8217;intégration centralisée ne prévient pas la propagation du bug aux autres membres de l&#8217;équipe qui travaillent sur la même branche, car le code a été poussé sur le repository distant. Les autres développeurs et jenkins se synchronisent ensuite sur ce même repository déjà buggé.</p>

<p>Le <em>feedack</em> vers l&#8217;équipe est donc <strong>trop tardif</strong> !
Essayons de trouver une autre approche, permettant d&#8217;avoir un feedback beaucoup plus court.
</span></p>

<h1>Une vérification par une chaîne d&#8217;intégration continue décentralisée !</h1>

<p>Le but de cette approche, est de contrôler <strong>au plus tôt</strong> le code, avant de le propager au sein de l&#8217;équipe. Ce contrôle doit s&#8217;effectuer avant tout partage.</p>

<h2>Un hook sur push</h2>

<p><span class='pullquote-right' data-pullquote='le Hook sur push permet d&#8217;éviter la propagation des bugs vers les autres membres de l&#8217;équipe, mais bloque le développement lors de son exécution'>
J&#8217;utilise depuis quelques semaines, une solution chez un client permettant d&#8217;exécuter les tests unitaires via Maven (<code>mvn clean test</code>) lors de la commande <code>git push</code>.</p>

<p>Depuis la version <em>1.8.2</em> de git  apparue en mars 2013, le déclenchement d&#8217;un hook est maintenant possible sur un push.
Un Hook (crochet en français ?), est un moyen d&#8217;exécuter un script personnalisé à certains moments (commit, push, merge, etc..). Il s&#8217;exécute avant l&#8217;action en question, et conditionne l&#8217;exécution de celle-ci.</p>

<p>Au passage, vous pouvez connaître votre version de git en exécutant la commande <code>git --version</code>.</p>

<p>Les hooks sont situés dans le sous-répertoire <code>hooks</code> du répertoire caché <code>.git</code> de votre repository. Des exemples de hook, finissant par <code>sample</code> sont déjà présents.</p>

<p>J&#8217;utilise le hook défini par <a href="http://blog.ittybittyapps.com/blog/2013/09/03/git-pre-push/">itty bitty labs</a>, en exécutant les tests unitaires via maven  :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash </span>
</span><span class='line'>
</span><span class='line'><span class="nv">CMD</span><span class="o">=</span><span class="s2">&quot;mvn clean test&quot;</span> <span class="c"># Command that runs your tests</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Check if we actually have commits to push</span>
</span><span class='line'><span class="nv">commits</span><span class="o">=</span><span class="sb">`</span>git log @<span class="o">{</span>u<span class="o">}</span>..<span class="sb">`</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$commits&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">    </span><span class="nb">exit </span>0
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="nv">current_branch</span><span class="o">=</span><span class="k">$(</span>git symbolic-ref HEAD | sed -e <span class="s1">&#39;s,.*/\(.*\),\1,&#39;</span><span class="k">)</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$CMD</span>
</span><span class='line'><span class="nv">RESULT</span><span class="o">=</span><span class="nv">$?</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="nv">$RESULT</span> -ne 0 <span class="o">]</span>; <span class="k">then </span>
</span><span class='line'><span class="k">       </span><span class="nb">echo</span> <span class="s2">&quot;failed $CMD&quot;</span>
</span><span class='line'>       <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="nb">exit </span>0
</span></code></pre></td></tr></table></div></figure>


<p>Placez ce script intitulé <code>pre-push</code> dans le répertoire <code>hooks</code>.</p>

<p>Ayant des tests d&#8217;intégration qui peuvent être longs, seuls les tests unitaires sont exécutés à chaque push.
Ainsi, le Hook sur push permet d&#8217;éviter la propagation des bugs vers les autres membres de l&#8217;équipe, mais bloque le développement lors de son exécution.</p>

<p>Pour résumer, cette solution :</p>

<ul>
<li>ne s&#8217;enclenche que sur un git push</li>
<li>est bloquante</li>
</ul>


<p>Elle s&#8217;adapte bien à mon usage, car il peut m&#8217;arriver d&#8217;effectuer des commit sur une branche, en cassant des tests unitaires de façon transitoire lors de refactorings. Néanmoins, il existe des situations où il est préférable de désactiver un hook.</p>

<p>Git permet cela sur <a href="http://git-scm.com/book/fr/Personnalisation-de-Git-Crochets-Git">tous les hooks git</a> via l&#8217;option <code>no-verify</code> :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git push origin mabranche --no-verify
</span></code></pre></td></tr></table></div></figure>


<p></span></p>

<h2>Un hook sur commit avec un repository local caché</h2>

<p><span class='pullquote-right' data-pullquote='Le hook sur commit permet une détection des bugs très tôt, et ne perturbe pas la fluidité du développement'>
<a href="http://www.leszindeps.fr/p/David/Gageot/8aa5af7b3ad8ac1d013ad9ae27a60000">David Gageot</a>, proposait déjà cette approche de <a href="http://blog.javabien.net/2009/12/01/serverless-ci-with-git/">chaîne d&#8217;intégration continue décentralisée</a> sur son blog en 2009, mais via une autre solution.</p>

<p>Sa solution est à base de hook git sur un commit. Ce hook clone le repository local dans un répertoire caché , et exécute les tests avant de valider le commit. En cas de succès, il propage le code sur le repository local initial.</p>

<p>Le hook sur commit permet une détection des bugs très tôt, et ne perturbe pas la fluidité du développement.</p>

<p>Pour résumer, cette solution :</p>

<ul>
<li>est basée sur un hook déclenché sur un commit</li>
<li>est non-bloquante</li>
</ul>


<p>Ainsi, elle permet de ne pas attendre le résultat des tests pour continuer à développer.</p>

<p>La solution de David Gageot, permet un contrôle <strong>plus tôt</strong> par rapport au hook sur git push, avec pour contrepartie la nécessité d&#8217;effectuer des commits plus rigoureux.</p>

<p>Il ne faut donc pas sortir des clous lors de chaque commit, quitte à exceptionellement désactiver le hook via l&#8217;option <code>no-verify</code> citée plus haut (option valide sur tous les hooks).</p>

<p>Effectivement, les commits sous git étant fréquents, il pourrait être désagréable d&#8217;être bloqué en attendant le résultat de tests unitaires de nombreuses fois par jour. La solution du clone du repository local dans un répertoire caché est une solution élégante, car elle permet de ne pas être bloqué dans ses développements.
</span></p>

<h1>Conclusion</h1>

<p>Si vous êtes très rigoureux, utilisez donc la solution proposée par David Gageot. Si vous n&#8217;êtes pas en situation de le faire sur votre projet, peut-être que l&#8217;approche <em>hook sur git push</em> répondra à votre besoin.
J&#8217;espère qu&#8217;un de ces hooks vous permettra d&#8217;éviter la propagation de bugs vers vos collègues.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-integration-avec-JDBC-logback-et-jersey/">Metrics, Pour Mesurer Efficacement Les Performances : Intégration Avec JDBC, Logback Et Jersey</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-11T07:16:00+02:00" pubdate data-updated="true">Oct 11<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Présentation de Metrics</h1>

<p>Je vous propose dans cette série de 4 articles, de vous présenter la librairie <a href="https://github.com/codahale/metrics">Metrics</a>,
initié par la société <a href="https://www.yammer.com/">Yammer</a>.
Celle-ci permet de fournir des métriques au niveau applicatif et JVM.</p>

<p>Ce quatrième article, présente l&#8217;intégration de Metrics avec les drivers JDBC, logback et jersey.</p>

<h1>avec les drivers JDBC</h1>

<p>La librairie <code>JDBCMetrics</code> intégre JDBC avec Metrics. Cela permet :</p>

<ul>
<li>d&#8217;avoir une vision globale de la charge de la base de données issue de votre application</li>
<li>d&#8217;avoir une vision précise du nombre et des performances des requêtes SQL pour chaque requête HTTP</li>
</ul>


<p>Pour rajouter ce module à votre application, il faut rajouter la dépendance suivante à votre fichier maven <code>pom.xml</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'> <span class="nt">&lt;groupId&gt;</span>com.soulgalore<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'> <span class="nt">&lt;artifactId&gt;</span>jdbcmetrics<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'> <span class="nt">&lt;version&gt;</span>1.1<span class="nt">&lt;/version&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>La vision globale de la charge de la base de données induite par l&#8217;application est possible via la configuration du driver JDBC, soit via un <code>Datasource</code> (la librairie jouant le rôle de proxy), soit via le <code>DriverManager</code>.</p>

<p>Au passage DriverManager est une classe dépréciée, ayant un comportement incohérent au niveau du chargement du driver. Préférez donc le Datasource.</p>

<p>La vision précise de la charge au niveau base de données par requête HTTP, est permise de façon optionnelle via l&#8217;installation d&#8217;un servlet filter :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>filter&gt;
</span><span class='line'>    <span class="nt">&lt;filter-name&gt;</span>JDBCMetricsFilter<span class="nt">&lt;/filter-name&gt;</span>
</span><span class='line'>    <span class="nt">&lt;filter-class&gt;</span>
</span><span class='line'>        com.soulgalore.jdbcmetrics.filter.JDBCMetricsFilter
</span><span class='line'>    <span class="nt">&lt;/filter-class&gt;</span>
</span><span class='line'>    <span class="nt">&lt;init-param&gt;</span>
</span><span class='line'>        <span class="nt">&lt;param-name&gt;</span>use-headers<span class="nt">&lt;/param-name&gt;</span>
</span><span class='line'>        <span class="nt">&lt;param-value&gt;</span>true<span class="nt">&lt;/param-value&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/init-param&gt;</span>
</span><span class='line'>    <span class="nt">&lt;init-param&gt;</span>
</span><span class='line'>        <span class="nt">&lt;param-name&gt;</span>request-header-name<span class="nt">&lt;/param-name&gt;</span>
</span><span class='line'>        <span class="nt">&lt;param-value&gt;</span>jdbcmetrics<span class="nt">&lt;/param-value&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/init-param&gt;</span>
</span><span class='line'><span class="nt">&lt;/filter&gt;</span>
</span><span class='line'><span class="nt">&lt;filter-mapping&gt;</span>
</span><span class='line'>    <span class="nt">&lt;filter-name&gt;</span>JDBCMetricsFilter<span class="nt">&lt;/filter-name&gt;</span>
</span><span class='line'>    <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
</span><span class='line'><span class="nt">&lt;/filter-mapping&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Pour avoir la mesure de la charge occasionnée par requête HTTP, il faut dans celle-ci mettre le header suivant :</p>

<p><code>jdbcmetrics=yes</code></p>

<p>La requête HTTP devra donc comporter cette entête supplémentaire, afin d&#8217;avoir une réponse incluant des entêtes spécifiques
à JDBC.</p>

<p>voici un exemple de requête HTTP ayant cette entête (via l&#8217;extension Firefox RESTClient), ainsi que les entêtes de la réponse :</p>

<p><img class="[center]" src="/images/jdbc-metrics-custom-header.png" title="requête HTTP pour jdbcmetrics" ></p>

<p>Les Métriques JDBC sont bien sûr visualisables via les reporters (ici via JMX) :</p>

<p><img class="[center]" src="/images/metrics-jdbc.png" title="métriques du driver JDBC" ></p>

<p><a href="https://github.com/clescot/metrics-example">L&#8217;application exemple de cette série d&#8217;articles</a>, intègre Metrics et Guice, ainsi que JDBCMetrics.</p>

<p>Voici un exemple de module Guice, permettant d&#8217;installer le proxy JDBCMetrics entre le pool de connexions de la base et l&#8217;application :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">clescot</span><span class="o">.</span><span class="na">rest</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.google.inject.Binder</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.google.inject.Module</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.sql.DataSource</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.sql.Connection</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.sql.PreparedStatement</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JDBCMetricsModule</span> <span class="kd">implements</span> <span class="n">Module</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">JDBC_H2_URL</span> <span class="o">=</span> <span class="s">&quot;jdbc:h2:mem:test&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">USERNAME</span> <span class="o">=</span> <span class="s">&quot;sa&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">PASSWORD</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CREATE_TABLE_FOR_AUDIT</span> <span class="o">=</span> <span class="s">&quot;create table ACTIVITY (ID INTEGER auto_increment,STARTTIME datetime, ENDTIME datetime,  ACTIVITY_NAME VARCHAR(200),PRIMARY KEY (ID) )&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">Binder</span> <span class="n">binder</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">tomcat</span><span class="o">.</span><span class="na">jdbc</span><span class="o">.</span><span class="na">pool</span><span class="o">.</span><span class="na">DataSource</span> <span class="n">h2DataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">tomcat</span><span class="o">.</span><span class="na">jdbc</span><span class="o">.</span><span class="na">pool</span><span class="o">.</span><span class="na">DataSource</span><span class="o">();</span>
</span><span class='line'>        <span class="n">h2DataSource</span><span class="o">.</span><span class="na">setUrl</span><span class="o">(</span><span class="n">JDBC_H2_URL</span><span class="o">);</span>
</span><span class='line'>        <span class="n">h2DataSource</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">USERNAME</span><span class="o">);</span>
</span><span class='line'>        <span class="n">h2DataSource</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="n">PASSWORD</span><span class="o">);</span>
</span><span class='line'>        <span class="n">h2DataSource</span><span class="o">.</span><span class="na">setDriverClassName</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">h2</span><span class="o">.</span><span class="na">Driver</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
</span><span class='line'>        <span class="k">try</span><span class="o">(</span><span class="n">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">h2DataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">()){</span>
</span><span class='line'>            <span class="n">PreparedStatement</span> <span class="n">preparedStatement</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">CREATE_TABLE_FOR_AUDIT</span><span class="o">);</span>
</span><span class='line'>            <span class="n">preparedStatement</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">com</span><span class="o">.</span><span class="na">soulgalore</span><span class="o">.</span><span class="na">jdbcmetrics</span><span class="o">.</span><span class="na">DataSource</span> <span class="n">metricsDataSourceProxy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">soulgalore</span><span class="o">.</span><span class="na">jdbcmetrics</span><span class="o">.</span><span class="na">DataSource</span><span class="o">(</span><span class="n">h2DataSource</span><span class="o">);</span>
</span><span class='line'>        <span class="n">binder</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">DataSource</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">toInstance</span><span class="o">(</span><span class="n">metricsDataSourceProxy</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>avec Logback</h1>

<p>Metrics fournit une librairie d&#8217;intégration avec logback, pour remonter des informations concernant la fréquence des évenements logués <strong>suivant le niveau de log</strong>.</p>

<p>Pour intégrer Metrics et logback, il faut rajouter la dépendance suivante dans votre fichier <code>pom.xml</code> :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;dependencies&gt;</span>
</span><span class='line'>    <span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>        <span class="nt">&lt;groupId&gt;</span>com.codahale.metrics<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;artifactId&gt;</span>metrics-logback<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;version&gt;</span>3.0.1<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependencies&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Voici le code à utiliser pour lier Metrics à logback.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">final</span> <span class="n">LoggerContext</span> <span class="n">factory</span> <span class="o">=</span> <span class="o">(</span><span class="n">LoggerContext</span><span class="o">)</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getILoggerFactory</span><span class="o">();</span>
</span><span class='line'><span class="kd">final</span> <span class="n">Logger</span> <span class="n">root</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">Logger</span><span class="o">.</span><span class="na">ROOT_LOGGER_NAME</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">final</span> <span class="n">InstrumentedAppender</span> <span class="n">metrics</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InstrumentedAppender</span><span class="o">(</span><span class="n">registry</span><span class="o">);</span>
</span><span class='line'><span class="n">metrics</span><span class="o">.</span><span class="na">setContext</span><span class="o">(</span><span class="n">root</span><span class="o">.</span><span class="na">getLoggerContext</span><span class="o">());</span>
</span><span class='line'><span class="n">metrics</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'><span class="n">root</span><span class="o">.</span><span class="na">addAppender</span><span class="o">(</span><span class="n">metrics</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Une application concrète de cette intégration pourrait être une surveillance d&#8217;évenements logués en erreur ou warning, afin de réagir rapidement quand ceux-ci surviennent avec une fréquence importante.</p>

<p>Voici comment installer une mesure concernant les logs ayant le niveau <code>error</code> dans logback :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">registry</span><span class="o">.</span><span class="na">meter</span><span class="o">(</span><span class="s">&quot;ch.qos.logback.core.Appender.error&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>A noter qu&#8217;une intégation avec log4J existe aussi.</p>

<h1>avec Jersey</h1>

<p>Pour intégrer les mesures de Metrics avec les services REST exposés via Jersey et Spring, il est nécessaire d&#8217;intégrer le module suivant à votre fichier <code>pom.xml</code> :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>   <span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>         <span class="nt">&lt;groupId&gt;</span>com.yammer.metrics<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>         <span class="nt">&lt;artifactId&gt;</span>metrics-jersey<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>         <span class="nt">&lt;version&gt;</span>3.0.1<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Sérialisation du registre Metrics en JSON via jackson</h2>

<p>Le module maven <code>metrics-json</code>, permet de sérialiser facilement les mesures au format JSON, via des modules Jackson dédiés.</p>

<p>l&#8217;ajout de la dépendance suivante dans votre <code>pom.xml</code> permet de les utiliser :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">com</span><span class="o">.</span><span class="na">codahale</span><span class="o">.</span><span class="na">metrics</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">metrics</span><span class="o">-</span><span class="n">json</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="mf">3.0</span><span class="o">.</span><span class="mi">1</span><span class="o">&lt;/</span><span class="n">version</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>De plus, vous devez créer une ressource REST, qui va exposer la représentation JSON de votre registre Metrics comme dans l&#8217;exemple suivant :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FooResource</span> <span class="o">{</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ObjectMapper</span> <span class="n">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectMapper</span><span class="o">().</span><span class="na">registerModules</span><span class="o">(</span>
</span><span class='line'>            <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">codahale</span><span class="o">.</span><span class="na">metrics</span><span class="o">.</span><span class="na">json</span><span class="o">.</span><span class="na">MetricsModule</span><span class="o">(</span><span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">,</span> <span class="kc">false</span><span class="o">),</span><span class="k">new</span> <span class="n">HealthCheckModule</span><span class="o">());</span>
</span><span class='line'><span class="kd">private</span> <span class="n">MetricRegistry</span> <span class="n">registry</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Inject</span>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">FooResource</span><span class="o">(</span><span class="n">MetricRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">registry</span> <span class="o">=</span> <span class="n">registry</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;/metrics&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="nd">@GET</span>
</span><span class='line'>    <span class="nd">@Produces</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">String</span> <span class="nf">serializeMetricsRegistryInJSON</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">JsonProcessingException</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">mapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">registry</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ainsi, cette ressource JAX-RS exposera sur l&#8217;url http://monhost:8080/metrics en GET une représentation JSON du registre Metrics.</p>

<p>Une exposition de ces métriques peut être utile, pour par exemple, une page de supervision habillant ces métriques avec du javascript.</p>

<h2>conclusion</h2>

<p>La librairie Metrics est très pratique. Son usage s&#8217;est largement répandu, ce qui se traduit par la présence de librairies tierces afin d&#8217;enrichir son usage. Les 4 articles de cette série vous ont permis j&#8217;espère, de vous familiariser avec cette librairie.
J&#8217;ai mis en place cette solution chez un de mes clients, en envoyant les informations de Metrics vers un serveur Graphite, pour une historisation pérenne, et un travail à postériori sur les métriques techniques ou fonctionnelles remontées.</p>

<p>Afin de distinguer les métriques des différents environnements (poste de développement, recette, pre-production, production&#8230;), remontées vers le même serveur, j&#8217;ai mis en place un <code>ServletContextListener</code> qui configure au démarrage de l&#8217;application le reporter Graphite en fonction de variables positionnées au lancement du serveur. Les métriques seront donc présentes dans graphite dans des arborescences séparées, via un préfixe différent.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">clescot</span><span class="o">.</span><span class="na">listener</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.servlet.ServletContextEvent</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.servlet.ServletContextListener</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.yammer.metrics.reporting.GraphiteReporter</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MetricsGraphiteContextListener</span> <span class="kd">implements</span> <span class="n">ServletContextListener</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">DEFAULT_GRAPHITE_HOST</span> <span class="o">=</span> <span class="s">&quot;graphite&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">DEFAULT_GRAPHITE_PORT</span> <span class="o">=</span> <span class="s">&quot;2003&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">DEFAULT_GRAPHITE_PREFIX</span> <span class="o">=</span> <span class="s">&quot;default.graphite.prefix&#39;&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">DEFAULT_GRAPHITE_PERIOD</span> <span class="o">=</span> <span class="s">&quot;1&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">MetricsGraphiteContextListener</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">TimeUnit</span> <span class="n">DEFAULT_GRAPHITE_TIME_UNIT</span> <span class="o">=</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">GRAPHITE_HOST_SYSTEM_PROPERTY_KEY</span> <span class="o">=</span> <span class="s">&quot;graphite.host&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">GRAPHITE_PERIOD_SYSTEM_PROPERTY_KEY</span> <span class="o">=</span> <span class="s">&quot;graphite.period&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">GRAPHITE_TIME_UNIT_SYSTEM_PROPERTY_KEY</span> <span class="o">=</span> <span class="s">&quot;graphite.time.unit&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">GRAPHITE_PORT_SYSTEM_PROPERTY_KEY</span> <span class="o">=</span> <span class="s">&quot;graphite.port&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">GRAPHITE_PREFIX_SYSTEM_PROPERTY_KEY</span> <span class="o">=</span> <span class="s">&quot;graphite.prefix&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">JAVA_SYSTEM_PARAMETER_PREFIX</span> <span class="o">=</span> <span class="s">&quot; &#39;-D&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Overridemetrics</span><span class="o">-</span><span class="n">example</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">contextInitialized</span><span class="o">(</span><span class="kd">final</span> <span class="n">ServletContextEvent</span> <span class="n">sce</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">final</span> <span class="n">String</span> <span class="n">servletContextName</span> <span class="o">=</span> <span class="n">sce</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">().</span><span class="na">getServletContextName</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">String</span> <span class="n">graphiteHost</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">GRAPHITE_HOST_SYSTEM_PROPERTY_KEY</span><span class="o">,</span> <span class="n">DEFAULT_GRAPHITE_HOST</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Long</span> <span class="n">period</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">GRAPHITE_PERIOD_SYSTEM_PROPERTY_KEY</span><span class="o">,</span> <span class="n">DEFAULT_GRAPHITE_PERIOD</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">TimeUnit</span> <span class="n">timeUnit</span> <span class="o">=</span> <span class="n">TimeUnit</span>
</span><span class='line'>                <span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">GRAPHITE_TIME_UNIT_SYSTEM_PROPERTY_KEY</span><span class="o">,</span> <span class="n">DEFAULT_GRAPHITE_TIME_UNIT</span><span class="o">.</span><span class="na">name</span><span class="o">()));</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">int</span> <span class="n">graphitePort</span> <span class="o">=</span> <span class="n">Integer</span>
</span><span class='line'>                <span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">GRAPHITE_PORT_SYSTEM_PROPERTY_KEY</span><span class="o">,</span> <span class="n">DEFAULT_GRAPHITE_PORT</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">String</span> <span class="n">graphitePrefix</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">GRAPHITE_PREFIX_SYSTEM_PROPERTY_KEY</span><span class="o">,</span> <span class="n">DEFAULT_GRAPHITE_PREFIX</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">GraphiteReporter</span><span class="o">.</span><span class="na">enable</span><span class="o">(</span><span class="n">period</span><span class="o">,</span> <span class="n">timeUnit</span><span class="o">,</span> <span class="n">graphiteHost</span><span class="o">,</span> <span class="n">graphitePort</span><span class="o">,</span> <span class="n">graphitePrefix</span> <span class="o">+</span><span class="s">&quot;.&quot;</span><span class="o">+</span><span class="n">servletContextName</span><span class="o">);</span>
</span><span class='line'>        <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span>
</span><span class='line'>                <span class="s">&quot;graphite reporter enabled : period=&#39;{}&#39;, timeUnit=&#39;{}&#39;, graphite host=&#39;{}&#39;, graphite port=&#39;{}&#39;, metricsprefix=&#39;{}&#39;&quot;</span><span class="o">,</span>
</span><span class='line'>                <span class="n">period</span><span class="o">,</span> <span class="n">timeUnit</span><span class="o">,</span> <span class="n">graphiteHost</span><span class="o">,</span> <span class="n">graphitePort</span><span class="o">,</span> <span class="n">graphitePrefix</span> <span class="o">+</span><span class="s">&quot;.&quot;</span><span class="o">+</span><span class="n">servletContextName</span><span class="o">);</span>
</span><span class='line'>        <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;to customize graphite options listed above, put in the java command line some of these ones (without simple quotes):&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">JAVA_SYSTEM_PARAMETER_PREFIX</span> <span class="o">+</span> <span class="n">GRAPHITE_PERIOD_SYSTEM_PROPERTY_KEY</span> <span class="o">+</span> <span class="s">&quot;=yourCustomGraphitePeriod&#39;&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span>
</span><span class='line'>                <span class="n">JAVA_SYSTEM_PARAMETER_PREFIX</span> <span class="o">+</span> <span class="n">GRAPHITE_TIME_UNIT_SYSTEM_PROPERTY_KEY</span> <span class="o">+</span> <span class="s">&quot;=yourCustomGraphiteTimeUnit&#39;&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">JAVA_SYSTEM_PARAMETER_PREFIX</span> <span class="o">+</span> <span class="n">GRAPHITE_HOST_SYSTEM_PROPERTY_KEY</span> <span class="o">+</span> <span class="s">&quot;=yourCustomGraphiteHost&#39;&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">JAVA_SYSTEM_PARAMETER_PREFIX</span> <span class="o">+</span><span class="n">GRAPHITE_PORT_SYSTEM_PROPERTY_KEY</span><span class="o">+</span><span class="s">&quot;=yourCustomGraphitePort&#39;&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">JAVA_SYSTEM_PARAMETER_PREFIX</span> <span class="o">+</span><span class="n">GRAPHITE_PREFIX_SYSTEM_PROPERTY_KEY</span><span class="o">+</span><span class="s">&quot;=yourCustomGraphitePrefix&#39;&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">contextDestroyed</span><span class="o">(</span><span class="kd">final</span> <span class="n">ServletContextEvent</span> <span class="n">sce</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Références</h2>

<ul>
<li><a href="http://metrics.codahale.com/manual/core/">Metrics</a></li>
<li><a href="http://metrics.codahale.com/manual/logback/">Logback</a></li>
<li><a href="https://jersey.java.net">Jersey</a></li>
<li><a href="https://github.com/soulgalore/jdbcmetrics">JDBCMetrics</a></li>
<li><a href="https://github.com/clescot/metrics-example">application example liée à cette série d&#8217;articles</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-integration-avec-spring-et-guice/">Metrics, Pour Mesurer Efficacement Les Performances : Intégration Avec Spring Et Guice</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-11T07:08:00+02:00" pubdate data-updated="true">Oct 11<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Présentation de Metrics</h1>

<p>Je vous propose dans cette série de 4 articles, de vous présenter la librairie <a href="https://github.com/codahale/metrics">Metrics</a>,
initié par la société <a href="https://www.yammer.com/">Yammer</a>.
Celle-ci permet de fournir des métriques au niveau applicatif et JVM.</p>

<p>Ce troisième article, présente l&#8217;intégration de Metrics avec les librairies d&#8217;injection de dépendances Spring et Guice.</p>

<h1>Metrics avec Spring et Guice</h1>

<p><a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-integration-avec-jee/">Le deuxième article</a> de cette série consacrée à Metrics, présentait une intégration &#8220;legacy&#8221; de Metrics dans une application JEE.</p>

<p>Néanmoins, Il existe des librairies qui intègrent facilement Metrics à Spring ou Guice.
L&#8217;avantage de ces librairies, est qu&#8217;elles permettent de simplifier l&#8217;usage de Metrics, via des annotations.
Les applications utilisant maintenant principalement les containers d&#8217;injection de dépendances, votre configuration ressemblera plutôt à un des exemples présentés ci-après.</p>

<h2>Avec Spring</h2>

<p>Une librairie tierce permet l&#8217;intégration facile de Metrics avec les applications utilisant Spring (cette librairie supporte, au moment où j&#8217;écris l&#8217;article, la version 3.x de Metrics, contrairement à la librairie intégrant Metrics et Guice).</p>

<p>Au choix, soit la configuration via un fichier XML, soit par des annotations permet d&#8217;intégrer les deux librairies. Cette configuration nous permettra d&#8217;annoter nos classes hébergeant les métriques.</p>

<p>Il faut rajouter la dépendance suivante à votre fichier maven <code>pom.xml</code> :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>com.ryantenney.metrics<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>metrics-spring<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>3.0.1<span class="nt">&lt;/version&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>la configuration Spring via xml</h3>

<p>La configuration en xml, de l&#8217;intégration des deux librairies se fait comme suit :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
</span><span class='line'>       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
</span><span class='line'>       <span class="na">xmlns:metrics=</span><span class="s">&quot;http://www.ryantenney.com/schema/metrics&quot;</span>
</span><span class='line'>       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">            http://www.springframework.org/schema/beans</span>
</span><span class='line'><span class="s">            http://www.springframework.org/schema/beans/spring-beans-3.2.xsd</span>
</span><span class='line'><span class="s">            http://www.ryantenney.com/schema/metrics</span>
</span><span class='line'><span class="s">            http://www.ryantenney.com/schema/metrics/metrics-3.0.xsd&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">&lt;!-- registry and reporters should be defined in only one context xml file --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;metrics:metric-registry</span> <span class="na">id=</span><span class="s">&quot;registry&quot;</span> <span class="na">name=</span><span class="s">&quot;springMetrics&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;metrics:reporter</span> <span class="na">type=</span><span class="s">&quot;console&quot;</span> <span class="na">metric-registry=</span><span class="s">&quot;registry&quot;</span> <span class="na">period=</span><span class="s">&quot;1m&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">&lt;!-- annotation-driven must be included in all context files --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;metrics:annotation-driven</span> <span class="na">metric-registry=</span><span class="s">&quot;registry&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">&lt;!-- beans --&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/beans&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Comme indiqué dans les commentaires du xml précédent (<a href="https://github.com/ryantenney/metrics-spring">issu de la documentation du module d&#8217;intégration</a>), la déclaration du registre et des reporters doit être réalisée dans un seul fichier xml, tandis que la balise liée aux annotations doit être présente dans chaque fichier xml spring.</p>

<h3>la configuration Spring via des annotations</h3>

<p>De façon alternative, l&#8217;intégration se réalise en javaConfig comme suit :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Configuration</span>
</span><span class='line'><span class="nd">@EnableMetrics</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringConfiguringClass</span> <span class="kd">extends</span> <span class="n">MetricsConfigurerAdapter</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">MetricRegistry</span> <span class="nf">getMetricRegistry</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">SharedMetricRegistries</span><span class="o">.</span><span class="na">getOrCreate</span><span class="o">(</span><span class="s">&quot;springMetrics&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configureReporters</span><span class="o">(</span><span class="n">MetricRegistry</span> <span class="n">metricRegistry</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">ConsoleReporter</span><span class="o">.</span><span class="na">forRegistry</span><span class="o">(</span><span class="n">registry</span><span class="o">)</span>
</span><span class='line'>            <span class="o">.</span><span class="na">outputTo</span><span class="o">(</span><span class="n">output</span><span class="o">)</span>
</span><span class='line'>            <span class="o">.</span><span class="na">build</span><span class="o">()</span>
</span><span class='line'>            <span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>  
</span></code></pre></td></tr></table></div></figure>


<p>Cette intégration permet de :</p>

<ul>
<li>créer les métriques sur les méthodes des beans via les annotations <code>@Timed</code>, <code>@Metered</code>, <code>@ExceptionMetered</code>, and <code>@Counted</code>.</li>
<li>créer des jauges sur les membres des beans spring annotés avec <code>@Gauge</code></li>
<li>injecter via spring les variables représentant les métriques via l&#8217;annotation <code>@InjectMetric</code></li>
<li>insérer, dans le registre spécifique des healthchecks, toute classe étendant la classe <code>HealthCheck</code></li>
<li>créer des reporters Metrics et les lier au cycle de vie de Spring</li>
</ul>


<p>Une fois l&#8217;intégration de Metrics via Spring réalisée, il devient très aisé via des annotations de rajouter des métriques à notre application.</p>

<p>Exemple de classe annotée :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyClass</span> <span class="o">{</span>
</span><span class='line'>                <span class="nd">@Timed</span>
</span><span class='line'>                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">timedMethod</span><span class="o">(){</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="nd">@Metered</span>
</span><span class='line'>                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">meteredMethod</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>              <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="nd">@Counted</span>
</span><span class='line'>                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">countedMethod</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Avec Guice</h2>

<p><a href="https://github.com/clescot/metrics-example">l&#8217;application web exemple liée à cet article</a>, montre l&#8217;intégration de Metrics avec une application utilisant le framework d&#8217;injection de dépendances Guice.</p>

<p>L&#8217;application utilise Metrics 3.0.1, via une librairie <code>metrics-guice</code> qui n&#8217;a pas encore de version stable (à l&#8217;heure où j&#8217;écris cette article) supportant Metrics 3.x. J&#8217;ai donc forké le repository de metrics-guice pour juste upgrader la dépendence de Metrics vers la version 3.0.1. <a href="https://github.com/clescot/metrics-guice">Un repository metrics-guice dépendant de Metrics 3.0.1 a été crée pour cette occasion</a>.</p>

<p>Classiquement, l&#8217;intégration de Guice dans une webapp se réalise via l&#8217;installation d&#8217;un servletListener étendant <code>GuiceServletContextListener</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">clescot</span><span class="o">.</span><span class="na">rest</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.codahale.metrics.ConsoleReporter</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.codahale.metrics.JmxReporter</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.codahale.metrics.MetricRegistry</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.codahale.metrics.health.HealthCheckRegistry</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.codahale.metrics.servlets.HealthCheckServlet</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.codahale.metrics.servlets.MetricsServlet</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.google.inject.Guice</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.google.inject.Injector</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.google.inject.servlet.GuiceServletContextListener</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.palominolabs.metrics.guice.InstrumentationModule</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.servlet.ServletContext</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.servlet.ServletContextEvent</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GuiceContextListener</span> <span class="kd">extends</span> <span class="n">GuiceServletContextListener</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">ServletContext</span> <span class="n">servletContext</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">contextInitialized</span><span class="o">(</span><span class="n">ServletContextEvent</span> <span class="n">servletContextEvent</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">servletContext</span> <span class="o">=</span> <span class="n">servletContextEvent</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">();</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">.</span><span class="na">contextInitialized</span><span class="o">(</span><span class="n">servletContextEvent</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">protected</span> <span class="n">Injector</span> <span class="nf">getInjector</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Injector</span> <span class="n">injector</span> <span class="o">=</span> <span class="n">Guice</span><span class="o">.</span><span class="na">createInjector</span><span class="o">(</span><span class="k">new</span> <span class="n">HealthCheckModule</span><span class="o">(),</span> <span class="k">new</span> <span class="n">RESTModule</span><span class="o">(),</span> <span class="k">new</span> <span class="n">InstrumentationModule</span><span class="o">(),</span>
</span><span class='line'>                <span class="k">new</span> <span class="nf">JDBCMetricsModule</span><span class="o">()</span>
</span><span class='line'>        <span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//register registries in ServletContext</span>
</span><span class='line'>        <span class="n">MetricRegistry</span> <span class="n">metricRegistry</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">MetricRegistry</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>        <span class="n">HealthCheckRegistry</span> <span class="n">healthCheckRegistry</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">HealthCheckRegistry</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>        <span class="n">servletContext</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="n">MetricsServlet</span><span class="o">.</span><span class="na">METRICS_REGISTRY</span><span class="o">,</span> <span class="n">metricRegistry</span><span class="o">);</span>
</span><span class='line'>        <span class="n">servletContext</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="n">HealthCheckServlet</span><span class="o">.</span><span class="na">HEALTH_CHECK_REGISTRY</span><span class="o">,</span> <span class="n">healthCheckRegistry</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//configure reporters</span>
</span><span class='line'>        <span class="n">JmxReporter</span><span class="o">.</span><span class="na">forRegistry</span><span class="o">(</span><span class="n">metricRegistry</span><span class="o">).</span><span class="na">build</span><span class="o">().</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>        <span class="n">ConsoleReporter</span><span class="o">.</span><span class="na">forRegistry</span><span class="o">(</span><span class="n">metricRegistry</span><span class="o">).</span><span class="na">build</span><span class="o">().</span><span class="na">start</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">injector</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Un HealthCheckModule a été crée :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">clescot</span><span class="o">.</span><span class="na">rest</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.codahale.metrics.health.HealthCheck</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.google.inject.multibindings.Multibinder</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.google.inject.servlet.ServletModule</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.palominolabs.metrics.guice.servlet.AdminServletModule</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HealthCheckModule</span> <span class="kd">extends</span> <span class="n">ServletModule</span><span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configureServlets</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">install</span><span class="o">(</span><span class="k">new</span> <span class="n">AdminServletModule</span><span class="o">());</span>
</span><span class='line'>        <span class="n">Multibinder</span><span class="o">&lt;</span><span class="n">HealthCheck</span><span class="o">&gt;</span> <span class="n">healthChecksBinder</span> <span class="o">=</span> <span class="n">Multibinder</span><span class="o">.</span><span class="na">newSetBinder</span><span class="o">(</span><span class="n">binder</span><span class="o">(),</span> <span class="n">HealthCheck</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>        <span class="n">healthChecksBinder</span><span class="o">.</span><span class="na">addBinding</span><span class="o">().</span><span class="na">to</span><span class="o">(</span><span class="n">DatabaseHealthCheck</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Les deux autres modules (cf l<a href="https://github.com/clescot/metrics-example">es sources de l&#8217;application exemple</a>) correspondent à :</p>

<ul>
<li>l&#8217;enregistrement des ressources REST dans Guice (<code>RESTModule</code>)</li>
<li>la configuration de la base de données et son monitoring (<code>JDBCMetricsModule</code>)</li>
<li>un module pour lier Metrics et Guice (<code>InstrumentationModule</code>).</li>
</ul>


<p>Vous noterez l&#8217;intégration d&#8217;un <code>JMXReporter</code>, et d&#8217;un <code>ConsoleReporter</code> dans cette configuration, qui envoie dans la sortie standard toutes les 10 secondes (à des fins de test), un descriptif des métriques.</p>

<p>Les ressources REST créées et les servlets Metrics disponibles seront référencées dans le fichier <code>web.xml</code> (ou de façon alternative via des annotations pour des containers plus récents).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;web-app&gt;</span>
</span><span class='line'>    <span class="nt">&lt;display-name&gt;</span>Archetype Created Web Application<span class="nt">&lt;/display-name&gt;</span>
</span><span class='line'>    <span class="nt">&lt;listener&gt;</span>
</span><span class='line'>        <span class="nt">&lt;listener-class&gt;</span>com.clescot.rest.GuiceContextListener<span class="nt">&lt;/listener-class&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/listener&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;filter&gt;</span>
</span><span class='line'>    <span class="nt">&lt;filter-name&gt;</span>guiceFilter<span class="nt">&lt;/filter-name&gt;</span>
</span><span class='line'>    <span class="nt">&lt;filter-class&gt;</span>com.google.inject.servlet.GuiceFilter<span class="nt">&lt;/filter-class&gt;</span>
</span><span class='line'><span class="nt">&lt;/filter&gt;</span>
</span><span class='line'>    <span class="nt">&lt;filter-mapping&gt;</span>
</span><span class='line'>        <span class="nt">&lt;filter-name&gt;</span>guiceFilter<span class="nt">&lt;/filter-name&gt;</span>
</span><span class='line'>        <span class="nt">&lt;url-pattern&gt;</span>/rest/*<span class="nt">&lt;/url-pattern&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/filter-mapping&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;servlet&gt;</span>
</span><span class='line'>        <span class="nt">&lt;servlet-name&gt;</span>AdminServlet<span class="nt">&lt;/servlet-name&gt;</span>
</span><span class='line'>        <span class="nt">&lt;servlet-class&gt;</span>com.codahale.metrics.servlets.AdminServlet<span class="nt">&lt;/servlet-class&gt;</span>
</span><span class='line'>        <span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/servlet&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;servlet&gt;</span>
</span><span class='line'>        <span class="nt">&lt;servlet-name&gt;</span>healthcheck<span class="nt">&lt;/servlet-name&gt;</span>
</span><span class='line'>        <span class="nt">&lt;servlet-class&gt;</span>com.codahale.metrics.servlets.HealthCheckServlet<span class="nt">&lt;/servlet-class&gt;</span>
</span><span class='line'>        <span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/servlet&gt;</span>
</span><span class='line'>    <span class="nt">&lt;servlet&gt;</span>
</span><span class='line'>        <span class="nt">&lt;servlet-name&gt;</span>ping<span class="nt">&lt;/servlet-name&gt;</span>
</span><span class='line'>        <span class="nt">&lt;servlet-class&gt;</span>com.codahale.metrics.servlets.PingServlet<span class="nt">&lt;/servlet-class&gt;</span>
</span><span class='line'>        <span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/servlet&gt;</span>
</span><span class='line'>    <span class="nt">&lt;servlet&gt;</span>
</span><span class='line'>        <span class="nt">&lt;servlet-name&gt;</span>metrics<span class="nt">&lt;/servlet-name&gt;</span>
</span><span class='line'>        <span class="nt">&lt;servlet-class&gt;</span>com.codahale.metrics.servlets.MetricsServlet<span class="nt">&lt;/servlet-class&gt;</span>
</span><span class='line'>        <span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/servlet&gt;</span>
</span><span class='line'>    <span class="nt">&lt;servlet&gt;</span>
</span><span class='line'>        <span class="nt">&lt;servlet-name&gt;</span>threads<span class="nt">&lt;/servlet-name&gt;</span>
</span><span class='line'>        <span class="nt">&lt;servlet-class&gt;</span>com.codahale.metrics.servlets.ThreadDumpServlet<span class="nt">&lt;/servlet-class&gt;</span>
</span><span class='line'>        <span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/servlet&gt;</span>
</span><span class='line'>    <span class="nt">&lt;servlet-mapping&gt;</span>
</span><span class='line'>        <span class="nt">&lt;servlet-name&gt;</span>AdminServlet<span class="nt">&lt;/servlet-name&gt;</span>
</span><span class='line'>        <span class="nt">&lt;url-pattern&gt;</span>/admin<span class="nt">&lt;/url-pattern&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/servlet-mapping&gt;</span>
</span><span class='line'>    <span class="nt">&lt;servlet-mapping&gt;</span>
</span><span class='line'>        <span class="nt">&lt;servlet-name&gt;</span>healthcheck<span class="nt">&lt;/servlet-name&gt;</span>
</span><span class='line'>        <span class="nt">&lt;url-pattern&gt;</span>/admin/healthcheck<span class="nt">&lt;/url-pattern&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/servlet-mapping&gt;</span>
</span><span class='line'>    <span class="nt">&lt;servlet-mapping&gt;</span>
</span><span class='line'>        <span class="nt">&lt;servlet-name&gt;</span>ping<span class="nt">&lt;/servlet-name&gt;</span>
</span><span class='line'>        <span class="nt">&lt;url-pattern&gt;</span>/admin/ping<span class="nt">&lt;/url-pattern&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/servlet-mapping&gt;</span>
</span><span class='line'>    <span class="nt">&lt;servlet-mapping&gt;</span>
</span><span class='line'>        <span class="nt">&lt;servlet-name&gt;</span>metrics<span class="nt">&lt;/servlet-name&gt;</span>
</span><span class='line'>        <span class="nt">&lt;url-pattern&gt;</span>/admin/metrics<span class="nt">&lt;/url-pattern&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/servlet-mapping&gt;</span>
</span><span class='line'>    <span class="nt">&lt;servlet-mapping&gt;</span>
</span><span class='line'>        <span class="nt">&lt;servlet-name&gt;</span>threads<span class="nt">&lt;/servlet-name&gt;</span>
</span><span class='line'>        <span class="nt">&lt;url-pattern&gt;</span>/admin/threads<span class="nt">&lt;/url-pattern&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/servlet-mapping&gt;</span>
</span><span class='line'><span class="nt">&lt;/web-app&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Les exemples de code d&#8217;une application Guice ayant ces annotations sont présents dans <a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-integration-avec-JDBC-logback-et-jersey/">le dernier article</a> (les annotations sont portées par des ressources Jersey).</p>

<h2>conclusion</h2>

<p>L&#8217;intégration de la librairie Metrics avec Spring ou Guice se réalise sans réelles difficultés majeures. <a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-integration-avec-JDBC-logback-et-jersey/">Le dernier article de cette série, porte sur l&#8217;intégration de librairies tierces, comme Jersey, les drivers JDBC ou logback</a>.</p>

<h2>Références</h2>

<ul>
<li><a href="http://metrics.codahale.com/manual/core/">Metrics</a></li>
<li><a href="http://ryantenney.github.io/metrics-spring/">Metrics-Spring</a></li>
<li><a href="http://spring.io/">Spring</a></li>
<li><a href="http://code.google.com/p/google-guice/">Guice</a></li>
<li><a href="https://github.com/clescot/metrics-guice">un repository Metrics-guice dépendant de Metrics 3.0.1</a></li>
<li><a href="https://github.com/clescot/metrics-example">application example liée à cette série d&#8217;articles</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-integration-avec-jee/">Metrics Pour Mesurer Efficacement Les Performances : Intégration Avec JEE</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-11T05:01:00+02:00" pubdate data-updated="true">Oct 11<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Présentation de Metrics</h2>

<p>Je vous propose dans cette série de 4 articles, de vous présenter la librairie <a href="https://github.com/codahale/metrics">Metrics</a>,
initié par la société <a href="https://www.yammer.com/">Yammer</a>.
Celle-ci permet de fournir des métriques au niveau applicatif et JVM.</p>

<p>Ce deuxième article, présente l&#8217;intégration de Metrics dans une application web JEE.
A noter que l&#8217;intégration proposée n&#8217;inclut pas, à des fins pédagogiques, une intégration facilitée via Spring ou Guice, comme c&#8217;est le cas dans <a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-integration-avec-spring-guice-logback-et-jersey/">le troisième article de la série</a>.</p>

<h2>Intégration dans une webapp</h2>

<p><a href="https://github.com/clescot/metrics-example">Un exemple d&#8217;application web monitoré avec Metrics</a> est fourni en complément de cet article.</p>

<h3>Enregistrement du registre Metrics dans le scope application</h3>

<p>Lors du démarrage de l&#8217;application JEE, il est nécessaire d&#8217;enregistrer dans le scope <strong>application</strong> (<em>i.e</em> le <em>servletContext</em>), le registre Metrics, pour qu&#8217;il soit disponible pour toutes les classes.
Nous utiliserons pour cette tâche, un <em>ContextListener</em>, qui est justement exécuté au démarrage de l&#8217;application.</p>

<p>Pour faciliter le partage du registre, Metrics fournit un module de classes utilitaires pour les applications JEE, intitulé <code>metrics-servlet</code>.</p>

<p>Installez-donc celui-ci dans votre fichier maven <code>pom.xml</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>  <span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>      <span class="nt">&lt;groupId&gt;</span>com.codahale.metrics<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>      <span class="nt">&lt;artifactId&gt;</span>metrics-servlet<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>      <span class="nt">&lt;version&gt;</span>3.0.1<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Une fois cette dépendance installée, vous pouvez étendre le <code>InstrumentedFilterContextListener</code> pour vous faciliter la tâche comme suit :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">clescot</span><span class="o">.</span><span class="na">rest</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.codahale.metrics.MetricRegistry</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.codahale.metrics.servlet.InstrumentedFilterContextListener</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MetricsListener</span> <span class="kd">extends</span> <span class="n">InstrumentedFilterContextListener</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">MetricRegistry</span> <span class="n">METRIC_REGISTRY</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MetricRegistry</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">protected</span> <span class="n">MetricRegistry</span> <span class="nf">getMetricRegistry</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">METRIC_REGISTRY</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>L&#8217;installation de la classe MetricsListener effectuée dans votre fichier <code>web.xml</code> comme suit, vous pouvez utiliser les différentes métriques listées dans <a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-les-bases/">le premier article de cette série</a> (jauge, compteur, mesure, histogramme, timer etc&#8230;).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>...
</span><span class='line'>...
</span><span class='line'> <span class="nt">&lt;listener&gt;</span>
</span><span class='line'>        <span class="nt">&lt;listener-class&gt;</span>com.clescot.rest.MetricsListener<span class="nt">&lt;/listener-class&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/listener&gt;</span>
</span><span class='line'>...
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>Veuillez noter que le module <code>metrics-servlet</code>, n&#8217;est pas à confondre avec <code>metrics-servlets</code> évoqué plus loin dans cet article.</p>

<p>Une alternative, présentée dans <a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-integration-avec-spring-et-guice/">le troisième article de cette série</a>, est l&#8217;initialisation et l&#8217;injection du registre via un container d&#8217;injection de dépendances comme <a href="http://projects.spring.io/spring-framework/">Spring</a> ou <a href="http://code.google.com/p/google-guice/">Guice</a> (<a href="">l&#8217;application web exemple</a> utilise Guice).</p>

<h3>Health check</h3>

<p>Metrics permet aussi d&#8217;intégrer un système de &#8220;Health check&#8221;, afin de surveiller, via des appels du répartiteur de charge (<em>load-balancer</em>), les composants externes sur lesquels repose l&#8217;application, tels la base de données, ou le moteur de recherche par exemple.
Cela permet d&#8217;avoir une idée précise, de la fiabilité de ces composants, et donc de travailler sur la tolérance de l&#8217;application aux pannes de ceux-ci.</p>

<p>Cette intégration est réalisée par le module maven intitulé <strong>metrics-healthchecks</strong>.
Rajoutez donc dans votre fichier maven <code>pom.xml</code>, la dépendance suivante :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;dependencies&gt;</span>
</span><span class='line'>    <span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>        <span class="nt">&lt;groupId&gt;</span>com.codahale.metrics<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;artifactId&gt;</span>metrics-healthchecks<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;version&gt;</span>3.0.1<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependencies&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Puis il faut étendre la class HealthCheck pour en créer un :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">clescot</span><span class="o">.</span><span class="na">rest</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.codahale.metrics.core.HealthCheck</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.sql.DataSource</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.sql.Connection</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.sql.ResultSet</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.sql.Statement</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DatabaseHealthCheck</span> <span class="kd">extends</span> <span class="n">HealthCheck</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">DATABASE_HEALTH_CHECK_NAME</span> <span class="o">=</span> <span class="s">&quot;database&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">DataSource</span> <span class="n">datasource</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Inject</span>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">DatabaseHealthCheck</span><span class="o">(</span><span class="n">DataSource</span> <span class="n">datasource</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">(</span><span class="s">&quot;com.clescot.rest.DatabaseHealthCheck&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">datasource</span> <span class="o">=</span> <span class="n">datasource</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">protected</span> <span class="n">Result</span> <span class="nf">check</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">HealthCheck</span><span class="o">.</span><span class="na">Result</span> <span class="n">result</span><span class="o">;</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">(</span><span class="n">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">datasource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Statement</span> <span class="n">statement</span><span class="o">;</span>
</span><span class='line'>            <span class="n">ResultSet</span> <span class="n">resultSet</span><span class="o">;</span>
</span><span class='line'>            <span class="n">statement</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
</span><span class='line'>            <span class="n">resultSet</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="s">&quot;select 1 from dual&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">result</span> <span class="o">=</span> <span class="n">Result</span><span class="o">.</span><span class="na">healthy</span><span class="o">(</span><span class="s">&quot;&#39;select 1 from dual&#39; : OK&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">result</span> <span class="o">=</span> <span class="n">Result</span><span class="o">.</span><span class="na">unhealthy</span><span class="o">(</span><span class="s">&quot;la requête &#39;select 1 from dual&#39; retourne un résultat vide : KO&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">result</span> <span class="o">=</span> <span class="n">HealthCheck</span><span class="o">.</span><span class="na">Result</span><span class="o">.</span><span class="na">unhealthy</span><span class="o">(</span><span class="s">&quot;&#39;select 1 from dual&#39; : KO &quot;</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>La création et l&#8217;enregistrement dans le registre de Metrics du healthcheck peut se faire dans la classe MetricsListener présentée précédemment. Le datasource pourra être récupérée si besoin, via JNDI.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">registry</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="s">&quot;database&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">DatabaseHealthCheck</span><span class="o">(</span><span class="n">datasource</span><span class="o">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>Enfin, il faut enregistrer dans le fichier <code>web.xml</code>, la servlet appelant les différents healthChecks enregistrés dans le registre, c&#8217;est-à-dire la healthCheckServlet :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>...
</span><span class='line'>  <span class="nt">&lt;servlet&gt;</span>
</span><span class='line'><span class="nt">&lt;servlet-name&gt;</span>healthcheck<span class="nt">&lt;/servlet-name&gt;</span>
</span><span class='line'><span class="nt">&lt;servlet-class&gt;</span>com.codahale.metrics.servlets.HealthCheckServlet<span class="err">&lt;</span><span class="nt">&lt;/servlet-class&gt;</span>
</span><span class='line'><span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
</span><span class='line'><span class="nt">&lt;/servlet&gt;</span>
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;servlet-mapping&gt;</span>
</span><span class='line'><span class="nt">&lt;servlet-name&gt;</span>healthcheck<span class="nt">&lt;/servlet-name&gt;</span>
</span><span class='line'><span class="nt">&lt;url-pattern&gt;</span>/healthcheck<span class="nt">&lt;/url-pattern&gt;</span>
</span><span class='line'><span class="nt">&lt;/servlet-mapping&gt;</span>
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>Le load balancer appelera donc l&#8217;url http://monapplication:8080/healthcheck à intervalles réguliers sur chaque instance de webapp pour s&#8217;assurer du bon fonctionnement de tous les noeuds du cluster.</p>

<p>En cas de défaillance, l&#8217;instance en question sortira du pool d&#8217;instances utilisé pour répondre aux requêtes.</p>

<h3>Exposition des mesures</h3>

<p>Une fois les mesures posées, il faut les exposer, pour pouvoir les visualiser, et donc les analyser. Ce sont les reporters  dans Metrics qui ont cette fonction d&#8217;exposition des métriques.</p>

<h4>Via JMX</h4>

<p>L&#8217;exposition des mesures Metrics, peut être réalisée via JMX (<strong>non conseillé par Metrics en production</strong>) par l&#8217;installation et l&#8217;initialisation d&#8217;un reporter spécifique de la façon suivante :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">final</span> <span class="n">JmxReporter</span> <span class="n">reporter</span> <span class="o">=</span> <span class="n">JmxReporter</span><span class="o">.</span><span class="na">forRegistry</span><span class="o">(</span><span class="n">registry</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span><span class='line'><span class="n">reporter</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Cette initialisation pourra aussi être effectuée dans le MetricsListener évoqué précédemment.</p>

<p>L&#8217;utilisation d&#8217;outils tels <a href="http://docs.oracle.com/javase/7/docs/technotes/guides/management/jconsole.html">jconsole</a>, ou <a href="http://visualvm.java.net/">visualVM</a>, vous permettra de visualiser les mesures exposées sous forme de MBeans.</p>

<p>Voici un exemple de visualisation des métriques JMX via visualVM :
<img class="[center]" src="/images/visualvm.png" title="[métriques JMX via visualVM[métriques JMX via visualVM]]" ></p>

<h4>Via HTTP</h4>

<p>Metrics fournit par défaut, pour les applications JEE, des servlets permettant de sérialiser en HTTP le contenu du registre Metrics.</p>

<p>Pour obtenir ces servlets prêtes à l&#8217;emploi, il faut importer le module maven dans votre <code>pom.xml</code> :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">com</span><span class="o">.</span><span class="na">codahale</span><span class="o">.</span><span class="na">metrics</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">metrics</span><span class="o">-</span><span class="n">servlets</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="mf">3.0</span><span class="o">.</span><span class="mi">1</span><span class="o">&lt;/</span><span class="n">version</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Le module dédie expose les servlets suivantes :</p>

<ul>
<li><code>MetricsServlet</code>: expose les mesures via un objet JSON</li>
</ul>


<p>Voici un exemple du rendu de cette servlet :
<img class="[center]" src="/images/metrics-http.png" title="[métriques JSON[métriques JSON via MetricsServlet]]" ></p>

<ul>
<li><code>HealthCheckServlet</code> : répond aux requêtes GET en exécutant tous les healthChecks enregistrés dans le registre. Cette classe est utile pour les loadBalancers, pour ne rediriger les requêtes des clients que vers les serveurs en bonne santé. Un code HTTP 200 est retourné en cas de succès, un code HTTP 500 est retourné dans le cas inverse.</li>
<li><code>ThreadDumpServlet</code> : renvoie une représentation textuelle de tous les threads en cours sur la JVM, c&#8217;est-à-dire leur état, leur stack trace, les verrous présents etc&#8230; Cette servlet est utile à des fins de diagnostic.</li>
<li><code>AdminServlet</code> agrège les services des servlets précédemment listées.</li>
</ul>


<p>Les servlets listés sont certes très utiles pour exploiter une application ou aider au diagnostic d&#8217;un problème, mais elles ne sauraient être accessibles à tous.</p>

<p>Il est donc nécessaire, soit via votre serveur web (apache, nginx etc..), soit via votre reverse proxy, ou votre firewall, d&#8217;empêcher un accès direct depuis l&#8217;extérieur.</p>

<h4>via d&#8217;autres canaux</h4>

<p>d&#8217;autres reporters sont fournis par la librairie Metrics, pour exporter les métriques suivant différents canaux donc ceux-ci :</p>

<ul>
<li><code>ConsoleReporter</code> pour un export sur la sortie standard</li>
<li><code>Slf4jReporter</code>pour un export via la façade de log <code>SLF4J</code></li>
<li><code>GraphiteReporter</code> pour stocker de façon scalable et pseudo temps-réel les métriques</li>
</ul>


<h1>Conclusion</h1>

<p>L&#8217;intégration de Metrics dans une application JEE est aisée. Nous verrons dans <a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-integration-avec-spring-et-guice/">le prochain article de la série, une intégration facilitée via Spring ou Guice</a>.</p>

<h2>Références</h2>

<ul>
<li><a href="http://metrics.codahale.com/manual/core/">Metrics</a></li>
<li><a href="http://ryantenney.github.io/metrics-spring/">Metrics-Spring</a></li>
<li><a href="http://spring.io/">Spring</a></li>
<li><a href="http://code.google.com/p/google-guice/">Guice</a></li>
<li><a href="https://github.com/clescot/metrics-guice">un repository Metrics-guice dépendant de Metrics 3.0.1</a></li>
<li><a href="https://github.com/clescot/metrics-example">application example liée à cette série d&#8217;articles</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-les-bases/">Metrics, Pour Mesurer Efficacement Les Performances : Les Bases</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-11T03:44:00+02:00" pubdate data-updated="true">Oct 11<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>présentation de Metrics</h1>

<p>Je vous propose dans cette série de 4 articles, de vous présenter la librairie <a href="https://github.com/codahale/metrics">Metrics</a>,
initié par la société <a href="https://www.yammer.com/">Yammer</a>.
Celle-ci permet de fournir des métriques au niveau applicatif et JVM.</p>

<p>Ce premier article, présente les différents types de mesures disponibles dans Metrics, leur usage et leur installation.</p>

<h1>pourquoi mesurer ?</h1>

<p><a href="http://blog.octo.com/les-patterns-des-grands-du-web-lobsession-de-la-mesure/">A l&#8217;instar des grands du web</a>, il devient primordial de mesurer les choses avant d&#8217;agir.
Cela permet de matérialiser, identifier et comprendre le fonctionnement interne en production de nos applications. Cela permet aussi de lever des freins techniques ou fonctionnels, notamment en comprenant la valeur métier de certaines fonctionnalités, les dysfonctionnements techniques ou le manque de performances. Pour cela, rien de tel qu&#8217;une mesure fiable, numérique, pour comprendre, et prendre des décisions.</p>

<p>La librairie Metrics, est une bonne solution pour répondre à ce besoin.</p>

<h2>installation de metrics</h2>

<p>Pour installer Metrics, il faut rajouter à son fichier maven <code>pom.xml</code>, la section suivante :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;dependencies&gt;</span>
</span><span class='line'>    <span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>        <span class="nt">&lt;groupId&gt;</span>com.codahale.metrics<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;artifactId&gt;</span>metrics-core<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;version&gt;</span>3.0.1<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependencies&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>montée de version, renommage de package</h3>

<p>A noter qu&#8217;à partir de la version 3, Metrics a pour package de base <code>com.codahale.metrics</code>, et non <code>com.yammer.metrics</code> (cas des versions 2.x).</p>

<h2>Isolation des métriques par application</h2>

<p>Toutes les métriques de Metrics, sont stockées dans une instance de MetricsRegistry. Pour que plusieurs applications au sein de la même JVM, aient des métriques dissociées, il faut que chacune d&#8217;elles créent leur propre instance (chaque application étant isolée car possédant son propre classloader). Ceci peut soit se faire via le framework d&#8217;injection de dépendances (Spring, Guice), soit via un servletListener pour des applications JEE, ou via un champ statique public final de chaque application, accessible depuis l&#8217;extérieur de la classe.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">MetricRegistry</span> <span class="n">metrics</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MetricRegistry</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<h2>les métriques disponibles</h2>

<p>Le registre installé, nous pouvons créer les métriques dont nous avons besoin.</p>

<p>Voici les différents types de métriques disponibles :</p>

<ul>
<li>la jauge</li>
<li>le compteur</li>
<li>la mesure</li>
<li>l&#8217;histogramme</li>
<li>la mesure</li>
<li>le timer</li>
</ul>


<p>Lors de cette création, nous pouvons les identifier de façon unique dans le registre par les éléments suivants :</p>

<ul>
<li>groupe : la valeur par défaut est le package de la classe</li>
<li>type : nom de classe</li>
<li>nom : décrit le but de la métrique</li>
<li>scope (optionel) : permet de différentier des métriques de plusieurs instances d&#8217;une même classe</li>
</ul>


<h3>la jauge</h3>

<p>La jauge représente la valeur <strong>instantanée</strong> de ce qui est mesuré. Cette mesure simple, est à utiliser quand <strong>nous ne maîtrisons pas directement son incrément et son décrément.</strong>
C&#8217;est le cas quand la valeur représente un système externe, ou quand celle-ci est maîtrisée par une librairie tierce.</p>

<p>Un exemple d&#8217;usage de la jauge est le nombre de sessions actives dans une application web.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">registry</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">name</span><span class="o">(</span><span class="n">SessionStore</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;active-sessions&quot;</span><span class="o">),</span> <span class="k">new</span> <span class="n">Gauge</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;()</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">store</span><span class="o">.</span><span class="na">getActiveSessions</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">});</span>
</span></code></pre></td></tr></table></div></figure>


<h4>la jauge JMX</h4>

<p>Cette jauge spécialisée permet d&#8217;intégrer <strong>facilement</strong> dans le registre Metrics, une valeur exposée via JMX. Metrics peut donc devenir l&#8217;unique référentiel de métriques applicatives, en récupérant des données tierces via JMX, afin de les exposer via d&#8217;autres canaux (JMX, Graphite, Ganglia etc&#8230;).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">registry</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">name</span><span class="o">(</span><span class="n">SessionStore</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;cache-evictions&quot;</span><span class="o">),</span>
</span><span class='line'>                 <span class="k">new</span> <span class="nf">JmxAttributeGauge</span><span class="o">(</span><span class="s">&quot;net.sf.ehcache:type=Cache,scope=sessions,name=eviction-count&quot;</span><span class="o">,</span> <span class="s">&quot;Value&quot;</span><span class="o">));</span>
</span></code></pre></td></tr></table></div></figure>


<h4>la jauge ratio</h4>

<p>Cette jauge permet d&#8217;intégrer dans Metrics, le résultat du <strong>rapport entre deux variables</strong>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CacheHitRatio</span> <span class="kd">extends</span> <span class="n">RatioGauge</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Meter</span> <span class="n">hits</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Timer</span> <span class="n">calls</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">CacheHitRatio</span><span class="o">(</span><span class="n">Meter</span> <span class="n">hits</span><span class="o">,</span> <span class="n">Timer</span> <span class="n">calls</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">hits</span> <span class="o">=</span> <span class="n">hits</span><span class="o">;</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">calls</span> <span class="o">=</span> <span class="n">calls</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Ratio</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">Ratio</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">hits</span><span class="o">.</span><span class="na">oneMinuteRate</span><span class="o">(),</span>
</span><span class='line'>                        <span class="n">calls</span><span class="o">.</span><span class="na">oneMinuteRate</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>la jauge cachée</h4>

<p>Cette jauge permet de réutiliser pendant un temps paramétrable via un <strong>cache</strong>, un résultat coûteux à récupérer.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">registry</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">name</span><span class="o">(</span><span class="n">Cache</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">cache</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="s">&quot;size&quot;</span><span class="o">),</span>
</span><span class='line'>                  <span class="k">new</span> <span class="n">CachedGauge</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;(</span><span class="mi">10</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                      <span class="nd">@Override</span>
</span><span class='line'>                      <span class="kd">protected</span> <span class="n">Long</span> <span class="nf">loadValue</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                          <span class="c1">// assume this does something which takes a long time</span>
</span><span class='line'>                          <span class="k">return</span> <span class="n">cache</span><span class="o">.</span><span class="na">getSize</span><span class="o">();</span>
</span><span class='line'>                      <span class="o">}</span>
</span><span class='line'>                  <span class="o">});</span>
</span></code></pre></td></tr></table></div></figure>


<h4>la jauge dérivée</h4>

<p>Cette jauge permet de calculer un résultat <strong>à partir d&#8217;une jauge déjà présente</strong> dans le registre de Metrics.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">QueueManager</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Queue</span> <span class="n">queue</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">QueueManager</span><span class="o">(</span><span class="n">MetricRegistry</span> <span class="n">metrics</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="o">();</span>
</span><span class='line'>        <span class="n">metrics</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">MetricRegistry</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="n">QueueManager</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="s">&quot;size&quot;</span><span class="o">),</span>
</span><span class='line'>                         <span class="k">new</span> <span class="n">Gauge</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;()</span> <span class="o">{</span>
</span><span class='line'>                             <span class="nd">@Override</span>
</span><span class='line'>                             <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                                 <span class="k">return</span> <span class="n">queue</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span><span class='line'>                             <span class="o">}</span>
</span><span class='line'>                         <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>le compteur</h3>

<p>représente une mesure maîtrisée par l&#8217;application, <strong>qui s&#8217;incrémente et se décrémente</strong>.
Un exemple de compteur pourrait être le nombre de tâches planifiées en cours d&#8217;exécution à un instant t.
Tous les compteurs ont une valeur initiale de 0.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">final</span> <span class="n">Counter</span> <span class="n">pendingJobs</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="na">counter</span><span class="o">(</span><span class="n">name</span><span class="o">(</span><span class="n">QueueManager</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;pending-jobs&quot;</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">addJob</span><span class="o">(</span><span class="n">Job</span> <span class="n">job</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">pendingJobs</span><span class="o">.</span><span class="na">inc</span><span class="o">();</span>
</span><span class='line'>    <span class="n">queue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">job</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="n">Job</span> <span class="nf">takeJob</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">pendingJobs</span><span class="o">.</span><span class="na">dec</span><span class="o">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">queue</span><span class="o">.</span><span class="na">take</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>l&#8217;histogramme</h3>

<p>L&#8217;histogramme représente <strong>la distribution statistique de valeurs d&#8217;un ensemble de données</strong>.
Cela nous permet d&#8217;avoir des informations comme la moyenne, le minimum, le maximum, la médiane, la déviation standard, les quartiles ou percentiles.
Afin d&#8217;éviter un plantage, lorsque le calcul porte sur un grand nombre de données, Metrics réalise un échantillonage statistique représentatif, via différents algorithmes, appelés <strong>Reservoirs</strong>.</p>

<p>Les réservoirs fournis, hormis le dernier présenté, ont la particularité d&#8217;avoir <strong>une occupation mémoire restreinte</strong>.</p>

<h4>Des échantillons uniformes</h4>

<p>Il existe <em>l&#8217;algorithme de Vitter</em>, qui produit des échantillons uniformes. Celui-ci est intéressant pour faire une <strong>analyse à long terme</strong>, mais n&#8217;est pas adaptée pour savoir si la distribution des données porte un changement significatif récent.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">Histogram</span> <span class="n">histogram</span><span class="o">=</span> <span class="n">METRIC_REGISTRY</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="s">&quot;myLongTermHistogram&quot;</span><span class="o">,</span><span class="k">new</span> <span class="n">Histogram</span><span class="o">(</span><span class="k">new</span> <span class="n">UniformReservoir</span><span class="o">()));</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Des échantillons récents</h4>

<p>Il existe aussi un algorithme mettant un fort poids statistique sur des données récentes. Celui-ci est à privilégier lorsque l&#8217;on veut avoir une <strong>vision récente de la distribution des évenements</strong>.</p>

<p>Cette algorithme est utilisé par défaut dans les Timers.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">Histogram</span> <span class="n">histogram</span><span class="o">=</span> <span class="n">METRIC_REGISTRY</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="s">&quot;myshortTermHistogram&quot;</span><span class="o">,</span><span class="k">new</span> <span class="n">Histogram</span><span class="o">(</span><span class="k">new</span> <span class="n">ExponentiallyDecayingReservoir</span><span class="o">()));</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Des échantillons à fenêtre glissante</h4>

<p>cet algorithme permet d&#8217;étudier la <strong>distribution des N dernières données</strong>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">Histogram</span> <span class="n">histogram</span><span class="o">=</span> <span class="n">METRIC_REGISTRY</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">,</span><span class="k">new</span> <span class="n">Histogram</span><span class="o">(</span><span class="k">new</span> <span class="n">SlidingWindowReservoir</span><span class="o">(</span><span class="mi">1024</span><span class="o">)));</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Des échantillons temporels à fenêtre glissante</h4>

<p>cet algorithme permet d&#8217;étudier <strong>la distribution des N dernières secondes</strong>.
Un bémol est à apporter concernant cet algorithme, qui contrairement aux autres, porte sur la totalité des données des N dernières secondes, ce qui peut représenter <strong>un volume en mémoire important</strong>. Cet algorithme est aussi le plus lent.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">Histogram</span> <span class="n">histogram</span><span class="o">=</span> <span class="n">METRIC_REGISTRY</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="s">&quot;lastTenMinutes&quot;</span><span class="o">,</span><span class="k">new</span> <span class="n">Histogram</span><span class="o">(</span><span class="k">new</span> <span class="n">SlidingTimeWindowReservoir</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span><span class="n">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">)));</span>
</span></code></pre></td></tr></table></div></figure>


<h3>la mesure</h3>

<p>La mesure mesure <strong>la fréquence</strong> à laquelle surviennent les évenements sur les périodes suivantes :</p>

<ul>
<li>la durée de vie complète de l&#8217;application</li>
<li>les 15 dernières minutes</li>
<li>les 5 dernières minutes</li>
<li>la dernière minute</li>
</ul>


<p>Le nombre de requêtes par seconde pendant les 5 dernières minutes est un bon exemple de mesures.</p>

<p>L&#8217;alimentation de cette mesure se fait de la façon suivante :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">final</span> <span class="n">Meter</span> <span class="n">requests</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="na">meter</span><span class="o">(</span><span class="n">name</span><span class="o">(</span><span class="n">RequestHandler</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;requests&quot;</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleRequest</span><span class="o">(</span><span class="n">Request</span> <span class="n">request</span><span class="o">,</span> <span class="n">Response</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">requests</span><span class="o">.</span><span class="na">mark</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>le timer</h3>

<p>Le timer représente <strong>un histogramme des durées et une mesure de la fréquence d&#8217;apparition</strong>.</p>

<p>Un résulat issu de l&#8217;usage du timer serait :</p>

<p> à 1500 requêtes par seconde, notre latence augmente de 25 à 357 ms.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">final</span> <span class="n">Timer</span> <span class="n">timer</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">timer</span><span class="o">(</span><span class="n">name</span><span class="o">(</span><span class="n">Filter</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;requests&quot;</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'><span class="kd">final</span> <span class="n">Timer</span><span class="o">.</span><span class="na">Context</span> <span class="n">context</span> <span class="o">=</span> <span class="n">timer</span><span class="o">.</span><span class="na">time</span><span class="o">();</span>
</span><span class='line'><span class="k">try</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// handle request</span>
</span><span class='line'><span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">context</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Conclusion</h1>

<p>J&#8217;espère que ce premier article sur Metrics, vous permettra d&#8217;avoir <strong>une vue d&#8217;ensemble des différentes métriques disponibles</strong>.</p>

<p>Les trois autres articles de cette série porteront, dans l&#8217;ordre, sur <a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-integration-avec-jee/">l&#8217;intégration de Metrics dans une application web JEE</a>, <a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-integration-avec-spring-et-guice/">l&#8217;intégration de Metrics avec spring et guice</a> et <a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-integration-avec-JDBC-logback-et-jersey/">l&#8217;intégration de Metrics avec JDBC, logback et jersey</a>.</p>

<h2>Références</h2>

<ul>
<li><a href="http://metrics.codahale.com/manual/core/">Metrics</a></li>
<li><a href="https://github.com/clescot/metrics-example">application example liée à cette série d&#8217;articles</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/05/03/web-debug-tag-visualiser-facilement-les-variables-disponibles-des-jsp-dans-son-navigateur/">Web-debug-tag : Visualiser Facilement Les Variables Des Jsp Dans Son Navigateur</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-03T00:15:00+02:00" pubdate data-updated="true">May 3<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Un besoin de communication</h1>

<p>Lors de mes missions, j&#8217;ai pu observer différentes organisations d&#8217;équipe de développement d&#8217;applications web.</p>

<p>Dans certains cas, une sous-équipe est dédiée uniquement à la réalisation de la couche graphique (<em>le &#8220;front&#8221;</em>), et une autre à la partie serveur (<em>le &#8220;back&#8221;</em>). Ceci peut engendrer une &#8220;frontière&#8221; technique, une opacité quant aux variables disponibles dans les JSP fournies par les développeurs &#8220;back&#8221;.</p>

<p>Afin d&#8217;améliorer <strong>la communication entre les équipes</strong>, <a href="https://github.com/jeremyGoupil">Jérémy Goupil</a> et moi avons codé une taglib appelée <a href="https://github.com/figarocms/web-debug-tag">web-debug-tag</a>, permettant de <strong>rendre visible</strong> aux développeurs front ces variables.</p>

<p>Je vous présente donc dans cet article, son principe, son installation, et son usage, d&#8217;abord dans une application web simple, puis dans un cas plus complexe.</p>

<h1>Web-debug-tag, kesako ?</h1>

<p>Cette taglib <strong>sérialise</strong> dans la réponse du serveur, au format <strong>JSON</strong>, les variables et leurs valeurs, qu&#8217;elles soient dans les scopes <em>page</em>, <em>request</em>, <em>session</em> ou <em>application</em>.</p>

<p>Les valeurs des variables peuvent être aussi bien des chaînes de caractères que des arbres d&#8217;objets, le tag utilisant la librairie <a href="https://github.com/FasterXML/jackson-core">Jackson</a> pour sérialiser le tout. Seuls les champs publics des objets, ou ceux ayant des accesseurs publics seront sérialisés.</p>

<p>De plus, une fois ces objets java sérialisés en JSON, du code client met dans la console javascript ce résultat pour être facilement visualisé dans le navigateur.</p>

<h2>Installation</h2>

<p>L&#8217;installation de cette librairie, pour les projets sous maven, nécessite l&#8217;ajout dans votre fichier <code>pom.xml</code> de la section suivante :</p>

<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;fr.figarocms&lt;/group&gt;
    &lt;artifactId&gt;web-debug-tag&lt;/artifactId&gt;
    &lt;version&gt;1.6&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<p>Cet ajout permettra à votre projet d&#8217;inclure dans votre fichier <code>war</code>, le jar de la taglib.</p>

<p>Une fois installé, vous pouvez maintenant inclure dans vos JSP la directive suivante:</p>

<pre><code>&lt;%@ taglib prefix="debug" uri="https://github.com/figarocms/web-debug-tag"%&gt;
</code></pre>

<p>suivi par le tag en lui-même:</p>

<pre><code>&lt;debug:debugModel/&gt;
</code></pre>

<p>SI votre application comporte de nombreuses pages avec des parties communes, vous utilisez certainement un moteur de template. Placez donc cette directive dans un template global pour qu&#8217;il s&#8217;applique à toutes les JSP de l&#8217;application.</p>

<h2>À utiliser uniquement pour le développement</h2>

<p><span class='pullquote-right' data-pullquote='l&#8217;activation du web-debug-tag en production est totalement déconseillée'>
Cette librairie exposant toutes les variables de l&#8217;application côté navigateur, celle-ci n&#8217;est pas activée par défaut ; l&#8217;activation du web-debug-tag en production est totalement déconseillée, principalement pour des raisons de sécurité.</p>

<p>Pour l&#8217;activer, il faut donc mettre dans la ligne de commande lançant votre serveur d&#8217;applications le paramètre suivant:</p>

<pre><code>-Ddebug.jsp=true
</code></pre>

<p>Un message d&#8217;avertissement s&#8217;affichera néanmoins à chaque démarrage pour vous rappeler que ce n&#8217;est qu&#8217;une librairie dédiée aux environnements de développement.
</span></p>

<h2>Une application web d&#8217;exemple</h2>

<p>J&#8217;ai codé une application basique afin d&#8217;illustrer l&#8217;usage du web-debug-tag.</p>

<p>Pour tester le résultat, vous pouvez cloner le repository github par la commande suivante :</p>

<pre><code>git clone https://github.com/clescot/web-debug-tag-example
</code></pre>

<p>Dans le répertoire <em>web-debug-tag-example</em> nouvellement crée, vous pouvez lancer la commande maven suivante pour lancer un serveur jetty:</p>

<pre><code>mvn org.eclipse.jetty:jetty-maven-plugin:9.0.2.v20130417:run-exploded
</code></pre>

<h2>Rendu</h2>

<p>Le tag génère du code, qui met dans l&#8217;objet javascript <code>console</code> la grappe d&#8217;objets JSON générée.</p>

<p>voici un exemple de rendu sous ce même jetty:</p>

<p><img class="right" src="/images/capture_web-debug-tag.png" width="1855" height="1056" title="les variables jsp apparaissent dans l'onglet console de firebug" ></p>

<p>On peut voir dans cette capture d&#8217;écran, la sérialisation d&#8217;éléments présents dans les différents scopes de <a href="https://github.com/clescot/web-debug-tag-example">l&#8217;application web créée pour l&#8217;article</a>, via la console <a href="https://getfirebug.com">Firebug</a> sous Firefox. D&#8217;autres navigateurs tels Chrome permettent de visualiser aussi la sortie de l&#8217;objet console.</p>

<p>On pourra noter dans cette capture, la sérialisation d&#8217;objets dans les différents scopes, que les objets soient simples (chaînes de caractères, entiers), ou complexes (objets contenus dans d&#8217;autres objets).</p>

<h2>Exclusion de certaines classes non sérialisables</h2>

<p>Certaines classes particulières, ne sont pas sérialisables comme des proxies Spring, Sitemesh ou Hibernate, sauf à utiliser <a href="https://github.com/FasterXML/jackson-module-hibernate">des modules Jackson tierces</a>. Ceci se traduit par une <a href="http://fasterxml.github.io/jackson-databind/javadoc/2.2.0/com/fasterxml/jackson/databind/JsonMappingException.html">JsonMappingException</a> levée par <a href="https://github.com/FasterXML/jackson-core">Jackson</a>, qui englobe des StackOverflowError, syndrôme de la boucle infinie.</p>

<p>Il est donc possible, via l&#8217;utilisation d&#8217;un paramètre de contexte dans le fichier <code>web.xml</code>, de définir les classes à exclure de la sérialisation via <a href="http://docs.oracle.com/javase/7/docs/api/java/util/regex/Pattern.html">une expression régulière</a>. A noter que ces classes peuvent être présentes à différents niveaux de la grappe d&#8217;objets à sérialiser.</p>

<p>voici un exemple de configuration d&#8217;exclusion évitant des problèmes liés aux classes de Tomcat 7, Jetty 9, sitemesh et Spring:</p>

<pre><code>&lt;context-param&gt;
    &lt;param-name&gt;webdebug.excludes&lt;/param-name&gt;
    &lt;param-value&gt;org.springframework.*,__spring.*,__sitemesh.*,org.apache.jasper.*,org.apache.catalina.*,org.eclipse.jetty.webapp.Context,org.eclipse.jetty.server.*,org.eclipse.jetty.servlet.*,org.eclipse.jetty.webapp.*&lt;/param-value&gt;
&lt;/context-param&gt;
</code></pre>

<h2>Utilisation du web-debug-tag dans une application web plus complexe</h2>

<p>l&#8217;équipe du framework Spring, fournit <a href="https://github.com/SpringSource/spring-petclinic">une application web exemple</a> à laquelle j&#8217;ai ajouté, <a href="https://github.com/clescot/spring-petclinic">dans un fork du repository github</a>, le web-debug-tag, pour tester une situation plus complexe.</p>

<p>voici sa configuration dans le <code>web.xml</code>, créée après plusieurs essais permettant d&#8217;éviter des JsonMappingException :</p>

<pre><code> &lt;context-param&gt;
    &lt;param-name&gt;webdebug.excludes&lt;/param-name&gt;
    &lt;param-value&gt;org.springframework.web.context.support.ServletContextResourcePatternResolver,org.apache.naming.*,
        org.springframework.aop.*,net.sf.ehcache.DiskStorePathManager,org.springframework.context.support.*,__spring.*,__sitemesh.*,org.apache.jasper.*,org.apache.catalina.*,org.eclipse.jetty.webapp.Context,net.sf.ehcache.CacheManager,org.apache.commons.dbcp.BasicDataSource,org.springframework.beans.factory.support.*,org.eclipse.jetty.server.*,org.eclipse.jetty.servlet.*,org.eclipse.jetty.webapp.*&lt;/param-value&gt;
&lt;/context-param&gt;
</code></pre>

<p>Cette configuration pourrait être affinée si nécessaire, afin de voir plus d&#8217;informations liées à Spring (les développeurs web en ont-ils besoin ?).</p>

<p>voici un exemple de rendu des variables via le web-debug-tag :</p>

<p><img class="right" src="/images/Capture-spring-pet-clinic.png" width="1615" height="1026" title="les variables jsp apparaissent dans l'onglet console de firebug" ></p>

<h1>conclusion</h1>

<p>Je vous ai présenté l&#8217;installation et l&#8217;usage du web-debug-tag. Cet outil a eu un retour positif des développeurs &#8220;front&#8221; chez mon client.</p>

<p>J&#8217;espère que ce tag  vous sera utile, permettant une meilleure communication entre les parties &#8220;front&#8221; et &#8220;back&#8221;, si vos équipes sont structurées ainsi.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/09/executer-en-parallele-ses-tests-junit-avec-tempus-fugit/">Exécuter en Parallèle Ses Tests Junit Avec Tempus-fugit</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-09T16:00:00+02:00" pubdate data-updated="true">Apr 9<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>&#8230; ou comment tester si son code est <strong>thread-safe</strong>.</h2>

<h1>Le problème</h1>

<p>Lors du développement de services exposés sur internet (services web, servlets etc&#8230; ), il est primordial de s’assurer de la nature <strong>thread-safe</strong> du code.</p>

<p>Des problèmes d’écriture et lecture de données concurrentes, provoquant des erreurs difficilement reproductibles peuvent
survenir : un service sous forte charge pourrait se comporter de façon erronée sous forte charge. en bref, <strong>le code est hors de contrôle</strong>.</p>

<h1>Une solution</h1>

<p>L&#8217;approche habituelle pour détecter cette faiblesse est de favoriser la reproduction du problème par <strong>l&#8217;exécution concurrente</strong> (via plusieurs threads) et <strong>répétée</strong> du code.</p>

<h2>Concurrence et répétition via Tempus-fugit</h2>

<p>Je vous propose d&#8217;exécuter en parallèle le code via des tests unitaires <strong>[Junit]</strong> et la librairie <em>[tempus-fugit]</em>.</p>

<p>Nous testerons pour cet article, la nature <strong>thread-safe</strong> d’un service REST développé avec Jersey. Ces tests mettront en oeuvre les annotations <code>@Concurrent</code>, <code>Repeating</code>, <code>@Intermittent</code> et le runner <code>ConcurrentTestRunner</code>.</p>

<p>Les exemples de code sont présent sur <a href="https://github.com/clescot/tempus-fugit-example">un repository github dédié</a>.</p>

<h2>Un exemple de service web</h2>

<p><span class='pullquote-right' data-pullquote='utilisez le moins possible de champs d&#8217;instance pour des services web.'>
Voici un service web <em>[JAX-RS]</em>, qui présente deux points d&#8217;entrée permettant :</p>

<ul>
<li>d&#8217;ajouter un élément à une collection</li>
<li>d&#8217;effacer le contenu de la collection</li>
</ul>


<p>Le code ci-dessous, a pour seul but d&#8217;illustrer les problèmes de concurrence d&#8217;accès. Ici, le problème vient de l&#8217;utilisation du champ de classe <code>coll</code>, sans synchronisation. L&#8217;accès à un champ de la classe, pour des services web, est la plupart du temps la partie critique du code à contrôler, que ce champ soit un champ d&#8217;instance ou un champ statique. Ainsi, il est nécessaire de garantir un accès unique au champ via du code synchronisé, ou de déclarer <code>volatile</code> le champ pour éviter que java ne cache sa valeur pour chaque thread.
En bref, utilisez le moins possible de champs d&#8217;instance pour des services web.
</span></p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> 
</span><span class='line'>  <span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;/test1&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">FooBar</span> <span class="o">{</span>
</span><span class='line'>  
</span><span class='line'>        <span class="kd">private</span> <span class="kd">static</span> <span class="n">Collection</span> <span class="n">coll</span> <span class="o">=</span> <span class="n">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">();</span>
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>     <span class="nd">@GET</span>
</span><span class='line'>     <span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;/path1&quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="kd">public</span> <span class="n">Response</span> <span class="nf">test</span><span class="o">(</span><span class="nd">@QueryParam</span><span class="o">(</span><span class="s">&quot;value&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">coll</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">Response</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">size</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span><span class='line'>  
</span><span class='line'>     <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>        <span class="nd">@GET</span>
</span><span class='line'>        <span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;/clear&quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="kd">public</span> <span class="n">Response</span> <span class="nf">test2</span><span class="o">(</span><span class="nd">@QueryParam</span><span class="o">(</span><span class="s">&quot;value&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">value</span><span class="o">){</span>
</span><span class='line'>         <span class="n">coll</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span><span class='line'>         <span class="k">return</span> <span class="n">Response</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span><span class="s">&quot;ok&quot;</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>L&#8217;exécution parallèle</h1>

<p>Comme indiqué précédemment, l&#8217;exécution parallèle est une des contraintes à imposer  au code pour favoriser l&#8217;émergeance du problème.</p>

<p>La librairie <em>tempus-fugit</em> nous propose deux mécanismes pour exécuter du code en parallèle :</p>

<ul>
<li>l&#8217;annotation <code>@Concurrent</code></li>
<li>le runner <code>ConcurrentTestRunner</code></li>
</ul>


<h2>L&#8217;annotation <code>@Concurrent</code></h2>

<p><span class='pullquote-right' data-pullquote='L&#8217;annotation @Concurrent permet d&#8217;exécuter une même méthode de test de façon concurrente sur plusieurs threads.'>
La librairie <em>[Tempus-Fugit]</em>, fournit une <em>TestRule</em> , intitulée <code>ConcurrentRule</code>, qui s&#8217;active lorsque l&#8217;annotation <code>@Concurrent</code> est présente.
L&#8217;annotation @Concurrent permet d&#8217;exécuter une même méthode de test de façon concurrente sur plusieurs threads.</p>

<p>A noter que les <code>TestRule</code> étaient anciennement appelées <code>MethodRule</code> jusqu&#8217;à [<em>Junit</em>] 4.8.</p>

<p>Les deux tests ci-dessous permettent de voir l&#8217;intérêt de cette <em>TestRule</em> :</p>

<ul>
<li>le premier test ne contient pas l&#8217;annotation <code>@Concurrent</code>. Il n&#8217;est donc exécuté qu&#8217;une seule fois, et s&#8217;exécute avec succès. Le non support d&#8217;une exécution concurrente <strong>n&#8217;est donc pas détecté</strong>.</li>
<li>le second test est identique au premier, mais contient l&#8217;annotation <code>@Concurrent</code>. Ce Test est exécuté deux fois(<code>@concurrent(count=2)</code>, via deux threads distincts. Ce second test <strong>permet de détecter</strong> le non-support du code d&#8217;une exécution multi-threadée, notamment à cause de l&#8217;utilisation du champ de classe <code>coll</code>.
</span></li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiThreadTest</span> <span class="kd">extends</span> <span class="n">WebRunner</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">private</span> <span class="kd">static</span> <span class="n">Logger</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">MultiThreadTest</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="nd">@Rule</span>
</span><span class='line'>      <span class="kd">public</span> <span class="n">ConcurrentRule</span> <span class="n">concurrentRule</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentRule</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>      <span class="kd">private</span> <span class="n">WebResource</span> <span class="n">webResource1</span> <span class="o">=</span> <span class="n">resource</span><span class="o">().</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;/test1/path1&quot;</span><span class="o">).</span><span class="na">queryParam</span><span class="o">(</span><span class="s">&quot;value&quot;</span><span class="o">,</span> <span class="s">&quot;4&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="nd">@Test</span>
</span><span class='line'>      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testResources_without_concurrent_annotation</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">for</span> <span class="o">(</span><span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">size</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">assertThat</span><span class="o">(</span><span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="n">webResource1</span><span class="o">)),</span> <span class="n">is</span><span class="o">(</span><span class="n">size</span><span class="o">));</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>         <span class="n">WebResource</span> <span class="n">webResource2</span> <span class="o">=</span> <span class="n">resource</span><span class="o">().</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;/test1/clear&quot;</span><span class="o">);</span>
</span><span class='line'>          <span class="n">call</span><span class="o">(</span><span class="n">webResource2</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="nd">@Test</span>
</span><span class='line'>      <span class="nd">@Concurrent</span><span class="o">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="o">)</span>
</span><span class='line'>      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testResources_with_concurrent_annotation</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  
</span><span class='line'>          <span class="k">for</span> <span class="o">(</span><span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">size</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">assertThat</span><span class="o">(</span><span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="n">webResource1</span><span class="o">)),</span> <span class="n">is</span><span class="o">(</span><span class="n">size</span><span class="o">));</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>            <span class="n">WebResource</span> <span class="n">webResource2</span> <span class="o">=</span> <span class="n">resource</span><span class="o">().</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;/test1/clear&quot;</span><span class="o">);</span>
</span><span class='line'>          <span class="n">call</span><span class="o">(</span><span class="n">webResource2</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">private</span> <span class="n">String</span> <span class="nf">call</span><span class="o">(</span><span class="kd">final</span> <span class="n">WebResource</span> <span class="n">webResource</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">String</span> <span class="n">response</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>          <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">response</span> <span class="o">=</span> <span class="n">webResource</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>              <span class="n">assertThat</span><span class="o">(</span><span class="s">&quot;path =&quot;</span> <span class="o">+</span> <span class="n">webResource</span><span class="o">.</span><span class="na">getURI</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;response=&quot;</span> <span class="o">+</span> <span class="n">response</span><span class="o">,</span> <span class="o">!</span><span class="n">response</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(),</span> <span class="n">is</span><span class="o">(</span><span class="kc">true</span><span class="o">));</span>
</span><span class='line'>             <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;response=&quot;</span> <span class="o">+</span> <span class="n">response</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UniformInterfaceException</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>               <span class="n">Assert</span><span class="o">.</span><span class="na">fail</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span><span class='line'>               <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;erreur message=&quot;</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span><span class='line'>              <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;erreur réponse=&quot;</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="na">getResponse</span><span class="o">());</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>          <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
</span><span class='line'>  
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Le runner <code>ConcurrentTestRunner</code></h2>

<p>A l&#8217;instar de l&#8217;annotation <code>@Concurrent</code>, un runner Junit permet d&#8217;exécuter l&#8217;ensemble des tests d&#8217;une classe chacun dans un Thread.
Ainsi, la classe de test suivante comporte 3 méthodes de test : 3 threads seront donc crées pour exécuter dans chacun d&#8217;eux une méthode de test en parallèle.</p>

<p>Le léger avantage de cette voie est la <strong>simplicité</strong> : il sufit de déclarer le runner pour que toutes les méthodes soient exécutés en parallèle ; pas besoin de déclarer la TestRule et d&#8217;annoter chaque test.</p>

<p>Les deux principaux inconvénients sont le <strong>manque de flexibilité</strong> car on ne peut spécifier qu&#8217;un seul runner Junit pour une classe de test, et <strong>le nombre de threads par méthode de test est fixe</strong> (1 thread par test).</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">ConcurrentTestRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConcurrentTest</span> <span class="kd">extends</span> <span class="n">WebRunner</span><span class="o">{</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="kd">private</span> <span class="kd">static</span> <span class="n">Logger</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">MultiThreadTest</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">private</span> <span class="n">WebResource</span> <span class="n">webResource1</span> <span class="o">=</span> <span class="n">resource</span><span class="o">().</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;/test1/path1&quot;</span><span class="o">).</span><span class="na">queryParam</span><span class="o">(</span><span class="s">&quot;value&quot;</span><span class="o">,</span> <span class="s">&quot;4&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Test</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">first_test</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">for</span> <span class="o">(</span><span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">size</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">assertThat</span><span class="o">(</span><span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="n">webResource1</span><span class="o">)),</span> <span class="n">is</span><span class="o">(</span><span class="n">size</span><span class="o">));</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="n">WebResource</span> <span class="n">webResource2</span> <span class="o">=</span> <span class="n">resource</span><span class="o">().</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;/test1/clear&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">call</span><span class="o">(</span><span class="n">webResource2</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Test</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">second_test</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">for</span> <span class="o">(</span><span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">size</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">assertThat</span><span class="o">(</span><span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="n">webResource1</span><span class="o">)),</span> <span class="n">is</span><span class="o">(</span><span class="n">size</span><span class="o">));</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="n">WebResource</span> <span class="n">webResource2</span> <span class="o">=</span> <span class="n">resource</span><span class="o">().</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;/test1/clear&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">call</span><span class="o">(</span><span class="n">webResource2</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Test</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">third_test</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">for</span> <span class="o">(</span><span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">size</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">assertThat</span><span class="o">(</span><span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="n">webResource1</span><span class="o">)),</span> <span class="n">is</span><span class="o">(</span><span class="n">size</span><span class="o">));</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="n">WebResource</span> <span class="n">webResource2</span> <span class="o">=</span> <span class="n">resource</span><span class="o">().</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;/test1/clear&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">call</span><span class="o">(</span><span class="n">webResource2</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">private</span> <span class="n">String</span> <span class="nf">call</span><span class="o">(</span><span class="kd">final</span> <span class="n">WebResource</span> <span class="n">webResource</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">String</span> <span class="n">response</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">response</span> <span class="o">=</span> <span class="n">webResource</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>                <span class="n">assertThat</span><span class="o">(</span><span class="s">&quot;path =&quot;</span> <span class="o">+</span> <span class="n">webResource</span><span class="o">.</span><span class="na">getURI</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;response=&quot;</span> <span class="o">+</span> <span class="n">response</span><span class="o">,</span> <span class="o">!</span><span class="n">response</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(),</span> <span class="n">is</span><span class="o">(</span><span class="kc">true</span><span class="o">));</span>
</span><span class='line'>                <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;response=&quot;</span> <span class="o">+</span> <span class="n">response</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UniformInterfaceException</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">Assert</span><span class="o">.</span><span class="na">fail</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span><span class='line'>                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;erreur message=&quot;</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span><span class='line'>                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;erreur réponse=&quot;</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="na">getResponse</span><span class="o">());</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>L&#8217;exécution répétée</h1>

<p>La seconde contrainte à imposer au code est l&#8217;exécution répétée.</p>

<p>La librairie <em>tempus-fugit</em> nous propose deux mécanismes pour exécuter du code de façon répétée :</p>

<ul>
<li>l&#8217;annotation <code>@Repeating</code></li>
<li>L&#8217;annotation <code>@Intermittent</code></li>
</ul>


<h2>L&#8217;annotation <code>@Repeating</code></h2>

<p>Souvent, la résolution des problèmes d&#8217;exécution concurrente de code n&#8217;est pas évidente, contrairement à l&#8217;exemple de cet article. Le bug se produit de façon erratique. Il est donc nécessaire de reproduire l&#8217;exécution des tests un grand nombre de fois, pour avoir la chance de faire échouer le code.</p>

<p><em>Tempus-fugit</em>, nous fournit une autre <em>TestRule</em> intitulée <code>RepeatingRule</code>, qui est associée avec l&#8217;annotation <code>@Repeating</code>.</p>

<p>Elle permet d&#8217;exécuter un grand nombre de fois une méthode de test. Elle peut se cumuler avec l&#8217;annotation <code>@Concurrent</code>.</p>

<p>Voici un exemple d&#8217;une utilisation combinée de ces deux annotations :</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="nd">@Rule</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">RepeatingRule</span> <span class="n">repeatingRule</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RepeatingRule</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Test</span>
</span><span class='line'>  <span class="nd">@Concurrent</span><span class="o">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="o">)</span>
</span><span class='line'>  <span class="nd">@Repeating</span><span class="o">(</span><span class="n">repetition</span><span class="o">=</span><span class="mi">4</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testResources_with_concurrent_annotation</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  
</span><span class='line'>     <span class="k">for</span> <span class="o">(</span><span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">size</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>         <span class="n">assertThat</span><span class="o">(</span><span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="n">webResource1</span><span class="o">)),</span> <span class="n">is</span><span class="o">(</span><span class="n">size</span><span class="o">));</span>
</span><span class='line'>     <span class="o">}</span>
</span><span class='line'>         <span class="n">WebResource</span> <span class="n">webResource2</span> <span class="o">=</span> <span class="n">resource</span><span class="o">().</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;/test1/clear&quot;</span><span class="o">);</span>
</span><span class='line'>     <span class="n">call</span><span class="o">(</span><span class="n">webResource2</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>L&#8217;annotation <code>@Intermittent</code></h2>

<p><span class='pullquote-right' data-pullquote='Le principal inconvénient de @Intermittent est qu&#8217;on ne peut utiliser plus d&#8217;un runner Junit'>
Cette annotation a de grandes similitudes avec l&#8217;annotation <code>@Repeating</code>, à ceci prêt qu&#8217;elle n&#8217;est pas associée avec une <code>TestRule</code>, mais avec le <em>runner Junit</em> <code>IntermittentTestRunner</code>. Elle possède également un attribut nommé <code>repetition</code>.</p>

<p>Cette association a pour avantage d&#8217;exécuter <strong>à chaque répétition</strong>, les méthodes annotées par <code>@Before</code> et <code>@After</code>, contrairement aux <code>TestRule</code>.
Le principal inconvénient de @Intermittent est qu&#8217;on ne peut utiliser plus d&#8217;un runner Junit; on ne peut donc pas dans cette configuration utiliser un autre <em>runner</em>.
</span></p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">IntermittentTestRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">IntermittentTest</span> <span class="kd">extends</span> <span class="n">WebRunner</span><span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Logger</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">MultiThreadTest</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">WebResource</span> <span class="n">webResource1</span> <span class="o">=</span> <span class="n">resource</span><span class="o">().</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;/test1/path1&quot;</span><span class="o">).</span><span class="na">queryParam</span><span class="o">(</span><span class="s">&quot;value&quot;</span><span class="o">,</span> <span class="s">&quot;4&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Test</span>
</span><span class='line'>    <span class="nd">@Intermittent</span><span class="o">(</span><span class="n">repetition</span> <span class="o">=</span> <span class="mi">30</span><span class="o">)</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test_method1_with_intermittent_annotation</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">call</span><span class="o">(</span><span class="n">webResource1</span><span class="o">);</span>
</span><span class='line'>        <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;method1 executed&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Test</span>
</span><span class='line'>    <span class="nd">@Intermittent</span><span class="o">(</span><span class="n">repetition</span> <span class="o">=</span> <span class="mi">10</span><span class="o">)</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test_method2_with_intermittent_annotation</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">call</span><span class="o">(</span><span class="n">webResource1</span><span class="o">);</span>
</span><span class='line'>        <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;method2 executed&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">String</span> <span class="nf">call</span><span class="o">(</span><span class="kd">final</span> <span class="n">WebResource</span> <span class="n">webResource</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">String</span> <span class="n">response</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">response</span> <span class="o">=</span> <span class="n">webResource</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>            <span class="n">assertThat</span><span class="o">(</span><span class="s">&quot;path =&quot;</span> <span class="o">+</span> <span class="n">webResource</span><span class="o">.</span><span class="na">getURI</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;response=&quot;</span> <span class="o">+</span> <span class="n">response</span><span class="o">,</span> <span class="o">!</span><span class="n">response</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(),</span> <span class="n">is</span><span class="o">(</span><span class="kc">true</span><span class="o">));</span>
</span><span class='line'>            <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;response=&quot;</span> <span class="o">+</span> <span class="n">response</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UniformInterfaceException</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Assert</span><span class="o">.</span><span class="na">fail</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span><span class='line'>            <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;erreur message=&quot;</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span><span class='line'>            <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;erreur réponse=&quot;</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="na">getResponse</span><span class="o">());</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Conclusion</h1>

<p><span class='pullquote-right' data-pullquote='Tempus-fugit pallie au manque du support natif de Junit des contraintes de concurrence.'>
La librairie <em>tempus-fugit</em> nous permet de tester la bonne exécution du code dans un environnement concurrent.
Elle nous offre deux alternatives pour mettre en place une exécution <strong>parallèle</strong> et <strong>répétée</strong> des tests unitaires Junit.
Tempus-fugit pallie au manque du support natif de Junit des contraintes de concurrence. <em>TestNG</em>, l&#8217;autre librairie de test, intègre nativement ces problématiques via les attributs <code>threadPoolSize</code>, et <code>invocationCount</code>. A noter que <em>TestNG</em> inclut aussi, <del>contrairement à <em>Junit</em> et <em>tempus-fugit</em></del>, les attributs <code>timeout</code> et <code>invocationTimeOut</code> pour définir respectivement le temps que le test et l&#8217;ensemble des tests doivent prendre au maximum pour être considéré comme positifs.</p>

<p><em>Tempus-fugit</em> fournit d&#8217;autres fonctionnalités, comme entre autres, une gestion facilitée des Threads (interruptions, pause, réveil), une gestion des verrous, et une détection des deadlocks.
</span></p>

<h2><em>Mise à jour du 13/04/2013</em></h2>

<p>Junit permet bien de définir un temps d&#8217;exécution maximum par méthode via le paramètre <code>timeout</code> de l&#8217;annotation <code>@Test</code>.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">//5 secondes maximum</span>
</span><span class='line'><span class="nd">@Test</span><span class="o">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">500</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">monTest</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Junit permet aussi de définir un temps limite pour tous les tests d&#8217;une classe via la @Rule <code>TimeOut</code>.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MaCLasseDeTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Rule</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Timeout</span> <span class="n">globalTimeout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Timeout</span><span class="o">(</span><span class="mi">8000</span><span class="o">);</span> <span class="c1">// 8 secondes maximum par méthode de test</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Test</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">monPremierTest</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="o">......</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Test</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">monDeuxiemeTest</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>       <span class="o">...</span>   <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Références</h2>

<ul>
<li><a href="http://www.junit.org">Junit</a></li>
<li><a href="http://tempusfugitlibrary.org">tempus-fugit</a></li>
<li><a href="http://jax-rs-spec.java.net">JAX-RS</a></li>
<li><a href="http://testng.org">TestNG</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/06/les-classes-de-test-ne-sont-pas-des-poubelles/">Les Classes De Test Ne Sont Pas Des Poubelles !</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-06T01:03:00+01:00" pubdate data-updated="true">Feb 6<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img class="right" src="/images/sign-34163_150.png" width="149" height="150" title="poubelle" ></p>

<h2>&#8230; ou comment structurer ses tests unitaires.</h2>

<h1>Résumé</h1>

<p>Je suis souvent confronté à des classes de test d&#8217;une longueur <strong>gigantesque</strong> dans les projets où j&#8217;interviens.
Leur contenu en un seul bloc est souvent illisible, quelquefois désorganisé et difficilement maintenable.</p>

<p>J&#8217;aborde dans cet article, différentes solutions d&#8217;organisation de ses classes de tests en les comparant.</p>

<h2>La solution proposée</h2>

<p>Je propose d&#8217;organiser les tests via des <strong>classes statiques internes</strong> couplées à de l&#8217;héritage. Vous pourrez regrouper
 vos méthodes de test par méthode testée, les exécuter sélectivement et rendre lisible la classe de test.</p>

<h1>Constat</h1>

<p>Les classes de test sont, quand les tests sont nombreux, très longues.
Il est difficile de les appréhender d&#8217;un seul coup d&#8217;oeil.</p>

<p>Pour tester une méthode avec <a href="http://www.junit.org">Junit</a>, on crée une nouvelle méthode
dans la classe de test pour chaque nouveau cas d&#8217;usage.</p>

<p>Ainsi, les nombreux cas de test impliquent de créer <strong>beaucoup</strong> de méthodes de test.</p>

<h2>Conséquence</h2>

<p>Il est difficile de :</p>

<ul>
<li> retrouver tous les cas de test d&#8217;une méthode</li>
<li> identifier les cas de test récurrents</li>
<li> lancer uniquement tous les cas de test d&#8217;une méthode</li>
<li> avoir une vue d&#8217;ensemble de la classe de test</li>
</ul>


<h2>Exemple</h2>

<p>Voici la classe <code>Foo.java</code> à tester :</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Foo</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">add</span><span class="o">(</span><span class="n">Integer</span> <span class="n">a</span><span class="o">,</span><span class="n">Integer</span> <span class="n">b</span><span class="o">){</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="na">intValue</span><span class="o">()+</span><span class="n">b</span><span class="o">.</span><span class="na">intValue</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">substract</span><span class="o">(</span><span class="n">Integer</span> <span class="n">a</span><span class="o">,</span><span class="n">Integer</span> <span class="n">b</span><span class="o">){</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="na">intValue</span><span class="o">()-</span><span class="n">b</span><span class="o">.</span><span class="na">intValue</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Cette classe ne comporte que deux méthodes, prenant chacune deux paramètres.</p>

<p>Malgré sa simplicité, celle-ci comprend pour chaque méthode de nombreux cas à tester :</p>

<ul>
<li> les paramètres sont null</li>
<li> un des paramètres est null</li>
<li> les paramètres sont négatifs</li>
<li> les paramètres sont positifs</li>
<li> les paramètres sont pour le premier négatif, pour l&#8217;autre positif</li>
<li> les paramètres sont pour le premier positif, pour l&#8217;autre négatif</li>
<li> le résultat est négatif</li>
<li> le résultat est positif</li>
<li> le résultat est égal à zéro</li>
<li> le résultat dépasse la limite inférieure du type <em>Integer</em></li>
<li> le résultat dépasse la limite supérieure du type <em>Integer</em></li>
<li> etc&#8230;</li>
</ul>


<p>En résulte ainsi, un code <strong>illisible</strong> (je vous épargne le code complet) :</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
</span><span class='line'>    <span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">hamcrest</span><span class="o">.</span><span class="na">CoreMatchers</span><span class="o">.</span><span class="na">is</span><span class="o">;</span>
</span><span class='line'>    <span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">Assert</span><span class="o">.</span><span class="na">assertThat</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">FooTest</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">private</span> <span class="n">Foo</span> <span class="n">foo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Foo</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Test</span><span class="o">(</span><span class="n">expected</span> <span class="o">=</span> <span class="n">NullPointerException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testAdd_withNullArguments</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">foo</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Test</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testAdd_withPositiveArguments</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">foo</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span>
</span><span class='line'>            <span class="n">assertThat</span><span class="o">(</span><span class="n">result</span><span class="o">,</span><span class="n">is</span><span class="o">(</span><span class="mi">7</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">......</span>
</span><span class='line'>        <span class="o">......</span>
</span><span class='line'>        <span class="o">......</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Test</span><span class="o">(</span><span class="n">expected</span> <span class="o">=</span> <span class="n">NullPointerException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSubstract_withNullArguments</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">foo</span><span class="o">.</span><span class="na">substract</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Test</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSubstract_withPositiveArguments</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">foo</span><span class="o">.</span><span class="na">substract</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span>
</span><span class='line'>            <span class="n">assertThat</span><span class="o">(</span><span class="n">result</span><span class="o">,</span><span class="n">is</span><span class="o">(-</span><span class="mi">1</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="o">......</span>
</span><span class='line'>        <span class="o">......</span>
</span><span class='line'>        <span class="o">......</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Diviser (le code) pour mieux régner</h2>

<p>Face à une classe qui grossit à outrance, il est nécessaire de répartir les cas de tests, par exemple suivant la méthode testée.</p>

<p>Essayons de lister les possibilités pour regrouper les cas de test d&#8217;une même méthode.</p>

<h3>Des débuts d&#8217;organisation : les commentaires</h3>

<p>Pour mieux organiser ses tests, beaucoup insèrent des commentaires comme repères.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="c1">////////////// début des tests de la méthode &#39;add&#39;</span>
</span><span class='line'>    <span class="o">.......</span>
</span><span class='line'>    <span class="o">.......</span>
</span><span class='line'>    <span class="c1">///////////// fin des tests de la méthode &#39;add&#39;</span>
</span><span class='line'>    <span class="c1">////////////// début des tests de la méthode &#39;substract&#39;</span>
</span><span class='line'>    <span class="o">.......</span>
</span><span class='line'>    <span class="o">.......</span>
</span><span class='line'>    <span class="c1">///////////// fin des tests de la méthode &#39;substract&#39;</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<h4>Avantages</h4>

<p>Les méthodes comprises entre les blocs de commentaires sont regroupées et associées à la méthode testée.</p>

<h4>Inconvénients</h4>

<p>Cette solution :</p>

<ul>
<li> rajoute beaucoup de bruit dans la lisibilité de la classe</li>
<li> ne resiste pas au reformatage du code effectué avec certains éditeurs de texte</li>
<li> ne permet pas de ne choisir d&#8217;exécuter qu&#8217;un sous-ensemble des tests unitaires</li>
</ul>


<p>Dans la même optique, <a href="https://sites.google.com/site/unclebobconsultingllc/">Robert Martin (Uncle Bob)</a>,
dans son <a href="http://www.amazon.fr/gp/product/0132350882/ref=as_li_qf_sp_asin_tl?ie=UTF8&amp;camp=1642&amp;creative=6746&amp;creativeASIN=0132350882&amp;linkCode=as2&amp;tag=clescotcom08-21">livre <em>Clean Code</em></a>,
 insiste sur l&#8217;importance de la lisibilité du code, et recommande d&#8217;éviter d&#8217;encombrer celui-ci avec ce genre de commentaires. Les commentaires ne permettent pas une bonne orgnaisation du code.</p>

<h3>Pas de régions <em>à la .NET</em> en Java</h3>

<p><span class='pullquote-right' data-pullquote='Les régions .NET ne résolvent pas les problèmes d&#8217;organisation, et ne sont pas disponible du côté java.'></p>

<p>A noter que du côté .NET, les directives de régions ont été ajoutées à destination des éditeurs, pour qu&#8217;ils puissent
cacher ou afficher des parties de code. Les régions sont présentes dans le code source, mais pas dans le MSIL (équivalent du <em>bytecode</em> Java).
Cette fonctionnalité a donc uniquement pour but d&#8217;améliorer la lisibilité, mais ne permet pas de raffiner l&#8217;exécution
des tests. Les régions .NET ne résolvent pas les problèmes d&#8217;organisation, et ne sont pas disponible du côté java.</p>

<p></span></p>

<h3>Une fausse bonne idée : les catégories Junit</h3>

<p><a href="http://kentbeck.github.com/junit/doc/ReleaseNotes4.8.html">Depuis junit 4.8</a>, il est possible d&#8217;ajouter des annotations,
afin de regrouper des méthodes (ou des classes) de test en catégories (des sortes de tags).
Plusieurs catégories peuvent être ajoutées à une même méthode ou classe.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">FooTestWithCategories</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">private</span> <span class="n">Foo</span> <span class="n">foo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Foo</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Category</span><span class="o">(</span><span class="n">Add</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'>        <span class="nd">@Test</span><span class="o">(</span><span class="n">expected</span> <span class="o">=</span> <span class="n">NullPointerException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testAdd_withNullArguments</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">foo</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Category</span><span class="o">(</span><span class="n">Add</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'>        <span class="nd">@Test</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testAdd_withPositiveArguments</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">foo</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span>
</span><span class='line'>            <span class="n">assertThat</span><span class="o">(</span><span class="n">result</span><span class="o">,</span><span class="n">is</span><span class="o">(</span><span class="mi">7</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Category</span><span class="o">(</span><span class="n">Substract</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'>        <span class="nd">@Test</span><span class="o">(</span><span class="n">expected</span> <span class="o">=</span> <span class="n">NullPointerException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSubstract_withNullArguments</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">foo</span><span class="o">.</span><span class="na">substract</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Category</span><span class="o">(</span><span class="n">Substract</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'>        <span class="nd">@Test</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSubstract_withPositiveArguments</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">foo</span><span class="o">.</span><span class="na">substract</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span>
</span><span class='line'>            <span class="n">assertThat</span><span class="o">(</span><span class="n">result</span><span class="o">,</span><span class="n">is</span><span class="o">(-</span><span class="mi">1</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<h4>Avantages</h4>

<p>Les catégories Junit :</p>

<ul>
<li>rattachent les tests aux méthodes testées.</li>
<li>permettent de lancer l&#8217;exécution de tous les tests d&#8217;une méthode particulière, via un Runner Junit nommé <code>Categories</code>, et une sélection des tests via <code>@Categories.IncludeCategory</code>.</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="nd">@RunWith</span><span class="o">(</span><span class="n">Categories</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'>    <span class="nd">@Categories.IncludeCategory</span><span class="o">(</span><span class="n">Add</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'>    <span class="nd">@Suite.SuiteClasses</span><span class="o">(</span> <span class="o">{</span><span class="n">FooTestWithCategories</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyTestSuite</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<h4>Inconvénients</h4>

<p>Les catégories Junit :</p>

<ul>
<li>ne permettent pas d&#8217;isoler les tests d&#8217;une méthode par rapport aux autres :
les tests peuvent avoir les bonnes catégories, mais être éparpillés au sein d&#8217;une grande classe de test&#8230;</li>
<li>elles nécessitent un Runner Junit particulier <em>Categories</em>.Elles ne permettent pas d&#8217;utiliser d&#8217;autres
Runner Junit (un seul Runner est spécifié par exécution).</li>
<li>l’isolation des cas de test récurrents n&#8217;est pas encouragé par cette option.</li>
</ul>


<p>Les catégories Junit sont plutôt à utiliser pour différencier l&#8217;exécution de tests en fonction soit
de leurs dépendances techniques externes (tests d&#8217;intégration),de leur rapidité, ou d&#8217;un autre critère <strong>non fonctionnel</strong>.</p>

<h3>La solution proposée : utilisation des classes internes</h3>

<p><a href="http://www.junit.org/node/401">Junit 4.5</a> apporte l&#8217;utilisation d&#8217;un Runner permettant de lancer des tests présents
dans des <strong>classes statiques internes</strong>:
<em>Enclosed</em>, qui est présent dans un package <em>expérimental</em> (org.junit.experimental.runners.Enclosed).</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="nd">@RunWith</span><span class="o">(</span><span class="n">Enclosed</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">FooTestWithEnclosed</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Foo</span> <span class="n">foo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Foo</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Add</span> <span class="o">{</span>
</span><span class='line'>            <span class="kd">private</span> <span class="n">Foo</span> <span class="n">foo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Foo</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="nd">@Test</span><span class="o">(</span><span class="n">expected</span> <span class="o">=</span> <span class="n">NullPointerException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'>            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testWithNullArguments</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">foo</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="nd">@Test</span>
</span><span class='line'>            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testwithPositiveArguments</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>                <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">foo</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span>
</span><span class='line'>                <span class="n">assertThat</span><span class="o">(</span><span class="n">result</span><span class="o">,</span><span class="n">is</span><span class="o">(</span><span class="mi">7</span><span class="o">));</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Substract</span> <span class="o">{</span>
</span><span class='line'>            <span class="kd">private</span> <span class="n">Foo</span> <span class="n">foo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Foo</span><span class="o">();</span><span class="n">pens</span>
</span><span class='line'>            <span class="nd">@Test</span><span class="o">(</span><span class="n">expected</span> <span class="o">=</span> <span class="n">NullPointerException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'>            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testWithNullArguments</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">foo</span><span class="o">.</span><span class="na">substract</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="nd">@Test</span>
</span><span class='line'>            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testwithPositiveArguments</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>                <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">foo</span><span class="o">.</span><span class="na">substract</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span>
</span><span class='line'>                <span class="n">assertThat</span><span class="o">(</span><span class="n">result</span><span class="o">,</span><span class="n">is</span><span class="o">(-</span><span class="mi">1</span><span class="o">));</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<h4>Avantages</h4>

<ul>
<li>rassemble dans une structure toutes les méthodes de tests liées à une méthode testée</li>
<li>permet d&#8217;exécuter sélectivement les cas de test d&#8217;une méthode</li>
</ul>


<h4>Inconvénients</h4>

<ul>
<li>le runner Junit est présent dans un package au nom qui implique une existence peu pérenne (<code>experimental</code>)</li>
<li>le runner ne lance que des méthodes présentes dans des classes statiques internes. Cet inconvénient ne semble pas gênant, car il semble rarement souhaitable de mélanger des organisations         différentes (classes statiques internes et présence directe des méthodes) au sein d&#8217;une même classe.</li>
</ul>


<h3>Améliorer la solution : héritage couplé aux classes statiques internes</h3>

<p>On vient de voir l&#8217;intérêt d&#8217;utiliser les <strong>classes statiques internes</strong> pour regrouper les cas de test d&#8217;une méthode.
Afin de clarifier les cas de test récurrents à implémenter pour toute nouvelle méthode, nous pouvons utiliser
des <strong>interfaces internes</strong> dont héritera toute nouvelle classe statique interne.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="nd">@RunWith</span><span class="o">(</span><span class="n">Enclosed</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">FooTestWithEnclosedAndInheritance</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">private</span> <span class="n">Foo</span> <span class="n">foo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Foo</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">private</span> <span class="kd">interface</span> <span class="nc">MyTest</span> <span class="o">{</span>
</span><span class='line'>            <span class="kt">void</span> <span class="nf">testWithNullArguments</span><span class="o">();</span>
</span><span class='line'>            <span class="kt">void</span> <span class="nf">testWithPositiveArguments</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Add</span> <span class="kd">implements</span> <span class="n">MyTest</span> <span class="o">{</span>
</span><span class='line'>            <span class="kd">private</span> <span class="n">Foo</span> <span class="n">foo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Foo</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="nd">@Test</span><span class="o">(</span><span class="n">expected</span> <span class="o">=</span> <span class="n">NullPointerException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'>            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testWithNullArguments</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">foo</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="nd">@Test</span>
</span><span class='line'>            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testWithPositiveArguments</span><span class="o">(){</span>
</span><span class='line'>                <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">foo</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span>
</span><span class='line'>                <span class="n">assertThat</span><span class="o">(</span><span class="n">result</span><span class="o">,</span><span class="n">is</span><span class="o">(</span><span class="mi">7</span><span class="o">));</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Substract</span> <span class="kd">implements</span> <span class="n">MyTest</span> <span class="o">{</span>
</span><span class='line'>            <span class="kd">private</span> <span class="n">Foo</span> <span class="n">foo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Foo</span><span class="o">();</span>
</span><span class='line'>            <span class="nd">@Test</span><span class="o">(</span><span class="n">expected</span> <span class="o">=</span> <span class="n">NullPointerException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'>            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testWithNullArguments</span><span class="o">(){</span>
</span><span class='line'>                <span class="n">foo</span><span class="o">.</span><span class="na">substract</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="nd">@Test</span>
</span><span class='line'>            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testWithPositiveArguments</span><span class="o">(){</span>
</span><span class='line'>                <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">foo</span><span class="o">.</span><span class="na">substract</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span>
</span><span class='line'>                <span class="n">assertThat</span><span class="o">(</span><span class="n">result</span><span class="o">,</span><span class="n">is</span><span class="o">(-</span><span class="mi">1</span><span class="o">));</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<h4>Avantages</h4>

<ul>
<li>Utilise une classe statique interne pour regrouper des cas de test, permet d&#8217;utiliser l&#8217;héritage pour homogénéiser
l&#8217;implémentation de cas de test récurrents.</li>
<li>évite la duplication de code.</li>
</ul>


<h3>Inconvénients</h3>

<ul>
<li>si vous utilisez une classe abstraite qui n&#8217;a pas de méthodes de test, il est possible que le Runner Junit vous lance une exception.
Pour régler ce problème, il faut ajouter l&#8217;annotation <em>@Ignore</em> à la classe.</li>
</ul>


<h2>Conclusion</h2>

<p>Arrêtons d&#8217;ignorer les bonnes pratiques de développement dans les tests, avec pour pretexte que ce code n&#8217;ira
pas en production ! Le code de test n&#8217;est pas du code jetable, mais est intimement lié au code qui sera déployé.</p>

<p><strong>Les qualités du code de test et de production doivent être du même niveau.</strong></p>

<p>Utilisons les structures du langage disponibles comme les <strong>classes statiques internes</strong> pour répartir les cas de test, et <strong>l&#8217;héritage</strong> pour identifier
les cas de test récurrents.
La non-répétition du code, sa lisibilité, et sa structure cohérente, permettent d&#8217;écrire des tests plus robustes,
plus maintenables et compréhensibles !</p>

<h2>Références</h2>

<ul>
<li><a href="http://www.junit.org">Junit</a></li>
<li><a href="http://www.junit.org/node/401">Junit 4.5</a></li>
<li><a href="http://kentbeck.github.com/junit/doc/ReleaseNotes4.8.html">Junit 4.8</a></li>
<li><a href="http://www.amazon.fr/gp/product/0132350882/ref=as_li_tf_tl?ie=UTF8&amp;camp=1642&amp;creative=6746&amp;creativeASIN=0132350882&amp;linkCode=as2&amp;tag=clescotcom-21">clean code</a></li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    
<section>
	<span>
		<img src="http://www.gravatar.com/avatar/fc175897116c1713a470a92db9c31d2c" alt="Gravatar of Charles Lescot " title="Gravatar of Charles Lescot" />
	</span>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/05/27/webappender-visualisez-les-logs-logback-dans-son-navigateur/">webappender : pour visualiser les logs logback dans son navigateur</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/18/git-pre-push-un-hook-pour-empecher-la-propagation-des-bugs/">git pre-push : un hook pour empêcher la propagation des bugs</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-integration-avec-JDBC-logback-et-jersey/">Metrics, pour mesurer efficacement les performances : intégration avec JDBC, logback et jersey</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-integration-avec-spring-et-guice/">Metrics, pour mesurer efficacement les performances : intégration avec spring et guice</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/11/metrics-pour-mesurer-efficacement-les-performances-integration-avec-jee/">Metrics pour mesurer efficacement les performances : intégration avec JEE</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/clescot">@clescot</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'clescot',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("clescot", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/clescot" class="twitter-follow-button" data-show-count="false">Follow @clescot</a>
  
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Charles Lescot -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>
<p>
  <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Licence Creative Commons" src="http://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />Ce(tte) œuvre est mise à disposition selon les termes de la <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Licence Creative Commons Attribution -  Partage dans les Mêmes Conditions 4.0 International</a>.<br />Les autorisations au-delà du champ de cette licence peuvent être obtenues à <a xmlns:cc="http://creativecommons.org/ns#" href="http://www.clescot.com" rel="cc:morePermissions">http://www.clescot.com</a>.
</p>




</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'clescot';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>

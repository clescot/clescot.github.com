<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Déploiement D&#39;un Cluster Docker Swarm Mode via Terraform Sur Scaleway 3/3 : Déployer Le Cluster | Le blog de Charles Lescot.</title>
  <meta name="author" content="Charles Lescot">
  
  <meta name="description" content="Blog sur Java, le web, et les méthodes agiles.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Déploiement D&#39;un Cluster Docker Swarm Mode via Terraform Sur Scaleway 3/3 : Déployer Le Cluster"/>
  <meta property="og:site_name" content="Le blog de Charles Lescot."/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Le blog de Charles Lescot." type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Le blog de Charles Lescot.</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-04-30T10:45:00.000Z"><a href="/2017/04/30/2017-04-30-deployer-un-cluster-swarm-mode-sur-scaleway-via-terraform/">30/04/17</a></time>
      
      
  
    <h1 class="title">Déploiement D&#39;un Cluster Docker Swarm Mode via Terraform Sur Scaleway 3/3 : Déployer Le Cluster</h1>
  

    </header>
    <div class="entry">
      
        <h1 id="Contexte"><a href="#Contexte" class="headerlink" title="Contexte"></a>Contexte</h1><p>Je vous propose dans cette série d’articles, d’installer un cluster docker Swarm Mode via Terraform chez l’hébergeur Scaleway.</p>
<p>Celle-ci comprend 3 articles :</p>
<ul>
<li><a href="/2017/04/29/2017-04-28-interet-deploiement-cluster-swarm-mode-terraform/">l’intérêt de cette solution (ne contient pas d’éléments techniques)</a></li>
<li><a href="/2017/04/29/2017-04-29-generation-image-scaleway-terraform/">la génération de l’image des serveurs Scaleway à déployer</a></li>
<li><a href="/2017/04/30/2017-04-30-deployer-un-cluster-swarm-mode-sur-scaleway-via-terraform">le déploiement via Terraform du cluster Docker Swarm Mode</a></li>
</ul>
<h1 id="Deploiement-via-Terraform-du-cluster-Docker-Swarm-Mode"><a href="#Deploiement-via-Terraform-du-cluster-Docker-Swarm-Mode" class="headerlink" title="Déploiement via Terraform du cluster Docker Swarm Mode"></a>Déploiement via Terraform du cluster Docker Swarm Mode</h1><h2 id="organisation-des-fichiers-terraform"><a href="#organisation-des-fichiers-terraform" class="headerlink" title="organisation des fichiers terraform"></a>organisation des fichiers terraform</h2><p>Les fichiers <a href="https://www.terraform.io" target="_blank" rel="external">terraform</a>, (qui regroupent les ressources de l’infrastructure voulue), sont les suivants :</p>
<h3 id="terraform-tf"><a href="#terraform-tf" class="headerlink" title="terraform.tf"></a>terraform.tf</h3><p>Il s’agit du fichier de configuration principal. Il décrit l’infrastructure voulue, sous forme de ressources.<br>Ces ressources sont fournies par des <a href="https://www.terraform.io/docs/providers/index.html" target="_blank" rel="external">providers</a>, et mis en place avec l’aide de <a href="https://www.terraform.io/docs/provisioners/index.html" target="_blank" rel="external">provisioners</a> afin de déployer des fichiers sur les serveurs, ou d’exécuter des commandes (locales au poste qui lance le déploiement ou distantes sur les serveurs cibles).</p>
<p>le fichier est organisé via les sections suivantes :</p>
<ul>
<li>définition des providers (ici scaleway et cloudflare)</li>
<li>définition de la ressource “<em>manager_init</em>“, qui correspond au premier serveur scaleway servant à initialiser le cluster swarm (un noeud <em>manager</em>) :<br>Ce premier serveur initiant le cluster est nécessaire ; il génère les tokens de sécurité pour les autres noeuds ayant le rôle de <em>manager</em> ou <em>worker</em>.</li>
</ul>
<p>La récupération des tokens de sécurité Docker Swarm mode se fait via des appels distants vers le premier Manager sur le port 2375.</p>
<p>Une solution plus sûre pourrait passer plutôt par l’écriture du token sur un fichier sur le premier serveur lors de sa génération, une récupération en locale, puis un upload en scp sur les serveurs nécessitant ces tokens lors de la connexion à ceux-ci juste après leur création via des <em>provisioners</em>  Terraform.</p>
<p>Veuillez noter aussi que le cluster Docker Swarm mode écoute sur le port 2375, qui n’est pas sécurisé. Une installation plus sûre utiliserait le port 2376 couplé à une authentification cliente par certificat SSL supportée nativement par le Docker Engine. Cette configuration dépasse largement le cadre de cet article.</p>
<ul>
<li>définition des autres <em>managers</em> du cluster :<br>il est recommandé, pour avoir un cluster robuste, d’avoir au moins 3 <em>managers</em> présents. Une plus grande robustesse aurait induit la répartition des noeuds sur plusieurs centres de données (Scaleway propose un centre de données français, et un centre de données néerlandais pour l’instant).</li>
<li>définition des <em>workers</em> du cluster</li>
<li>définition de l’IP statique de référence et association au serveur d’initialisation :</li>
</ul>
<p>Cela permet que le DNS pointe toujours vers une IP valide, même si le serveur associé change.<br>À noter qu’un problème persiste ici : lorsque le serveur tombe, il n’y a pas encore de mécanisme de rétro-contrôle qui associe l’IP avec un autre serveur en vie du cluster.</p>
<ul>
<li>ajout d’un sous-domaine wildcard (*) au DNS, pointant vers l’IP statique<br>Cela permet au cluster de gérer des sous-domaines de façon autonome, via <a href="http://traefik.io" target="_blank" rel="external">traefik</a> par exemple</li>
<li>définition des groupes de sécurité, avec leur règles associées :<br>Comm indiqué précédemment,  cela n’apporte qu’une sécurité limitée, au vu du fonctionnement des groupes de sécurité de Scaleway.</li>
</ul>
<p>Voici le contenu du fichier terraform.tf : </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div></pre></td><td class="code"><pre><div class="line">provider &quot;scaleway&quot; &#123;</div><div class="line">  organization = &quot;$&#123;var.scaleway_organization&#125;&quot;</div><div class="line">  token = &quot;$&#123;var.scaleway_token&#125;&quot;</div><div class="line">  region = &quot;$&#123;var.scaleway_region&#125;&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">provider &quot;cloudflare&quot; &#123;</div><div class="line">  email = &quot;$&#123;var.cloudflare_email&#125;&quot;</div><div class="line">  token = &quot;$&#123;var.cloudflare_token&#125;&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">resource &quot;scaleway_server&quot; &quot;manager_init&quot; &#123;</div><div class="line">  count = 1</div><div class="line">  name = &quot;swarm-manager-$&#123;count.index + 1&#125;&quot;</div><div class="line">  image = &quot;$&#123;var.ubuntu_x86_64_image&#125;&quot;</div><div class="line">  type = &quot;$&#123;var.scaleway_type&#125;&quot;</div><div class="line">  dynamic_ip_required = &quot;true&quot;</div><div class="line">  security_group=&quot;$&#123;scaleway_security_group.internal.id&#125;&quot;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  provisioner &quot;remote-exec&quot; &#123;</div><div class="line">      inline = [</div><div class="line">          &quot;mkdir -p /etc/systemd/system/docker.d&quot;,</div><div class="line">        &quot;mkdir -p /etc/docker&quot;]</div><div class="line">  &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  provisioner &quot;file&quot; &#123;</div><div class="line">    source = &quot;daemon_manager.tpl&quot;</div><div class="line">    destination = &quot;/etc/docker/daemon_manager.tpl&quot;</div><div class="line">  &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  provisioner &quot;remote-exec&quot; &#123;</div><div class="line">    inline = [</div><div class="line">      &quot;sed -e &apos;s/SWARM_MANAGER_PRIVATE_IP/$&#123;self.private_ip&#125;/g&apos; /etc/docker/daemon_manager.tpl &gt; /etc/docker/daemon.json&quot;,</div><div class="line">      &quot;systemctl daemon-reload&quot;,</div><div class="line">      &quot;systemctl restart docker&quot;,</div><div class="line">      &quot;docker swarm  init --advertise-addr $&#123;self.private_ip&#125; --listen-addr $&#123;self.private_ip&#125;:2377 &quot;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">resource &quot;scaleway_server&quot; &quot;manager_join&quot; &#123;</div><div class="line">  count = 2</div><div class="line">  name = &quot;swarm-manager-$&#123;count.index + 2&#125;&quot;</div><div class="line">  image = &quot;$&#123;var.ubuntu_x86_64_image&#125;&quot;</div><div class="line">  type = &quot;$&#123;var.scaleway_type&#125;&quot;</div><div class="line">  dynamic_ip_required = &quot;true&quot;</div><div class="line">  security_group=&quot;$&#123;scaleway_security_group.internal.id&#125;&quot;</div><div class="line"></div><div class="line">  provisioner &quot;remote-exec&quot; &#123;</div><div class="line">    inline = [</div><div class="line">      &quot;mkdir -p /etc/systemd/system/docker.d&quot;,</div><div class="line">      &quot;mkdir -p /etc/docker&quot;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line"></div><div class="line"></div><div class="line">  provisioner &quot;file&quot; &#123;</div><div class="line">    source = &quot;daemon_manager.tpl&quot;</div><div class="line">    destination = &quot;/etc/docker/daemon_manager.tpl&quot;</div><div class="line">  &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  provisioner &quot;remote-exec&quot; &#123;</div><div class="line">    inline = [</div><div class="line">      &quot;sed -e &apos;s/SWARM_MANAGER_PRIVATE_IP/$&#123;self.private_ip&#125;/g&apos; /etc/docker/daemon_manager.tpl &gt; /etc/docker/daemon.json&quot;,</div><div class="line">      &quot;systemctl daemon-reload&quot;,</div><div class="line">      &quot;systemctl restart docker&quot;,</div><div class="line">      &quot;docker swarm join  $&#123;scaleway_server.manager_init.0.private_ip&#125;:2377 --token $(docker -H $&#123;scaleway_server.manager_init.0.private_ip&#125;:2375 swarm join-token -q manager)&quot;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  depends_on = [</div><div class="line">    &quot;scaleway_server.manager_init&quot;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">resource &quot;scaleway_server&quot; &quot;worker&quot; &#123;</div><div class="line">  count = 2</div><div class="line">  name = &quot;swarm-worker-$&#123;count.index + 1&#125;&quot;</div><div class="line">  #Docker</div><div class="line">  image = &quot;$&#123;var.ubuntu_x86_64_image&#125;&quot;</div><div class="line">  type = &quot;$&#123;var.scaleway_type&#125;&quot;</div><div class="line">  dynamic_ip_required = &quot;true&quot;</div><div class="line">  security_group=&quot;$&#123;scaleway_security_group.internal.id&#125;&quot;</div><div class="line"></div><div class="line"></div><div class="line">  provisioner &quot;remote-exec&quot; &#123;</div><div class="line">    inline = [</div><div class="line">      &quot;mkdir -p /etc/systemd/system/docker.d&quot;,</div><div class="line">      &quot;mkdir -p /etc/docker&quot;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line"></div><div class="line"></div><div class="line">  provisioner &quot;file&quot; &#123;</div><div class="line">    source = &quot;daemon_worker.json&quot;</div><div class="line">    destination = &quot;/etc/docker/daemonjson&quot;</div><div class="line">  &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  #connection to the first manager to get the cluster token</div><div class="line">  provisioner &quot;remote-exec&quot; &#123;</div><div class="line">    inline = [</div><div class="line">      &quot;systemctl daemon-reload&quot;,</div><div class="line">      &quot;systemctl restart docker&quot;,</div><div class="line">      &quot;docker swarm join  $&#123;scaleway_server.manager_init.0.private_ip&#125;:2377 --token $(docker -H $&#123;scaleway_server.manager_init.0.private_ip&#125;:2375 swarm join-token -q worker)&quot;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  depends_on = [</div><div class="line">    &quot;scaleway_server.manager_init&quot;</div><div class="line">  ]</div><div class="line"></div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">resource &quot;scaleway_ip&quot; &quot;external_ip&quot; &#123;</div><div class="line">  server = &quot;$&#123;scaleway_server.manager_init.0.id&#125;&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"># Add a record to the domain</div><div class="line">resource &quot;cloudflare_record&quot; &quot;domain&quot; &#123;</div><div class="line">  domain = &quot;$&#123;var.cloudflare_domain&#125;&quot;</div><div class="line">  name = &quot;*&quot;</div><div class="line">  value = &quot;$&#123;scaleway_ip.external_ip.ip&#125;&quot;</div><div class="line">  type = &quot;A&quot;</div><div class="line">  ttl = 3600</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">resource &quot;scaleway_security_group&quot; &quot;internal&quot; &#123;</div><div class="line">  name = &quot;cluster_inside&quot;</div><div class="line">  description = &quot;security group to configure access from inside the cluster&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">#accept in</div><div class="line">variable &quot;input_ports_from_cluster&quot; &#123;</div><div class="line">  #TCP port 2377 for cluster management communications</div><div class="line">  #TCP and UDP port 7946 for communication among nodes</div><div class="line">  #TCP and UDP port 4789 for overlay network traffic</div><div class="line"></div><div class="line">  type = &quot;list&quot;</div><div class="line">  default = [2377,4789,7946]</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">resource &quot;scaleway_security_group_rule&quot; &quot;internal_in_accept_2375&quot; &#123;</div><div class="line">  security_group = &quot;$&#123;scaleway_security_group.internal.id&#125;&quot;</div><div class="line">  action = &quot;accept&quot;</div><div class="line">  direction = &quot;inbound&quot;</div><div class="line">  ip_range = &quot;10.0.0.0/8&quot;</div><div class="line">  protocol = &quot;TCP&quot;</div><div class="line">  port = &quot;2375&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">resource &quot;scaleway_security_group_rule&quot; &quot;internal_in_accept_2376&quot; &#123;</div><div class="line">  security_group = &quot;$&#123;scaleway_security_group.internal.id&#125;&quot;</div><div class="line">  action = &quot;accept&quot;</div><div class="line">  direction = &quot;inbound&quot;</div><div class="line">  ip_range = &quot;10.0.0.0/8&quot;</div><div class="line">  protocol = &quot;TCP&quot;</div><div class="line">  port = &quot;2376&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">#TCP port 2377 for cluster management communications</div><div class="line">resource &quot;scaleway_security_group_rule&quot; &quot;internal_in_accept_2377&quot; &#123;</div><div class="line">  security_group = &quot;$&#123;scaleway_security_group.internal.id&#125;&quot;</div><div class="line">  action = &quot;accept&quot;</div><div class="line">  direction = &quot;inbound&quot;</div><div class="line">  ip_range = &quot;10.0.0.0/8&quot;</div><div class="line">  protocol = &quot;TCP&quot;</div><div class="line">  port = &quot;2377&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line">#TCP and UDP port 4789 for overlay network traffic</div><div class="line">resource &quot;scaleway_security_group_rule&quot; &quot;internal_in_accept_overlay_tcp&quot; &#123;</div><div class="line">  security_group = &quot;$&#123;scaleway_security_group.internal.id&#125;&quot;</div><div class="line">  action = &quot;accept&quot;</div><div class="line">  direction = &quot;inbound&quot;</div><div class="line">  ip_range = &quot;10.0.0.0/8&quot;</div><div class="line">  protocol = &quot;TCP&quot;</div><div class="line">  port = &quot;4789&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">#TCP and UDP port 4789 for overlay network traffic</div><div class="line">resource &quot;scaleway_security_group_rule&quot; &quot;internal_in_accept_overlay_udp&quot; &#123;</div><div class="line">  security_group = &quot;$&#123;scaleway_security_group.internal.id&#125;&quot;</div><div class="line">  action = &quot;accept&quot;</div><div class="line">  direction = &quot;inbound&quot;</div><div class="line">  ip_range = &quot;10.0.0.0/8&quot;</div><div class="line">  protocol = &quot;UDP&quot;</div><div class="line">  port = &quot;4789&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">#TCP and UDP port 7946 for communication among nodes</div><div class="line">resource &quot;scaleway_security_group_rule&quot; &quot;internal_in_accept_inter_nodes_tcp&quot; &#123;</div><div class="line">  security_group = &quot;$&#123;scaleway_security_group.internal.id&#125;&quot;</div><div class="line">  action = &quot;accept&quot;</div><div class="line">  direction = &quot;inbound&quot;</div><div class="line">  ip_range = &quot;10.0.0.0/8&quot;</div><div class="line">  protocol = &quot;TCP&quot;</div><div class="line">  port = &quot;7946&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">resource &quot;scaleway_security_group_rule&quot; &quot;internal_in_accept_inter_nodes_udp&quot; &#123;</div><div class="line">  security_group = &quot;$&#123;scaleway_security_group.internal.id&#125;&quot;</div><div class="line">  action = &quot;accept&quot;</div><div class="line">  direction = &quot;inbound&quot;</div><div class="line">  ip_range = &quot;10.0.0.0/8&quot;</div><div class="line">  protocol = &quot;UDP&quot;</div><div class="line">  port = &quot;7946&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">#If you are planning on creating an overlay network with encryption (--opt encrypted),</div><div class="line">#you will also need to ensure protocol 50 (ESP) is open.</div><div class="line">resource &quot;scaleway_security_group_rule&quot; &quot;internal_in_accept_esp_encryption&quot; &#123;</div><div class="line">  security_group = &quot;$&#123;scaleway_security_group.internal.id&#125;&quot;</div><div class="line">  action = &quot;accept&quot;</div><div class="line">  direction = &quot;inbound&quot;</div><div class="line">  ip_range = &quot;10.0.0.0/8&quot;</div><div class="line">  protocol = &quot;TCP&quot;</div><div class="line">  port = &quot;50&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">resource &quot;scaleway_security_group&quot; &quot;external&quot; &#123;</div><div class="line">  name = &quot;cluster_outside&quot;</div><div class="line">  description = &quot;security group to configure access from outside the cluster&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line">variable &quot;input_ports_from_external&quot; &#123;</div><div class="line">  #If you are planning on creating an overlay network with encryption (--opt encrypted),</div><div class="line">  #you will also need to ensure protocol 50 (ESP) is open.</div><div class="line">  type = &quot;list&quot;</div><div class="line">  default = [80,443,22]</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">resource &quot;scaleway_security_group_rule&quot; &quot;external_in_accept&quot; &#123;</div><div class="line">  security_group = &quot;$&#123;scaleway_security_group.external.id&#125;&quot;</div><div class="line"></div><div class="line">  action = &quot;accept&quot;</div><div class="line">  direction = &quot;inbound&quot;</div><div class="line">  ip_range = &quot;0.0.0.0/0&quot;</div><div class="line">  protocol = &quot;TCP&quot;</div><div class="line">  port = &quot;$&#123;element(var.input_ports_from_external, count.index)&#125;&quot;</div><div class="line">  count = &quot;$&#123;length(var.input_ports_from_external)&#125;&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">#drop in</div><div class="line">resource &quot;scaleway_security_group_rule&quot; &quot;any_in_drop&quot; &#123;</div><div class="line">  security_group = &quot;$&#123;scaleway_security_group.external.id&#125;&quot;</div><div class="line"></div><div class="line">  action = &quot;drop&quot;</div><div class="line">  direction = &quot;inbound&quot;</div><div class="line">  ip_range = &quot;0.0.0.0/0&quot;</div><div class="line">  protocol = &quot;TCP&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="daemon-manager-tpl"><a href="#daemon-manager-tpl" class="headerlink" title="daemon_manager.tpl"></a>daemon_manager.tpl</h3><p>Ce fichier est un template pour configurer le démon docker des noeuds <em>manager</em> du cluster. la variable <code>SWARM_MANAGER_PRIVATE_IP</code> sera remplacée au démarrage pour l’adresse IP de l’interface réseau <strong>privée</strong> du serveur.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line"><span class="attr">"experimental"</span> : <span class="literal">true</span>,</div><div class="line"><span class="attr">"storage-driver"</span> : <span class="string">"overlay2"</span>,</div><div class="line"><span class="attr">"labels"</span> : [<span class="string">"provider=scaleway"</span>],</div><div class="line"><span class="attr">"mtu"</span>: <span class="number">1500</span>,</div><div class="line"><span class="attr">"hosts"</span>: [<span class="string">"unix:///var/run/docker.sock"</span>,<span class="string">"tcp://SWARM_MANAGER_PRIVATE_IP:2375"</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="daemon-worker-json"><a href="#daemon-worker-json" class="headerlink" title="daemon_worker.json"></a>daemon_worker.json</h3><p>Ce fichier permet de configurer le démon des noeuds <em>worker</em> du cluster Docker Swarm mode. Il ne contient pas l’adresse IP<br> de l’interface réseau privée du serveur, car les noeuds <em>worker</em> ne peuvent piloter le cluster (sauf si on les transforme en manager).</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line"><span class="attr">"experimental"</span> : <span class="literal">true</span>,</div><div class="line"><span class="attr">"storage-driver"</span> : <span class="string">"overlay2"</span>,</div><div class="line"><span class="attr">"labels"</span> : [<span class="string">"provider=scaleway"</span>],</div><div class="line"><span class="attr">"mtu"</span>: <span class="number">1500</span>,</div><div class="line"><span class="attr">"hosts"</span>: [<span class="string">"unix:///var/run/docker.sock"</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="variables-tf"><a href="#variables-tf" class="headerlink" title="variables.tf"></a>variables.tf</h3><p>Le fichier <code>terraform.tf</code>, fait référence à des variables. Celles-ci sont décrites dans le fichier <code>variables.tf</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">variable &quot;scaleway_organization&quot; &#123;</div><div class="line">  description = &quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;</div><div class="line">&#125;</div><div class="line">variable &quot;scaleway_token&quot; &#123;</div><div class="line">  description = &quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;</div><div class="line">&#125;</div><div class="line">variable &quot;scaleway_region&quot; &#123;</div><div class="line">  description = &quot;scaleway datacenter &apos;par1&apos; for paris(France) or &apos;ams1&apos; fr Amsterdam (Nederlands)&quot;</div><div class="line">  default=&quot;par1&quot;</div><div class="line">&#125;</div><div class="line">variable &quot;scaleway_type&quot; &#123;</div><div class="line">  description = &quot;type of server&quot;</div><div class="line">  default=&quot;C2S&quot;</div><div class="line">&#125;</div><div class="line">variable &quot;cloudflare_email&quot; &#123;</div><div class="line">  description = &quot;your email scaleway account identifier&quot;</div><div class="line">&#125;</div><div class="line">variable &quot;cloudflare_token&quot; &#123;</div><div class="line">  description = &quot;&quot;</div><div class="line">&#125;</div><div class="line">variable &quot;cloudflare_domain&quot; &#123;</div><div class="line">  description = &quot;your DNS domain managed by cloudflare&quot;</div><div class="line">&#125;</div><div class="line">variable &quot;ubuntu_x86_64_image&quot; &#123;</div><div class="line">  description = &quot;your custom image ID&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="terraform-tfvars"><a href="#terraform-tfvars" class="headerlink" title="terraform.tfvars"></a>terraform.tfvars</h3><p>Ce fichier contient les valeurs des variables référencées dans le fichier <code>terraform.tf</code>, et définies dans le fichier <code>variables.tf</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">scaleway_organization = &quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;</div><div class="line">scaleway_token = &quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;</div><div class="line">scaleway_region = &quot;par1&quot;</div><div class="line">scaleway_type = &quot;C2S&quot;</div><div class="line">cloudflare_email = &quot;myname@email.com&quot;</div><div class="line">cloudflare_token = &quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</div><div class="line">cloudflare_domain = &quot;mondomaine.com&quot;</div><div class="line">ubuntu_x86_64_image = &quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;</div></pre></td></tr></table></figure>
<h3 id="terraform-tfstate"><a href="#terraform-tfstate" class="headerlink" title="terraform.tfstate"></a>terraform.tfstate</h3><p>Ce fichier est généré par Terraform, et contient l’état de l’infrastructure après application des changements.</p>
<h3 id="declenchement-de-Terraform"><a href="#declenchement-de-Terraform" class="headerlink" title="déclenchement de Terraform"></a>déclenchement de Terraform</h3><ul>
<li>créer un plan d’exécution</li>
</ul>
<p>l’exécution de la commande <code>terraform plan</code>, permet d’inspecter l’infrastructure actuelle, et l’infrastructure cible,<br>afin de générer un plan d’exécution des changements nécessaires.</p>
<ul>
<li>créer l’infrastructure</li>
</ul>
<p>Cette création se fait via la commande :<br><code>terraform apply</code></p>
<ul>
<li>détruire l’infrastructure</li>
</ul>
<p>La destruction se fait via la commande <code>terraform destroy</code> (après confirmation via l’invite de commandes).</p>
<h1 id="resultat"><a href="#resultat" class="headerlink" title="résultat"></a>résultat</h1><p>Après avoir crée via <code>terraform apply</code>, votre infrastructure (et patienté quelques minutes), en se connectant sur un des noeuds ayant le rôle de manager, vous pouvez lancer la commande suivante :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">root@swarm-manager-1:~# docker node ls</div><div class="line">ID                           HOSTNAME         STATUS  AVAILABILITY  MANAGER STATUS</div><div class="line">b37dxtsbn573m4xhas0j7b4do *  swarm-manager-1  Ready   Active        Leader</div><div class="line">cvv0iyfy7tybsev0k55iyif4i    swarm-manager-2  Ready   Active        Reachable</div><div class="line">llrhva62q0byzhruu6lu29gyx    swarm-worker-2   Ready   Active        </div><div class="line">p4mcus11v15can4ut0lqajfqd    swarm-worker-1   Ready   Active        </div><div class="line">pi2wxsmibs64y9d4xwnuxvew8    swarm-manager-3  Ready   Active        Reachable</div></pre></td></tr></table></figure>
<p>Vous pouvez donc constater la bonne mise en place de votre cluster Docker Swarm Mode.</p>
<h1 id="conclusion"><a href="#conclusion" class="headerlink" title="conclusion"></a>conclusion</h1><p>Cet article vous permet de vous familiariser avec Terraform, un outil de plus en plus présent pour automatiser la création de vos infrastructures immutables via du code.<br>Il vous permet aussi de vous essayer à la création d’un cluster Docker Swarm Mode.<br>J’attire néanmoins votre attention sur la non-sécurisation de l’image et du réseau mis en place.</p>
<p>Une mise en production d’un environnement de ce type, demanderait au préalable, d’autres opérations de sécurisation qui sortent du cadre de cet article.</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/docker/">docker</a>, <a href="/categories/docker/docker/">docker</a>, <a href="/categories/docker/docker/swarm-mode/">swarm mode</a>, <a href="/categories/docker/docker/swarm-mode/scaleway/">scaleway</a>, <a href="/categories/docker/docker/swarm-mode/scaleway/terraform/">terraform</a>, <a href="/categories/docker/docker/swarm-mode/scaleway/terraform/devops/">devops</a>, <a href="/categories/docker/docker/swarm-mode/scaleway/terraform/devops/ubuntu/">ubuntu</a>
  </div>

        
        
  <div class="addthis addthis_toolbox addthis_default_style">
    
    
      <a class="addthis_button_tweet"></a>
    
    
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">Commentaires</h1>

  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Recherche">
    <input type="hidden" name="q" value="site:clescot.com">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">Catégories</h3>
  <ul class="entry">
  
    <li><a href="/categories/performance/mesure/metrique/JDBC/">JDBC</a><small>1</small></li>
  
    <li><a href="/categories/performance/mesure/metrique/JEE/">JEE</a><small>1</small></li>
  
    <li><a href="/categories/debug/jsp/variables/communication/JSON/">JSON</a><small>1</small></li>
  
    <li><a href="/categories/git/productivite/hook/push/integration-continue/TDD/">TDD</a><small>1</small></li>
  
    <li><a href="/categories/kafkacat/kafka/big-data/">big data</a><small>1</small></li>
  
    <li><a href="/categories/kafkacat/kafka/big-data/cli/">cli</a><small>1</small></li>
  
    <li><a href="/categories/debug/jsp/variables/communication/">communication</a><small>1</small></li>
  
    <li><a href="/categories/logback/web/logs/debug/communication/">communication</a><small>2</small></li>
  
    <li><a href="/categories/tempus-fugit/junit/java/tdd/test/parallele/multithread/testng/concurrence/">concurrence</a><small>1</small></li>
  
    <li><a href="/categories/debug/">debug</a><small>1</small></li>
  
    <li><a href="/categories/logback/web/logs/debug/">debug</a><small>2</small></li>
  
    <li><a href="/categories/docker/docker/swarm-mode/scaleway/terraform/devops/">devops</a><small>3</small></li>
  
    <li><a href="/categories/docker/docker/">docker</a><small>3</small></li>
  
    <li><a href="/categories/docker/">docker</a><small>3</small></li>
  
    <li><a href="/categories/git/">git</a><small>1</small></li>
  
    <li><a href="/categories/performance/mesure/metrique/spring/guice/">guice</a><small>1</small></li>
  
    <li><a href="/categories/git/productivite/hook/">hook</a><small>1</small></li>
  
    <li><a href="/categories/git/productivite/hook/push/integration-continue/">intégration continue</a><small>1</small></li>
  
    <li><a href="/categories/tempus-fugit/junit/java/">java</a><small>1</small></li>
  
    <li><a href="/categories/debug/jsp/variables/communication/JSON/web/java/">java</a><small>1</small></li>
  
    <li><a href="/categories/junit/java/">java</a><small>1</small></li>
  
    <li><a href="/categories/performance/mesure/metrique/JDBC/logback/jersey/">jersey</a><small>1</small></li>
  
    <li><a href="/categories/debug/jsp/">jsp</a><small>1</small></li>
  
    <li><a href="/categories/junit/">junit</a><small>1</small></li>
  
    <li><a href="/categories/tempus-fugit/junit/">junit</a><small>1</small></li>
  
    <li><a href="/categories/kafkacat/kafka/">kafka</a><small>1</small></li>
  
    <li><a href="/categories/kafkacat/">kafkacat</a><small>1</small></li>
  
    <li><a href="/categories/logback/">logback</a><small>2</small></li>
  
    <li><a href="/categories/performance/mesure/metrique/JDBC/logback/">logback</a><small>1</small></li>
  
    <li><a href="/categories/logback/web/logs/">logs</a><small>2</small></li>
  
    <li><a href="/categories/performance/mesure/">mesure</a><small>4</small></li>
  
    <li><a href="/categories/tempus-fugit/junit/java/tdd/test/parallele/multithread/">multithread</a><small>1</small></li>
  
    <li><a href="/categories/performance/mesure/metrique/">métrique</a><small>4</small></li>
  
    <li><a href="/categories/junit/java/tdd/organisation/">organisation</a><small>1</small></li>
  
    <li><a href="/categories/kafkacat/kafka/big-data/cli/outil/">outil</a><small>1</small></li>
  
    <li><a href="/categories/tempus-fugit/junit/java/tdd/test/parallele/">parallèle</a><small>1</small></li>
  
    <li><a href="/categories/performance/">performance</a><small>4</small></li>
  
    <li><a href="/categories/git/productivite/">productivité</a><small>1</small></li>
  
    <li><a href="/categories/git/productivite/hook/push/">push</a><small>1</small></li>
  
    <li><a href="/categories/docker/docker/swarm-mode/scaleway/">scaleway</a><small>3</small></li>
  
    <li><a href="/categories/performance/mesure/metrique/spring/">spring</a><small>1</small></li>
  
    <li><a href="/categories/docker/docker/swarm-mode/">swarm mode</a><small>3</small></li>
  
    <li><a href="/categories/debug/jsp/variables/communication/JSON/web/java/tag/">tag</a><small>1</small></li>
  
    <li><a href="/categories/junit/java/tdd/">tdd</a><small>1</small></li>
  
    <li><a href="/categories/tempus-fugit/junit/java/tdd/">tdd</a><small>1</small></li>
  
    <li><a href="/categories/tempus-fugit/">tempus-fugit</a><small>1</small></li>
  
    <li><a href="/categories/docker/docker/swarm-mode/scaleway/terraform/">terraform</a><small>3</small></li>
  
    <li><a href="/categories/tempus-fugit/junit/java/tdd/test/">test</a><small>1</small></li>
  
    <li><a href="/categories/junit/java/tdd/organisation/test/">test</a><small>1</small></li>
  
    <li><a href="/categories/tempus-fugit/junit/java/tdd/test/parallele/multithread/testng/">testng</a><small>1</small></li>
  
    <li><a href="/categories/tempus-fugit/junit/java/tdd/test/parallele/multithread/testng/concurrence/thread-safe/testrule/">testrule</a><small>1</small></li>
  
    <li><a href="/categories/git/productivite/hook/push/integration-continue/TDD/tests/">tests</a><small>1</small></li>
  
    <li><a href="/categories/tempus-fugit/junit/java/tdd/test/parallele/multithread/testng/concurrence/thread-safe/">thread-safe</a><small>1</small></li>
  
    <li><a href="/categories/docker/docker/swarm-mode/scaleway/terraform/devops/ubuntu/">ubuntu</a><small>3</small></li>
  
    <li><a href="/categories/debug/jsp/variables/">variables</a><small>1</small></li>
  
    <li><a href="/categories/debug/jsp/variables/communication/JSON/web/">web</a><small>1</small></li>
  
    <li><a href="/categories/logback/web/">web</a><small>2</small></li>
  
  </ul>
</div>


  
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2017 Charles Lescot
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>
